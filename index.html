<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Condiciones Inseguras - Danec</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        /* ===== ESTILOS BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #dc2c3c;    /* Rojo Danec */
            --secondary: #2c3e50;  /* Gris oscuro */
            --accent: #f39c12;     /* Naranja */
            --danger: #e74c3c;     /* Rojo más claro */
            --warning: #f1c40f;    /* Amarillo */
            --safe: #27ae60;       /* Verde */
            --light: #f5f5f5;      /* Gris claro */
            --dark: #2c3e50;       /* Gris oscuro */
            --supabase: #3ecf8e;   /* Verde Supabase */
            --fisico: #9b59b6;     /* Púrpura para tipo Físico */
            --dark-red: #b71540;   /* Rojo oscuro para altos riesgos */
            --light-red: #ff6b6b;  /* Rojo claro */
            --blue: #3498db;       /* Azul para OT */
        }

        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER ===== */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark-red) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(220, 44, 60, 0.2);
            border-bottom: 4px solid var(--accent);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 28px;
            color: white;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .logo span {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 300;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.08);
            border-left: 4px solid var(--primary);
        }

        .main-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ===== COMPONENTES ===== */
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 3px solid var(--light);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(220, 44, 60, 0.1);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(220, 44, 60, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .card h2 i {
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group label.required::after {
            content: " *";
            color: var(--primary);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(220, 44, 60, 0.1);
            background-color: white;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #c22534;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 44, 60, 0.3);
        }

        .btn-success {
            background-color: var(--safe);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: #333;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-info {
            background-color: var(--blue);
            color: white;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pendiente {
            background-color: rgba(220, 44, 60, 0.15);
            color: var(--primary);
            border: 1px solid rgba(220, 44, 60, 0.3);
        }

        .status-reparado {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--safe);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .status-en-proceso {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--blue);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        /* ===== TIEMPO DE REPARACIÓN ===== */
        .tiempo-reparacion {
            font-weight: 700;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .tiempo-rapido {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--safe);
        }

        .tiempo-medio {
            background-color: rgba(241, 196, 15, 0.15);
            color: #d35400;
        }

        .tiempo-lento {
            background-color: rgba(220, 44, 60, 0.15);
            color: var(--primary);
        }

        /* ===== TIPO FÍSICO ===== */
        .tipo-fisico {
            background-color: rgba(155, 89, 182, 0.15);
            color: #9b59b6;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        /* ===== CÓDIGO OT ===== */
        .ot-code {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--blue);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 14px;
            border-left: 3px solid var(--blue);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* ===== FECHA ARREGLO ===== */
        .fecha-arreglo {
            background-color: rgba(243, 156, 18, 0.15);
            color: #e67e22;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* ===== NAVEGACIÓN ===== */
        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 8px;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 8px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
            background-color: #f9f9f9;
        }

        .nav-menu a:hover, .nav-menu a.active {
            background-color: rgba(220, 44, 60, 0.1);
            color: var(--primary);
            transform: translateX(5px);
            border-left: 3px solid var(--primary);
        }

        .nav-menu a i {
            width: 20px;
            text-align: center;
        }

        /* ===== ESTADÍSTICAS ===== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.05);
            text-align: center;
            transition: transform 0.3s;
            border-top: 4px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(220, 44, 60, 0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            margin: 10px 0;
            color: var(--primary);
        }

        .stat-title {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* ===== EVOLUCIÓN SEPARADA ===== */
        .evolution-section {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.05);
            border-top: 4px solid var(--blue);
        }

        .evolution-container {
            position: relative;
            height: 350px;
            width: 100%;
            margin-top: 15px;
        }

        /* ===== TABLAS CON FOTOS ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background-color: var(--primary);
            color: white;
            text-align: left;
            padding: 14px 16px;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        table th:last-child {
            border-right: none;
        }

        table td {
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        table tr:hover {
            background-color: rgba(220, 44, 60, 0.03);
        }

        table tr:last-child td {
            border-bottom: none;
        }

        /* ===== GRÁFICOS ===== */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            margin-top: 20px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.05);
            min-height: 350px;
            display: flex;
            flex-direction: column;
            border-top: 4px solid var(--accent);
        }

        .chart-item h3 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary);
            font-weight: 600;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
        }

        /* ===== FOTOS EN TABLA ===== */
        .photo-cell {
            text-align: center;
        }

        .table-photo {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #eee;
            transition: all 0.3s;
        }

        .table-photo:hover {
            transform: scale(1.1);
            border-color: var(--primary);
            box-shadow: 0 3px 8px rgba(220, 44, 60, 0.2);
        }

        .no-photo {
            color: #95a5a6;
            font-style: italic;
            font-size: 12px;
        }

        /* ===== SUBIDA DE FOTOS ===== */
        .photo-upload-container {
            border: 2px dashed var(--primary);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9f9f9;
            margin-bottom: 15px;
        }

        .photo-upload-container:hover {
            border-color: var(--dark-red);
            background-color: rgba(220, 44, 60, 0.05);
        }

        .photo-upload-container.dragging {
            border-color: var(--safe);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .photo-preview {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .preview-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: contain;
            border: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .remove-photo-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .remove-photo-btn:hover {
            background-color: var(--dark-red);
            transform: translateY(-2px);
        }

        /* ===== MODAL DE FOTO ===== */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .photo-modal-content {
            max-width: 90%;
            max-height: 80vh;
            position: relative;
        }

        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 2px solid var(--primary);
        }

        .modal-caption {
            color: white;
            text-align: center;
            margin-top: 15px;
            font-size: 16px;
            background-color: rgba(220, 44, 60, 0.3);
            padding: 10px;
            border-radius: 5px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            background: none;
            border: none;
            z-index: 3001;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: var(--primary);
            transform: scale(1.2);
        }

        /* ===== ACCIONES ===== */
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            border: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            
            .evolution-container {
                height: 300px;
            }
            
            .chart-item {
                min-height: 300px;
            }
            
            .table-photo {
                width: 50px;
                height: 50px;
            }
            
            .preview-image {
                max-width: 250px;
                max-height: 150px;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 14px;
            }
        }

        @media (max-width: 576px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .table-photo {
                width: 40px;
                height: 40px;
            }
            
            .preview-image {
                max-width: 200px;
                max-height: 120px;
            }
            
            .card {
                padding: 20px;
            }
            
            .nav-menu a {
                padding: 12px 15px;
                font-size: 14px;
            }
        }

        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== STATUS INDICATOR ===== */
        .status-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .status-connected {
            background: var(--safe);
            color: white;
        }

        .status-disconnected {
            background: var(--warning);
            color: #333;
        }

        .status-error {
            background: var(--danger);
            color: white;
        }

        /* ===== FECHAS ===== */
        .date-input-group {
            display: flex;
            gap: 10px;
        }

        .date-input-group .form-control {
            flex: 1;
        }

        .date-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .date-pendiente {
            background-color: rgba(220, 44, 60, 0.1);
            color: var(--primary);
        }

        .date-cumplida {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--safe);
        }

        .date-atrasada {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        /* ===== ALERTAS ===== */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .alert-warning {
            background-color: rgba(241, 196, 15, 0.1);
            border-left: 4px solid var(--warning);
            color: #d35400;
        }

        .alert-success {
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--safe);
            color: var(--safe);
        }

        /* ===== BADGE DE RIESGO ===== */
        .risk-badge {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        .risk-critico {
            background-color: rgba(220, 44, 60, 0.2);
            color: var(--primary);
            border: 1px solid rgba(220, 44, 60, 0.3);
        }

        .risk-alto {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .risk-medio {
            background-color: rgba(241, 196, 15, 0.2);
            color: #d35400;
            border: 1px solid rgba(241, 196, 15, 0.3);
        }

        .risk-bajo {
            background-color: rgba(39, 174, 96, 0.2);
            color: var(--safe);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loading-text">Conectando con la base de datos...</p>
    </div>

    <!-- Status Indicator -->
    <div id="status-indicator" class="status-indicator status-disconnected">
        <i class="fas fa-database"></i>
        <span>Desconectado</span>
    </div>

    <!-- Modal para ver fotos -->
    <div id="photoModal" class="photo-modal">
        <button class="close-modal" onclick="cerrarModalFoto()">&times;</button>
        <div class="photo-modal-content">
            <img id="modalPhoto" class="modal-image" src="" alt="Foto ampliada">
            <p id="modalCaption" class="modal-caption"></p>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-hard-hat"></i>
                    <div>
                        <h1>Sistema de Condiciones Inseguras</h1>
                        <span>Danec S.A. - Seguridad Industrial</span>
                    </div>
                </div>
                <div class="user-info">
                    <i class="fas fa-database"></i>
                    <span id="db-status">Supabase</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <nav>
                    <ul class="nav-menu">
                        <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="#" data-page="registro"><i class="fas fa-plus-circle"></i> Nuevo Reporte</a></li>
                        <li><a href="#" data-page="historial"><i class="fas fa-history"></i> Historial</a></li>
                        <li><a href="#" data-page="analisis"><i class="fas fa-chart-bar"></i> Análisis</a></li>
                        <li><a href="#" data-page="config"><i class="fas fa-cog"></i> Configuración</a></li>
                    </ul>
                </nav>

                <!-- Supabase Config Panel -->
                <div id="supabase-config-panel" class="card" style="display: none; margin-top: 20px;">
                    <h3><i class="fas fa-database"></i> Configurar Supabase</h3>
                    <div class="form-group">
                        <label for="supabase-url" class="required">URL de Supabase:</label>
                        <input type="text" id="supabase-url" class="form-control" 
                               placeholder="https://abc123.supabase.co" required>
                        <small style="color: #7f8c8d; font-size: 12px;">Obtén esto desde el dashboard de Supabase</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="supabase-key" class="required">API Key (anon public):</label>
                        <input type="text" id="supabase-key" class="form-control" 
                               placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." required>
                        <small style="color: #7f8c8d; font-size: 12px;">Clave pública anónima desde Settings > API</small>
                    </div>
                    
                    <button class="btn btn-success" onclick="guardarConfigSupabase()">
                        <i class="fas fa-plug"></i> Conectar a Supabase
                    </button>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3><i class="fas fa-info-circle"></i> Información</h3>
                    <p style="margin-top: 10px; font-size: 14px;">
                        Sistema para reportar y gestionar condiciones inseguras en Danec S.A.
                    </p>
                    <div style="margin-top: 15px; padding: 15px; background-color: rgba(220, 44, 60, 0.05); border-radius: 6px;">
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-tag" style="color: var(--blue);"></i> <strong>Nuevo:</strong> Código OT para identificación
                        </p>
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-calendar-alt" style="color: var(--accent);"></i> <strong>Nuevo:</strong> Fecha estimada de reparación
                        </p>
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-clock" style="color: var(--safe);"></i> <strong>Nuevo:</strong> Cálculo de tiempo de reparación
                        </p>
                    </div>
                </div>
            </aside>

            <!-- Main Panel -->
            <main class="main-panel">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-title">Total Reportes</div>
                            <div class="stat-value" id="total-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Pendientes</div>
                            <div class="stat-value" id="pending-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">En Proceso</div>
                            <div class="stat-value" id="process-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Reparados</div>
                            <div class="stat-value" id="repaired-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Tiempo Promedio</div>
                            <div class="stat-value" id="avg-time">0h</div>
                        </div>
                    </div>

                    <!-- Sección de Evolución Separada -->
                    <div class="evolution-section">
                        <h2><i class="fas fa-chart-line"></i> Evolución Temporal</h2>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">Reportes por mes en los últimos 6 meses</p>
                        <div class="evolution-container">
                            <canvas id="evolution-chart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2><i class="fas fa-history"></i> Últimas Actividades</h2>
                            <button onclick="forzarActualizacion()" class="btn btn-primary" style="padding: 8px 15px;">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="recent-table">
                                <thead>
                                    <tr>
                                        <th>OT</th>
                                        <th>Descripción</th>
                                        <th>Sector</th>
                                        <th>Tipo</th>
                                        <th>Fecha Est.</th>
                                        <th>Tiempo Rep.</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Registro Page -->
                <div id="registro-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-plus-circle"></i> Nuevo Reporte</h2>
                        <form id="report-form">
                            <!-- SECCIÓN 1: DATOS BÁSICOS -->
                            <div style="background-color: rgba(220, 44, 60, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--primary); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-id-card"></i> Datos de Identificación
                                </h3>
                                
                                <div class="form-group">
    <label for="ot-code" class="required">Código OT *</label>
    <input type="text" class="form-control" id="ot-code" 
           placeholder="Ej: 00001, 12345 (5 dígitos)" 
           required
           pattern="^\d{5}$"
           title="Ingrese un código OT de 5 dígitos numéricos"
           maxlength="5">
    <small style="color: #7f8c8d; font-size: 12px;">Código único de 5 dígitos (ej: 00001)</small>
</div>
                                
                                <div class="form-group">
                                    <label for="reporter-name" class="required">Reportado por *</label>
                                    <input type="text" class="form-control" id="reporter-name" 
                                           placeholder="Nombre completo" required>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN 2: DESCRIPCIÓN -->
                            <div style="background-color: rgba(52, 152, 219, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--blue); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-file-alt"></i> Descripción del Problema
                                </h3>
                                
                                <div class="form-group">
                                    <label for="description" class="required">Descripción *</label>
                                    <textarea class="form-control" id="description" rows="4" 
                                              placeholder="Describa detalladamente la condición insegura..." required></textarea>
                                </div>
                                
                                <!-- SUBIDA DE FOTO MEJORADA -->
                                <div class="form-group">
                                    <label for="photo-upload">Foto de la condición (opcional):</label>
                                    <div class="photo-upload-container" id="photo-drop-area">
                                        <i class="fas fa-camera" style="font-size: 48px; color: var(--primary); margin-bottom: 10px;"></i>
                                        <p><strong>Haz clic o arrastra una foto aquí</strong></p>
                                        <p style="font-size: 12px; color: #7f8c8d;">Máximo 1 foto • Formatos: JPG, PNG • Máximo 5MB</p>
                                        <input type="file" id="photo-input" accept="image/*" 
                                               style="display: none;" onchange="handlePhotoUpload(this.files[0])">
                                    </div>
                                    <div id="photo-preview"></div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN 3: UBICACIÓN Y RIESGO -->
                            <div style="background-color: rgba(39, 174, 96, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--safe); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-map-marker-alt"></i> Ubicación y Clasificación
                                </h3>
                                
                               <div class="form-group">
                                <label for="sector" class="required">Sector/Área *</label>
                                <select class="form-control" id="sector" required>
                                <option value="">Seleccione</option>
                                    <option value="Aceites">Aceites</option>
                                    <option value="Jabonería-Confitería">Jabonería-Confitería</option>
                                        </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="ubicacion" class="required">Ubicación específica *</label>
                                    <input type="text" class="form-control" id="ubicacion" 
                                           placeholder="Ej: Zona 1 - Línea 3, Estación 5" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="category" class="required">Tipo de riesgo *</label>
                                    <select class="form-control" id="category" required>
                                        <option value="">Seleccione</option>
                                        <option value="Físico">Físico</option>
                                        <option value="Estructural">Estructural</option>
                                        <option value="Eléctrico">Eléctrico</option>
                                        <option value="Ambiental">Ambiental</option>
                                        <option value="Operacional">Operacional</option>
                                        <option value="Químico">Químico</option>
                                        <option value="Mecánico">Mecánico</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="risk-level" class="required">Nivel de Riesgo *</label>
                                    <select class="form-control" id="risk-level" required>
                                        <option value="">Seleccione</option>
                                        <option value="Bajo">Bajo</option>
                                        <option value="Medio">Medio</option>
                                        <option value="Alto">Alto</option>
                                        <option value="Crítico">Crítico</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN 4: PLANIFICACIÓN -->
                            <div style="background-color: rgba(243, 156, 18, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--accent); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-calendar-alt"></i> Planificación y Observaciones
                                </h3>
                                
                                <div class="form-group">
                                    <label for="fecha-estimada" class="required">Fecha estimada de reparación *</label>
                                    <input type="date" class="form-control" id="fecha-estimada" required>
                                    <small style="color: #7f8c8d; font-size: 12px;">Fecha límite para resolver la condición</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="observaciones">Observaciones adicionales</label>
                                    <textarea class="form-control" id="observaciones" rows="2" 
                                              placeholder="Información adicional, recomendaciones, prioridad..."></textarea>
                                </div>
                            </div>
                            
                            <!-- BOTONES DE ACCIÓN -->
                            <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; flex-wrap: wrap;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Guardar Reporte
                                </button>
                                <button type="reset" class="btn" style="background-color: #95a5a6; color: white;" onclick="resetPhoto()">
                                    <i class="fas fa-undo"></i> Limpiar Formulario
                                </button>
                                <button type="button" class="btn btn-warning" onclick="mostrarEjemplo()">
                                    <i class="fas fa-eye"></i> Ver Ejemplo
                                </button>
                                <button type="button" class="btn btn-info" onclick="generarCodigoOT()">
                                    <i class="fas fa-bolt"></i> Generar OT
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Historial Page -->
                <div id="historial-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-history"></i> Historial de Reportes</h2>
                        
                        <!-- Filtros y Búsqueda -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn" id="filter-all">Todos</button>
                                <button class="btn btn-primary" id="filter-pending">Pendientes</button>
                                <button class="btn btn-info" id="filter-process">En Proceso</button>
                                <button class="btn btn-success" id="filter-repaired">Reparados</button>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select class="form-control" id="filter-sector" style="width: 150px;">
                                    <option value="">Todos los sectores</option>
                                    <option value="Aceites">Aceites</option>
                                    <option value="Jabonería-Confitería">Jabonería-Confitería</option>
                                </select>
                                <input type="text" class="form-control" id="search-input" placeholder="Buscar por OT, descripción..." style="width: 200px;">
                                <button class="btn btn-primary" onclick="exportarHistorial()" title="Exportar a CSV">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tabla de Historial -->
                        <div class="table-container">
                            <table id="history-table">
                                <thead>
                                    <tr>
                                        <th>OT</th>
                                        <th>Descripción</th>
                                        <th>Sector</th>
                                        <th>Tipo</th>
                                        <th>Riesgo</th>
                                        <th>Fecha Est.</th>
                                        <th>Foto</th>
                                        <th>Fecha Reporte</th>
                                        <th>Tiempo Rep.</th>
                                        <th>Reportado por</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Análisis Page -->
                <div id="analisis-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-chart-bar"></i> Análisis y Reportes</h2>
                        
                        <!-- Selector de análisis -->
                        <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <select class="form-control" id="analysis-type" style="width: 200px;">
                                <option value="risk">Por Nivel de Riesgo</option>
                                <option value="sector">Por Sector</option>
                                <option value="category">Por Tipo</option>
                                <option value="status">Por Estado</option>
                                <option value="time">Por Tiempo de Reparación</option>
                            </select>
                            <button class="btn btn-primary" onclick="actualizarAnalisis()">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                            <button class="btn btn-success" onclick="generarReportePDF()">
                                <i class="fas fa-file-pdf"></i> Generar PDF
                            </button>
                        </div>
                        
                        <!-- Gráfico principal -->
                        <div class="chart-container">
                            <canvas id="data-chart"></canvas>
                        </div>
                        
                        <!-- Gráficos secundarios -->
                        <div class="chart-row">
                            <div class="chart-item">
                                <h3><i class="fas fa-map-marker-alt"></i> Distribución por Sector</h3>
                                <div class="chart-wrapper">
                                    <canvas id="sector-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-item">
                                <h3><i class="fas fa-clock"></i> Tiempos de Reparación</h3>
                                <div class="chart-wrapper">
                                    <canvas id="time-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KPIs -->
                        <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--dark-red) 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;" id="kpi-tiempo-promedio">0h</div>
                                <div style="font-size: 12px; opacity: 0.9;">Tiempo Promedio</div>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--safe) 0%, #219653 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;" id="kpi-cumplimiento">0%</div>
                                <div style="font-size: 12px; opacity: 0.9;">Cumplimiento Fechas</div>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--accent) 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;" id="kpi-reportes-mes">0</div>
                                <div style="font-size: 12px; opacity: 0.9;">Reportes/Mes</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración Page -->
                <div id="config-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-cog"></i> Configuración del Sistema</h2>
                        
                        <!-- Conexión Supabase -->
                        <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--dark-red) 100%); color: white; margin-top: 20px;">
                            <h3><i class="fas fa-database"></i> Conexión Supabase</h3>
                            
                            <div class="form-group">
                                <label>Estado de la conexión:</label>
                                <div id="connection-status" style="padding: 12px; background: rgba(255, 255, 255, 0.15); border-radius: 6px; font-weight: 600;">
                                    <i class="fas fa-circle-notch fa-spin"></i> Verificando...
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="current-url">URL Actual:</label>
                                <input type="text" id="current-url" class="form-control" readonly style="background: rgba(255, 255, 255, 0.9);">
                            </div>
                            
                            <div class="form-group">
                                <label for="current-key">API Key:</label>
                                <input type="text" id="current-key" class="form-control" readonly style="background: rgba(255, 255, 255, 0.9);">
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="probarConexion()">
                                    <i class="fas fa-sync-alt"></i> Probar Conexión
                                </button>
                                <button class="btn btn-warning" onclick="mostrarConfigPanel()">
                                    <i class="fas fa-edit"></i> Cambiar Credenciales
                                </button>
                                <button class="btn" style="background-color: white; color: var(--primary);" onclick="abrirManualSupabase()">
                                    <i class="fas fa-book"></i> Ver Manual
                                </button>
                            </div>
                        </div>
                        
                        <!-- Información del Sistema -->
                        <div style="margin-top: 30px;">
                            <h3><i class="fas fa-info-circle"></i> Información del Sistema</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px; border-left: 4px solid var(--primary);">
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-hashtag" style="color: var(--primary);"></i> Total reportes:</strong> <span id="total-db-count">0</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-camera" style="color: var(--primary);"></i> Reportes con fotos:</strong> <span id="reports-with-photos">0</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-clock" style="color: var(--accent);"></i> Tiempo promedio reparación:</strong> <span id="avg-repair-time">0h</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-calendar-check" style="color: var(--safe);"></i> Cumplimiento fechas:</strong> <span id="cumplimiento-fechas">0%</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-sync-alt" style="color: var(--blue);"></i> Última sincronización:</strong> <span id="last-sync">Nunca</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-laptop" style="color: var(--dark);"></i> Modo:</strong> <span id="current-mode">Desconocido</span></p>
                                <p><strong><i class="fas fa-code-branch" style="color: var(--dark);"></i> Versión:</strong> Danec v5.0</p>
                            </div>
                        </div>
                        
                        <!-- Herramientas -->
                        <div style="margin-top: 30px;">
                            <h3><i class="fas fa-tools"></i> Herramientas</h3>
                            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                <button class="btn btn-danger" onclick="limpiarDatos()">
                                    <i class="fas fa-trash"></i> Limpiar Datos Locales
                                </button>
                                <button class="btn btn-warning" onclick="resetConfig()">
                                    <i class="fas fa-redo"></i> Resetear Configuración
                                </button>
                                <button class="btn btn-info" onclick="backupLocal()">
                                    <i class="fas fa-download"></i> Backup Local
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <footer style="text-align: center; margin-top: 30px; padding: 20px; color: #7f8c8d; border-top: 1px solid #eee; background-color: rgba(220, 44, 60, 0.05);">
    <p><strong>Sistema de Condiciones Inseguras Danec S.A.</strong> &copy; 2024 | Versión 5.0 | Colores corporativos: #dc2c3c</p>
    <p style="font-size: 12px; margin-top: 5px;">Sectores: Aceites y Jabonería-Confitería | Nueva función: Código OT y fechas estimadas</p>
</footer>
    </div>

    <script>
        // ==============================================
        // CONFIGURACIÓN GLOBAL
        // ==============================================
        let supabaseClient = null;
        let unsafeConditions = [];
        let currentFilter = 'all';
        let dataChart = null;
        let sectorChart = null;
        let timeChart = null;
        let evolutionChart = null;
        let selectedPhoto = null;
        
        // Configuración por defecto
        let CONFIG = {
            supabaseUrl: localStorage.getItem('supabase_url') || '',
            supabaseKey: localStorage.getItem('supabase_key') || '',
            lastSync: localStorage.getItem('last_sync') || 'Nunca',
            offlineMode: localStorage.getItem('offline_mode') === 'true' || false
        };
        
        // Colores Danec para gráficos
        const CHART_COLORS = {
            riesgo: {
                'Crítico': '#dc2c3c',
                'Alto': '#e74c3c',
                'Medio': '#f39c12',
                'Bajo': '#27ae60'
            },
            estado: {
                'pendiente': '#dc2c3c',
                'en proceso': '#3498db',
                'reparado': '#27ae60'
            },
            sector: ['#dc2c3c', '#2c3e50'],
            tipo: {
                'Físico': '#9b59b6',
                'Estructural': '#dc2c3c',
                'Eléctrico': '#f1c40f',
                'Ambiental': '#1abc9c',
                'Operacional': '#3498db',
                'Químico': '#e67e22',
                'Mecánico': '#7f8c8d'
            },
            tiempo: ['#27ae60', '#f1c40f', '#e67e22', '#dc2c3c']
        };
        
        // ==============================================
        // FUNCIONES DE UTILIDAD
        // ==============================================
        function showLoading(show, text = 'Cargando...') {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            
            if (loading) loading.style.display = show ? 'flex' : 'none';
            if (loadingText && text) loadingText.textContent = text;
        }
        
        function updateStatusIndicator(status, message) {
            const indicator = document.getElementById('status-indicator');
            if (!indicator) return;
            
            indicator.classList.remove('status-connected', 'status-disconnected', 'status-error');
            indicator.classList.add(`status-${status}`);
            
            let icon = 'fa-database';
            if (status === 'connected') icon = 'fa-check-circle';
            if (status === 'error') icon = 'fa-exclamation-triangle';
            if (status === 'disconnected') icon = 'fa-unlink';
            
            indicator.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            
            const dbStatus = document.getElementById('db-status');
            if (dbStatus) {
                dbStatus.textContent = status === 'connected' ? 'Conectado ✓' : 'Desconectado ✗';
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function obtenerTimestamp() {
            return new Date().toISOString();
        }
        
        function generarCodigoOT() {
    // Obtener el próximo número disponible
    const numerosUsados = unsafeConditions
        .filter(c => c.OT && c.OT.match(/^\d{5}$/))
        .map(c => parseInt(c.OT))
        .filter(n => !isNaN(n));
    
    let siguienteNumero = 1;
    if (numerosUsados.length > 0) {
        const maxNumero = Math.max(...numerosUsados);
        siguienteNumero = maxNumero + 1;
    }
    
    // Formatear a 5 dígitos con ceros a la izquierda
    const otCode = String(siguienteNumero).padStart(5, '0');
    document.getElementById('ot-code').value = otCode;
    
    // Mostrar feedback
    const otField = document.getElementById('ot-code');
    otField.style.borderColor = '#27ae60';
    otField.style.boxShadow = '0 0 0 3px rgba(39, 174, 96, 0.2)';
    
    setTimeout(() => {
        otField.style.borderColor = '';
        otField.style.boxShadow = '';
    }, 1500);
}
        
        function calcularTiempoReparacion(fechaInicio, fechaFin) {
            if (!fechaInicio || !fechaFin) {
                return { texto: 'No reparado', horas: 0, clase: '' };
            }
            
            try {
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                
                if (isNaN(inicio.getTime()) || isNaN(fin.getTime())) {
                    return { texto: 'Fechas inválidas', horas: 0, clase: '' };
                }
                
                const diffMs = fin - inicio;
                
                if (diffMs < 0) {
                    return { texto: 'Fecha reparación anterior al reporte', horas: 0, clase: '' };
                }
                
                const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                let texto = '';
                if (dias > 0) {
                    texto = `${dias}d ${horas}h`;
                } else if (horas > 0) {
                    texto = `${horas}h ${minutos}m`;
                } else if (minutos > 0) {
                    texto = `${minutos} min`;
                } else {
                    texto = '< 1 min';
                }
                
                let clase = 'tiempo-rapido';
                const totalHoras = (diffMs / (1000 * 60 * 60));
                if (totalHoras > 72) clase = 'tiempo-lento';
                else if (totalHoras > 24) clase = 'tiempo-medio';
                
                return { 
                    texto, 
                    horas: totalHoras, 
                    dias: dias,
                    minutos: minutos,
                    clase 
                };
                
            } catch (error) {
                console.error('Error calculando tiempo:', error);
                return { texto: 'Error cálculo', horas: 0, clase: '' };
            }
        }
        
        function calcularTiempoPromedioReparacion() {
            const reparados = unsafeConditions.filter(c => c.Estado === 'reparado' && c.Fecha && c.FechaReparacion);
            
            if (reparados.length === 0) {
                return '0h';
            }
            
            let totalHoras = 0;
            let contadorValidos = 0;
            
            reparados.forEach(cond => {
                const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
                if (tiempo.horas > 0) {
                    totalHoras += tiempo.horas;
                    contadorValidos++;
                }
            });
            
            if (contadorValidos === 0) return '0h';
            
            const promedioHoras = Math.round(totalHoras / contadorValidos);
            
            if (promedioHoras < 1) {
                return '< 1h';
            } else if (promedioHoras < 24) {
                return `${promedioHoras}h`;
            } else {
                const dias = Math.floor(promedioHoras / 24);
                const horas = promedioHoras % 24;
                return horas > 0 ? `${dias}d ${horas}h` : `${dias}d`;
            }
        }
        
        function verificarEstadoFecha(fechaEstimada, fechaReparacion = null) {
            if (!fechaEstimada) return { estado: 'sin-fecha', clase: '', icono: 'fa-minus' };
            
            const hoy = new Date();
            const fechaEst = new Date(fechaEstimada);
            const fechaRep = fechaReparacion ? new Date(fechaReparacion) : null;
            
            if (fechaRep) {
                // Ya reparado, verificar si fue a tiempo
                if (fechaRep <= fechaEst) {
                    return { 
                        estado: 'cumplida', 
                        clase: 'date-cumplida', 
                        icono: 'fa-check-circle',
                        texto: 'A tiempo'
                    };
                } else {
                    return { 
                        estado: 'atrasada', 
                        clase: 'date-atrasada', 
                        icono: 'fa-exclamation-circle',
                        texto: 'Con retraso'
                    };
                }
            } else {
                // Pendiente o en proceso
                if (fechaEst < hoy) {
                    return { 
                        estado: 'atrasada', 
                        clase: 'date-atrasada', 
                        icono: 'fa-exclamation-triangle',
                        texto: 'Vencida'
                    };
                } else {
                    const diffDias = Math.ceil((fechaEst - hoy) / (1000 * 60 * 60 * 24));
                    return { 
                        estado: 'pendiente', 
                        clase: 'date-pendiente', 
                        icono: 'fa-calendar',
                        texto: `En ${diffDias} día(s)`
                    };
                }
            }
        }
        
        function calcularCumplimientoFechas() {
            const conFechaEst = unsafeConditions.filter(c => c.FechaEstimadaReparacion);
            if (conFechaEst.length === 0) return 0;
            
            const cumplidas = conFechaEst.filter(c => {
                if (!c.FechaReparacion) return false;
                const fechaEst = new Date(c.FechaEstimadaReparacion);
                const fechaRep = new Date(c.FechaReparacion);
                return fechaRep <= fechaEst;
            }).length;
            
            return Math.round((cumplidas / conFechaEst.length) * 100);
        }
        
        // ==============================================
        // MANEJO DE FOTOS MEJORADO
        // ==============================================
        function handlePhotoUpload(file) {
            if (!file) return;
            
            // Validar tamaño (5MB máximo)
            if (file.size > 5 * 1024 * 1024) {
                alert('La foto es demasiado grande. Máximo 5MB.');
                resetPhoto();
                return;
            }
            
            // Validar tipo
            if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                alert('Formato no válido. Solo JPG y PNG.');
                resetPhoto();
                return;
            }
            
            selectedPhoto = file;
            
            // Mostrar preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewContainer = document.getElementById('photo-preview');
                previewContainer.innerHTML = `
                    <div style="text-align: center; margin-top: 15px;">
                        <img src="${e.target.result}" class="preview-image" alt="Preview">
                        <br>
                        <button type="button" class="remove-photo-btn" onclick="resetPhoto()">
                            <i class="fas fa-times"></i> Quitar foto
                        </button>
                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                            ${file.name} (${(file.size / 1024).toFixed(1)} KB)
                        </p>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }
        
        function resetPhoto() {
            selectedPhoto = null;
            document.getElementById('photo-input').value = '';
            document.getElementById('photo-preview').innerHTML = '';
        }
        
        async function uploadPhotoToSupabase(conditionId) {
            if (!selectedPhoto || !supabaseClient) return null;
            
            try {
                const fileName = `cond_${conditionId}_${Date.now()}.${selectedPhoto.name.split('.').pop()}`;
                
                const { data, error } = await supabaseClient.storage
                    .from('safety_photos')
                    .upload(fileName, selectedPhoto, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) throw error;
                
                return `${CONFIG.supabaseUrl}/storage/v1/object/public/safety_photos/${fileName}`;
                
            } catch (error) {
                console.error('Error subiendo foto:', error);
                return null;
            }
        }
        
        async function uploadCorrectionPhoto(conditionId) {
            return new Promise((resolve) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.style.display = 'none';
                
                input.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (!file) {
                        resolve(null);
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        alert('La foto es demasiado grande. Máximo 5MB.');
                        resolve(null);
                        return;
                    }
                    
                    try {
                        const fileName = `corr_${conditionId}_${Date.now()}.${file.name.split('.').pop()}`;
                        
                        const { data, error } = await supabaseClient.storage
                            .from('safety_photos')
                            .upload(fileName, file, {
                                cacheControl: '3600',
                                upsert: false
                            });
                        
                        if (error) throw error;
                        
                        resolve(`${CONFIG.supabaseUrl}/storage/v1/object/public/safety_photos/${fileName}`);
                        
                    } catch (error) {
                        console.error('Error subiendo foto de corrección:', error);
                        resolve(null);
                    }
                };
                
                document.body.appendChild(input);
                input.click();
                setTimeout(() => document.body.removeChild(input), 100);
            });
        }
        
        function mostrarModalFoto(url, descripcion = '') {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalPhoto');
            const caption = document.getElementById('modalCaption');
            
            modalImg.src = url;
            caption.textContent = descripcion;
            modal.style.display = 'flex';
        }
        
        function cerrarModalFoto() {
            document.getElementById('photoModal').style.display = 'none';
        }
        
        // ==============================================
        // CONFIGURACIÓN SUPABASE
        // ==============================================
        function mostrarConfigPanel() {
            document.getElementById('supabase-config-panel').style.display = 'block';
            document.getElementById('supabase-url').value = CONFIG.supabaseUrl;
            document.getElementById('supabase-key').value = CONFIG.supabaseKey;
        }
        
        function guardarConfigSupabase() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                alert('❌ Ingresa la URL y API Key');
                return;
            }
            
            CONFIG.supabaseUrl = url;
            CONFIG.supabaseKey = key;
            
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            
            alert('✅ Configuración guardada. Conectando...');
            inicializarSupabase();
        }
        
        function inicializarSupabase() {
            if (!CONFIG.supabaseUrl || !CONFIG.supabaseKey) {
                updateStatusIndicator('disconnected', 'Sin configuración');
                mostrarConfigPanel();
                return false;
            }
            
            try {
                supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
                probarConexionSupabase();
                return true;
            } catch (error) {
                updateStatusIndicator('error', 'Error de configuración');
                mostrarConfigPanel();
                return false;
            }
        }
        
        async function probarConexionSupabase() {
            if (!supabaseClient) return false;
            
            showLoading(true, 'Probando conexión con Supabase...');
            
            try {
                // Probar conexión a la tabla
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('count', { count: 'exact', head: true });
                
                if (error) throw error;
                
                // Crear bucket si no existe
                try {
                    await supabaseClient.storage.createBucket('safety_photos', {
                        public: true,
                        allowedMimeTypes: ['image/jpeg', 'image/png'],
                        fileSizeLimit: 5242880 // 5MB
                    });
                } catch (e) {
                    // El bucket ya existe
                }
                
                updateStatusIndicator('connected', 'Conectado ✓');
                CONFIG.offlineMode = false;
                localStorage.setItem('offline_mode', 'false');
                
                document.getElementById('connection-status').innerHTML = 
                    '<span style="color: #27ae60;"><i class="fas fa-check-circle"></i> Conectado a Supabase</span>';
                
                showLoading(false);
                return true;
                
            } catch (error) {
                console.error('Error de conexión:', error);
                
                if (error.message.includes('permission') || error.message.includes('JWT')) {
                    updateStatusIndicator('error', 'Error de permisos');
                    alert('❌ Error de permisos. Verifica la API Key y políticas RLS.');
                } else if (error.message.includes('network')) {
                    updateStatusIndicator('disconnected', 'Sin conexión');
                    CONFIG.offlineMode = true;
                    localStorage.setItem('offline_mode', 'true');
                } else {
                    updateStatusIndicator('error', 'Error de conexión');
                }
                
                showLoading(false);
                return false;
            }
        }
        
        // ==============================================
        // CRUD OPERATIONS
        // ==============================================
        async function cargarCondicionesDesdeSupabase() {
            if (!supabaseClient || CONFIG.offlineMode) {
                return cargarDesdeLocalStorage();
            }
            
            showLoading(true, 'Cargando datos desde Supabase...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('*')
                    .order('fecha', { ascending: false });
                
                if (error) throw error;
                
                CONFIG.lastSync = new Date().toLocaleString();
                localStorage.setItem('last_sync', CONFIG.lastSync);
                
                showLoading(false);
                
                return data.map(item => ({
                    ID: item.id,
                    OT: item.ot_code,
                    ID_secuencial: item.id_secuencial,
                    Fecha: item.fecha,
                    ReportadoPor: item.reportado_por,
                    Descripcion: item.descripcion,
                    Sector: item.sector,
                    Ubicacion: item.ubicacion,
                    Categoria: item.categoria,
                    Riesgo: item.riesgo,
                    Estado: item.estado,
                    ReparadoPor: item.reparado_por,
                    FechaReparacion: item.fecha_reparacion,
                    FechaEstimadaReparacion: item.fecha_estimada,
                    Observaciones: item.observaciones,
                    FotoUrl: item.foto_url,
                    FotoCorreccionUrl: item.foto_correccion_url,
                    ultimaModificacion: item.ultima_modificacion
                }));
                
            } catch (error) {
                console.error('Error cargando:', error);
                showLoading(false);
                return cargarDesdeLocalStorage();
            }
        }
        
        async function guardarCondicionEnSupabase(reporte) {
            if (!supabaseClient || CONFIG.offlineMode) {
                return guardarEnLocalStorage(reporte);
            }
            
            showLoading(true, 'Guardando reporte en Supabase...');
            
            try {
                // Obtener próximo ID
                const { data: lastId } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('id_secuencial')
                    .order('id_secuencial', { ascending: false })
                    .limit(1);
                
                const idSecuencial = lastId && lastId[0] ? lastId[0].id_secuencial + 1 : 1;
                
                const nuevaCondicion = {
                    ot_code: reporte.otCode,
                    reportado_por: reporte.reportedBy,
                    descripcion: reporte.description,
                    sector: reporte.sector,
                    ubicacion: reporte.location,
                    categoria: reporte.category,
                    riesgo: reporte.riskLevel,
                    fecha_estimada: reporte.fechaEstimada,
                    observaciones: reporte.observaciones,
                    estado: 'pendiente',
                    fecha: new Date().toISOString(),
                    id_secuencial: idSecuencial,
                    ultima_modificacion: obtenerTimestamp()
                };
                
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .insert([nuevaCondicion])
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Subir foto si hay
                let fotoUrl = null;
                if (selectedPhoto) {
                    fotoUrl = await uploadPhotoToSupabase(data.id);
                    if (fotoUrl) {
                        await supabaseClient
                            .from('condiciones_inseguras')
                            .update({ foto_url: fotoUrl })
                            .eq('id', data.id);
                    }
                }
                
                showLoading(false);
                updateStatusIndicator('connected', 'Reporte guardado ✓');
                
                // Resetear foto
                resetPhoto();
                
                return {
                    success: true,
                    id: idSecuencial,
                    ot: reporte.otCode,
                    supabaseId: data.id,
                    fotoUrl: fotoUrl
                };
                
            } catch (error) {
                console.error('Error guardando:', error);
                showLoading(false);
                return guardarEnLocalStorage(reporte);
            }
        }
        
        async function actualizarEstadoEnSupabase(id, nuevosDatos) {
            if (!supabaseClient || CONFIG.offlineMode) {
                return { success: false, offline: true };
            }
            
            try {
                const datosActualizar = {
                    estado: nuevosDatos.status,
                    ultima_modificacion: obtenerTimestamp()
                };
                
                if (nuevosDatos.repairedBy) {
                    datosActualizar.reparado_por = nuevosDatos.repairedBy;
                    datosActualizar.fecha_reparacion = new Date().toISOString();
                }
                
                if (nuevosDatos.fotoCorreccionUrl) {
                    datosActualizar.foto_correccion_url = nuevosDatos.fotoCorreccionUrl;
                }
                
                const { error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .update(datosActualizar)
                    .eq('id', id);
                
                if (error) throw error;
                
                return { success: true };
                
            } catch (error) {
                console.error('Error actualizando:', error);
                return { success: false, offline: true };
            }
        }
        
        // ==============================================
        // LOCALSTORAGE (OFFLINE)
        // ==============================================
        function cargarDesdeLocalStorage() {
            const datos = localStorage.getItem('condiciones_pendientes');
            return datos ? JSON.parse(datos) : [];
        }
        
        function guardarEnLocalStorage(reporte) {
            const condiciones = cargarDesdeLocalStorage();
            const nuevoId = condiciones.length + 1;
            
            // Convertir foto a base64 para almacenamiento local
            let fotoBase64 = null;
            if (selectedPhoto) {
                const reader = new FileReader();
                reader.readAsDataURL(selectedPhoto);
                reader.onload = function() {
                    fotoBase64 = reader.result;
                };
            }
            
            const nuevoReporte = {
                ID: nuevoId,
                OT: reporte.otCode,
                ID_secuencial: nuevoId,
                Fecha: new Date().toISOString(),
                ReportadoPor: reporte.reportedBy,
                Descripcion: reporte.description,
                Sector: reporte.sector,
                Ubicacion: reporte.location,
                Categoria: reporte.category,
                Riesgo: reporte.riskLevel,
                FechaEstimadaReparacion: reporte.fechaEstimada,
                Observaciones: reporte.observaciones,
                Estado: "pendiente",
                ReparadoPor: "",
                FechaReparacion: null,
                FotoUrl: fotoBase64,
                FotoCorreccionUrl: null,
                local: true,
                pendienteSincronizacion: true,
                ultimaModificacion: obtenerTimestamp()
            };
            
            condiciones.unshift(nuevoReporte);
            localStorage.setItem('condiciones_pendientes', JSON.stringify(condiciones));
            
            resetPhoto();
            
            return {
                success: true,
                id: nuevoId,
                ot: reporte.otCode,
                offline: true
            };
        }
        
        // ==============================================
        // GRÁFICOS
        // ==============================================
        function crearGraficoEvolucion() {
            const ctx = document.getElementById('evolution-chart');
            if (!ctx) return;
            
            if (evolutionChart) evolutionChart.destroy();
            
            // Agrupar por mes últimos 6 meses
            const ultimos6Meses = [];
            const hoy = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                ultimos6Meses.push(mes);
            }
            
            const datosPorMes = {};
            unsafeConditions.forEach(cond => {
                if (cond.Fecha) {
                    const fecha = new Date(cond.Fecha);
                    const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                    if (ultimos6Meses.includes(mes)) {
                        datosPorMes[mes] = (datosPorMes[mes] || 0) + 1;
                    }
                }
            });
            
            const labels = ultimos6Meses.map(mes => {
                const [año, mesNum] = mes.split('-');
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                return `${meses[parseInt(mesNum) - 1]} ${año}`;
            });
            
            const values = ultimos6Meses.map(mes => datosPorMes[mes] || 0);
            
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reportes',
                        data: values,
                        borderColor: '#dc2c3c',
                        backgroundColor: 'rgba(220, 44, 60, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#dc2c3c',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Evolución de Reportes Mensuales',
                            color: '#dc2c3c',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            title: {
                                display: true,
                                text: 'Cantidad de Reportes',
                                color: '#7f8c8d'
                            }
                        },
                        x: {
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            title: {
                                display: true,
                                text: 'Meses',
                                color: '#7f8c8d'
                            }
                        }
                    }
                }
            });
        }
        
        function crearGraficoAnalisis(tipo = 'risk') {
            const ctx = document.getElementById('data-chart');
            if (!ctx) return;
            
            if (dataChart) dataChart.destroy();
            
            let datos = {};
            let titulo = '';
            
            switch(tipo) {
                case 'risk':
                    datos = unsafeConditions.reduce((acc, cond) => {
                        const riesgo = cond.Riesgo || 'sin definir';
                        acc[riesgo] = (acc[riesgo] || 0) + 1;
                        return acc;
                    }, {});
                    titulo = 'Distribución por Nivel de Riesgo';
                    break;
                case 'sector':
                    datos = unsafeConditions.reduce((acc, cond) => {
                        const sector = cond.Sector || 'sin sector';
                        acc[sector] = (acc[sector] || 0) + 1;
                        return acc;
                    }, {});
                    titulo = 'Distribución por Sector';
                    break;
                case 'category':
                    datos = unsafeConditions.reduce((acc, cond) => {
                        const categoria = cond.Categoria || 'sin categoría';
                        acc[categoria] = (acc[categoria] || 0) + 1;
                        return acc;
                    }, {});
                    titulo = 'Distribución por Tipo de Riesgo';
                    break;
                case 'status':
                    datos = unsafeConditions.reduce((acc, cond) => {
                        const estado = cond.Estado || 'pendiente';
                        acc[estado] = (acc[estado] || 0) + 1;
                        return acc;
                    }, {});
                    titulo = 'Distribución por Estado';
                    break;
                case 'time':
                    // Agrupar por rangos de tiempo de reparación
                    datos = {
                        '< 24h': 0,
                        '1-3 días': 0,
                        '3-7 días': 0,
                        '> 7 días': 0
                    };
                    
                    unsafeConditions.forEach(cond => {
                        if (cond.Estado === 'reparado' && cond.Fecha && cond.FechaReparacion) {
                            const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
                            if (tiempo.horas < 24) datos['< 24h']++;
                            else if (tiempo.dias < 3) datos['1-3 días']++;
                            else if (tiempo.dias < 7) datos['3-7 días']++;
                            else datos['> 7 días']++;
                        }
                    });
                    titulo = 'Tiempos de Reparación';
                    break;
            }
            
            const labels = Object.keys(datos);
            const values = Object.values(datos);
            
            let backgroundColor = [];
            if (tipo === 'risk') {
                backgroundColor = labels.map(label => CHART_COLORS.riesgo[label] || '#95a5a6');
            } else if (tipo === 'status') {
                backgroundColor = labels.map(label => CHART_COLORS.estado[label] || '#95a5a6');
            } else if (tipo === 'category') {
                backgroundColor = labels.map(label => CHART_COLORS.tipo[label] || '#95a5a6');
            } else if (tipo === 'time') {
                backgroundColor = CHART_COLORS.tiempo;
            } else {
                backgroundColor = CHART_COLORS.sector;
            }
            
            dataChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: values,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor.map(color => color.replace('0.2', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: titulo,
                            color: '#dc2c3c',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            title: {
                                display: true,
                                text: 'Cantidad',
                                color: '#7f8c8d'
                            }
                        },
                        x: {
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            title: {
                                display: true,
                                text: tipo === 'risk' ? 'Nivel de Riesgo' : 
                                      tipo === 'sector' ? 'Sector' :
                                      tipo === 'category' ? 'Tipo' :
                                      tipo === 'status' ? 'Estado' : 'Tiempo',
                                color: '#7f8c8d'
                            }
                        }
                    }
                }
            });
        }
        
        function crearGraficoSector() {
            const ctx = document.getElementById('sector-chart');
            if (!ctx) return;
            
            if (sectorChart) sectorChart.destroy();
            
            const datos = unsafeConditions.reduce((acc, cond) => {
                const sector = cond.Sector || 'sin sector';
                acc[sector] = (acc[sector] || 0) + 1;
                return acc;
            }, {});
            
            const labels = Object.keys(datos);
            const values = Object.values(datos);
            
            // Colores para sectores
            const colors = labels.map((label, index) => 
                CHART_COLORS.sector[index % CHART_COLORS.sector.length]
            );
            
            sectorChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Reportes por Sector',
                            color: '#dc2c3c',
                            font: { size: 14, weight: 'bold' }
                        }
                    }
                }
            });
        }
        
        function crearGraficoTiempos() {
            const ctx = document.getElementById('time-chart');
            if (!ctx) return;
            
            if (timeChart) timeChart.destroy();
            
            // Obtener tiempos de reparación para reportes reparados
            const tiemposReparacion = [];
            unsafeConditions.forEach(cond => {
                if (cond.Estado === 'reparado' && cond.Fecha && cond.FechaReparacion) {
                    const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
                    if (tiempo.horas > 0) {
                        tiemposReparacion.push(tiempo.horas);
                    }
                }
            });
            
            if (tiemposReparacion.length === 0) {
                // Mostrar mensaje si no hay datos
                ctx.parentElement.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #7f8c8d;">
                        <div style="text-align: center;">
                            <i class="fas fa-clock" style="font-size: 48px; margin-bottom: 15px; color: #dc2c3c;"></i>
                            <p>No hay datos de tiempos de reparación</p>
                            <p style="font-size: 12px; margin-top: 5px;">Los reportes reparados aparecerán aquí</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Crear histograma de tiempos
            const maxTiempo = Math.max(...tiemposReparacion);
            const intervalos = 5;
            const paso = Math.ceil(maxTiempo / intervalos);
            
            const labels = [];
            const data = [];
            
            for (let i = 0; i < intervalos; i++) {
                const min = i * paso;
                const max = (i + 1) * paso;
                const label = i === intervalos - 1 
                    ? `>${min}h` 
                    : `${min}-${max}h`;
                
                labels.push(label);
                data.push(tiemposReparacion.filter(t => t >= min && (i === intervalos - 1 ? true : t < max)).length);
            }
            
            timeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad de reportes',
                        data: data,
                        backgroundColor: '#dc2c3c',
                        borderColor: '#b71540',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Distribución de Tiempos de Reparación',
                            color: '#dc2c3c',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            title: {
                                display: true,
                                text: 'Cantidad',
                                color: '#7f8c8d'
                            }
                        },
                        x: {
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            title: {
                                display: true,
                                text: 'Horas de Reparación',
                                color: '#7f8c8d'
                            }
                        }
                    }
                }
            });
        }
        
        // ==============================================
        // INTERFAZ PRINCIPAL
        // ==============================================
        async function inicializarSistema() {
            showLoading(true, 'Inicializando sistema Danec v5.0...');
            
            // Establecer fecha mínima para input date
            const hoy = new Date();
            const manana = new Date(hoy);
            manana.setDate(manana.getDate() + 1);
            document.getElementById('fecha-estimada').min = manana.toISOString().split('T')[0];
            
            // Establecer fecha por defecto (7 días después)
            const fechaDefault = new Date(hoy);
            fechaDefault.setDate(fechaDefault.getDate() + 7);
            document.getElementById('fecha-estimada').value = fechaDefault.toISOString().split('T')[0];
            
            inicializarSupabase();
            
            unsafeConditions = await cargarCondicionesDesdeSupabase();
            
            actualizarEstadisticas();
            actualizarTablaReciente();
            actualizarTablaHistorial();
            crearGraficoEvolucion();
            actualizarUIConfiguracion();
            
            showLoading(false);
            
            // Actualizar cada 30 segundos
            setInterval(async () => {
                unsafeConditions = await cargarCondicionesDesdeSupabase();
                actualizarEstadisticas();
                actualizarTablaReciente();
            }, 30000);
        }
        
        function actualizarEstadisticas() {
            const total = unsafeConditions.length;
            const pendientes = unsafeConditions.filter(c => c.Estado === 'pendiente').length;
            const enProceso = unsafeConditions.filter(c => c.Estado === 'en proceso').length;
            const reparados = unsafeConditions.filter(c => c.Estado === 'reparado').length;
            const tiempoPromedio = calcularTiempoPromedioReparacion();
            const cumplimiento = calcularCumplimientoFechas();
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('pending-count').textContent = pendientes;
            document.getElementById('process-count').textContent = enProceso;
            document.getElementById('repaired-count').textContent = reparados;
            document.getElementById('avg-time').textContent = tiempoPromedio;
            
            // Actualizar KPIs
            document.getElementById('kpi-tiempo-promedio').textContent = tiempoPromedio;
            document.getElementById('kpi-cumplimiento').textContent = `${cumplimiento}%`;
            
            // Reportes este mes
            const hoy = new Date();
            const mesActual = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
            const reportesEsteMes = unsafeConditions.filter(c => {
                if (!c.Fecha) return false;
                const fecha = new Date(c.Fecha);
                const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                return mes === mesActual;
            }).length;
            document.getElementById('kpi-reportes-mes').textContent = reportesEsteMes;
            
            if (document.getElementById('total-db-count')) {
                document.getElementById('total-db-count').textContent = total;
            }
            
            if (document.getElementById('reports-with-photos')) {
                const conFotos = unsafeConditions.filter(c => c.FotoUrl).length;
                document.getElementById('reports-with-photos').textContent = conFotos;
            }
            
            if (document.getElementById('avg-repair-time')) {
                document.getElementById('avg-repair-time').textContent = tiempoPromedio;
            }
            
            if (document.getElementById('cumplimiento-fechas')) {
                document.getElementById('cumplimiento-fechas').textContent = `${cumplimiento}%`;
            }
        }
        
        function actualizarTablaReciente() {
            const tbody = document.querySelector('#recent-table tbody');
            if (!tbody) return;
            
            const recientes = [...unsafeConditions]
                .sort((a, b) => new Date(b.ultimaModificacion || b.Fecha) - new Date(a.ultimaModificacion || a.Fecha))
                .slice(0, 8);
            
            if (recientes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; color: #dc2c3c;"></i>
                            <p>No hay reportes registrados</p>
                            <p style="font-size: 12px; margin-top: 5px;">Crea tu primer reporte en "Nuevo Reporte"</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = recientes.map(cond => {
                const otCode = cond.OT || 'SIN-OT';
                const descCorta = cond.Descripcion.length > 50 ? cond.Descripcion.substring(0, 50) + '...' : cond.Descripcion;
                const estado = cond.Estado || 'pendiente';
                
                let estadoBadge = '';
                if (estado === 'pendiente') estadoBadge = '<span class="status-badge status-pendiente">Pendiente</span>';
                else if (estado === 'en proceso') estadoBadge = '<span class="status-badge status-en-proceso">En Proceso</span>';
                else estadoBadge = '<span class="status-badge status-reparado">Reparado</span>';
                
                // Tipo de riesgo (especial para Físico)
                let tipoHTML = cond.Categoria || 'N/A';
                if (cond.Categoria === 'Físico') {
                    tipoHTML = `<span class="tipo-fisico">${cond.Categoria}</span>`;
                }
                
                // Tiempo de reparación
                let tiempoHTML = '';
                if (estado === 'reparado' && cond.Fecha && cond.FechaReparacion) {
                    const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
                    tiempoHTML = `<span class="tiempo-reparacion ${tiempo.clase}"><i class="fas fa-clock"></i> ${tiempo.texto}</span>`;
                } else if (estado === 'en proceso' && cond.Fecha) {
                    const tiempo = calcularTiempoReparacion(cond.Fecha, new Date());
                    tiempoHTML = `<span style="color: #3498db"><i class="fas fa-hourglass-half"></i> ${tiempo.texto}</span>`;
                } else {
                    tiempoHTML = '<span style="color: #95a5a6"><i class="fas fa-minus"></i> -</span>';
                }
                
                // Estado de fecha estimada
                let fechaEstHTML = '-';
                if (cond.FechaEstimadaReparacion) {
                    const estadoFecha = verificarEstadoFecha(cond.FechaEstimadaReparacion, cond.FechaReparacion);
                    fechaEstHTML = `
                        <div class="date-badge ${estadoFecha.clase}" title="${estadoFecha.texto}">
                            <i class="fas ${estadoFecha.icono}"></i>
                            ${formatDate(cond.FechaEstimadaReparacion).split(',')[0]}
                        </div>
                    `;
                }
                
                return `
                    <tr>
                        <td><span class="ot-code"><i class="fas fa-hashtag"></i> ${otCode}</span></td>
                        <td title="${cond.Descripcion}">${descCorta}</td>
                        <td>${cond.Sector || 'N/A'}</td>
                        <td>${tipoHTML}</td>
                        <td>${fechaEstHTML}</td>
                        <td>${tiempoHTML}</td>
                        <td>${estadoBadge}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function actualizarTablaHistorial(filtro = 'all') {
    const tbody = document.querySelector('#history-table tbody');
    if (!tbody) return;
    
    let condicionesFiltradas = [...unsafeConditions];
    
    if (filtro !== 'all') {
        condicionesFiltradas = unsafeConditions.filter(c => (c.Estado || 'pendiente') === filtro);
    }
    
    // Filtrar por sector si hay selección
    const filterSector = document.getElementById('filter-sector').value;
    if (filterSector) {
        condicionesFiltradas = condicionesFiltradas.filter(c => c.Sector === filterSector);
    }
    
    condicionesFiltradas.sort((a, b) => new Date(b.Fecha || b.ultimaModificacion) - new Date(a.Fecha || a.ultimaModificacion));
    
    if (condicionesFiltradas.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="12" style="text-align: center; padding: 50px; color: #7f8c8d;">
                    <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; color: #dc2c3c;"></i>
                    <p>No hay reportes ${filtro !== 'all' ? `con estado "${filtro}"` : 'registrados'}</p>
                    <p style="font-size: 12px; margin-top: 5px;">Intenta con otro filtro o crea un nuevo reporte</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = condicionesFiltradas.map(cond => {
        const otCode = cond.OT || 'SIN-OT';
        const descCorta = cond.Descripcion.length > 60 ? cond.Descripcion.substring(0, 60) + '...' : cond.Descripcion;
        const estado = cond.Estado || 'pendiente';
        
        let estadoBadge = '';
        if (estado === 'pendiente') estadoBadge = '<span class="status-badge status-pendiente">Pendiente</span>';
        else if (estado === 'en proceso') estadoBadge = '<span class="status-badge status-en-proceso">En Proceso</span>';
        else estadoBadge = '<span class="status-badge status-reparado">Reparado</span>';
        
        // Tiempo de reparación
        let tiempoHTML = '';
        if (estado === 'reparado' && cond.Fecha && cond.FechaReparacion) {
            const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
            tiempoHTML = `<span class="tiempo-reparacion ${tiempo.clase}">
                <i class="fas fa-clock"></i> ${tiempo.texto}
            </span>`;
        } else if (estado === 'en proceso' && cond.Fecha) {
            const tiempo = calcularTiempoReparacion(cond.Fecha, new Date());
            tiempoHTML = `<span style="color: #3498db"><i class="fas fa-hourglass-half"></i> ${tiempo.texto}</span>`;
        } else {
            tiempoHTML = '<span style="color: #95a5a6"><i class="fas fa-minus"></i> -</span>';
        }
        
        // Foto
        let fotoHTML = '<span class="no-photo">-</span>';
        if (cond.FotoUrl) {
            fotoHTML = `
                <img src="${cond.FotoUrl}" 
                     class="table-photo" 
                     alt="Foto"
                     onclick="mostrarModalFoto('${cond.FotoUrl}', 'Reporte ${otCode}')"
                     title="Ver foto del reporte">
            `;
        }
        
        // Tipo de riesgo (especial para Físico)
        let tipoHTML = cond.Categoria || 'N/A';
        if (cond.Categoria === 'Físico') {
            tipoHTML = `<span class="tipo-fisico">${cond.Categoria}</span>`;
        }
        
        // Badge de riesgo
        let riesgoClass = '';
        if (cond.Riesgo === 'Crítico') riesgoClass = 'risk-critico';
        else if (cond.Riesgo === 'Alto') riesgoClass = 'risk-alto';
        else if (cond.Riesgo === 'Medio') riesgoClass = 'risk-medio';
        else if (cond.Riesgo === 'Bajo') riesgoClass = 'risk-bajo';
        
        const riesgoBadge = riesgoClass ? 
            `<span class="risk-badge ${riesgoClass}">${cond.Riesgo}</span>` :
            cond.Riesgo || 'N/A';
        
        // Estado de fecha estimada
        let fechaEstHTML = '-';
        if (cond.FechaEstimadaReparacion) {
            const estadoFecha = verificarEstadoFecha(cond.FechaEstimadaReparacion, cond.FechaReparacion);
            fechaEstHTML = `
                <div class="date-badge ${estadoFecha.clase}" title="${estadoFecha.texto}">
                    <i class="fas ${estadoFecha.icono}"></i>
                    ${formatDate(cond.FechaEstimadaReparacion).split(',')[0]}
                </div>
            `;
        }
        
        // ACCIONES - usando un nombre diferente (accionesHTML) para evitar conflicto
        let accionesHTML = '';
        if (otCode) {
            if (estado === 'pendiente') {
                accionesHTML = `
                    <button class="action-btn btn-primary" onclick="cambiarEstado('${otCode}', 'en proceso')" title="Marcar como en proceso">
                        <i class="fas fa-play"></i> Proceso
                    </button>
                    <button class="action-btn btn-success" onclick="cambiarEstado('${otCode}', 'reparado')" title="Marcar como reparado">
                        <i class="fas fa-check"></i> Reparar
                    </button>
                `;
            } else if (estado === 'en proceso') {
                accionesHTML = `
                    <button class="action-btn btn-success" onclick="cambiarEstado('${otCode}', 'reparado')" title="Marcar como reparado">
                        <i class="fas fa-check"></i> Reparar
                    </button>
                    <button class="action-btn btn-warning" onclick="cambiarEstado('${otCode}', 'pendiente')" title="Volver a pendiente">
                        <i class="fas fa-undo"></i> Pendiente
                    </button>
                `;
            } else {
                accionesHTML = `
                    <button class="action-btn btn-warning" onclick="cambiarEstado('${otCode}', 'pendiente')" title="Volver a pendiente">
                        <i class="fas fa-undo"></i> Pendiente
                    </button>
                    ${cond.FotoCorreccionUrl ? `
                    <button class="action-btn btn-primary" onclick="mostrarModalFoto('${cond.FotoCorreccionUrl}', 'Foto de corrección ${otCode}')" title="Ver corrección">
                        <i class="fas fa-camera"></i> Corr.
                    </button>
                    ` : ''}
                `;
            }
        }
        
        return `
            <tr>
                <td><span class="ot-code"><i class="fas fa-hashtag"></i> ${otCode}</span></td>
                <td title="${cond.Descripcion}">${descCorta}</td>
                <td>${cond.Sector || 'N/A'}</td>
                <td>${tipoHTML}</td>
                <td>${riesgoBadge}</td>
                <td>${fechaEstHTML}</td>
                <td class="photo-cell">${fotoHTML}</td>
                <td>${formatDate(cond.Fecha)}</td>
                <td>${tiempoHTML}</td>
                <td>${cond.ReportadoPor || 'Anónimo'}</td>
                <td>${estadoBadge}</td>
                <td class="actions">${accionesHTML}</td>
            </tr>
        `;
    }).join('');
}
        
        async function guardarNuevoReporte(event) {
            event.preventDefault();
            
            const reporte = {
                otCode: document.getElementById('ot-code').value.trim(),
                reportedBy: document.getElementById('reporter-name').value.trim(),
                description: document.getElementById('description').value.trim(),
                sector: document.getElementById('sector').value,
                location: document.getElementById('ubicacion').value.trim(),
                category: document.getElementById('category').value,
                riskLevel: document.getElementById('risk-level').value,
                fechaEstimada: document.getElementById('fecha-estimada').value,
                observaciones: document.getElementById('observaciones').value.trim()
            };
            
            // Validaciones
            // Validar formato de OT (5 dígitos numéricos)
if (!reporte.otCode.match(/^\d{5}$/)) {
    alert('❌ Código OT inválido. Debe ser exactamente 5 dígitos numéricos.');
    return;
}

// Validar que OT no esté duplicado
const otExistente = unsafeConditions.find(c => c.OT === reporte.otCode);
if (otExistente) {
    alert(`❌ Ya existe un reporte con OT ${reporte.otCode}. Use un código diferente.`);
    return;
}
            
           // Validar que solo sea Aceites o Jabonería-Confitería
            const zonasValidas = ['Aceites', 'Jabonería-Confitería'];
                if (!zonasValidas.includes(reporte.sector)) {
                alert('❌ Solo se permiten los sectores: Aceites o Jabonería-Confitería');
            return;
            }
            
            if (!reporte.otCode || !reporte.reportedBy || !reporte.description || !reporte.sector || 
                !reporte.location || !reporte.category || !reporte.riskLevel || !reporte.fechaEstimada) {
                alert('❌ Complete todos los campos obligatorios (*)');
                return;
            }
            
            // Verificar si ya existe el código OT
            const otExistente = unsafeConditions.find(c => c.OT === reporte.otCode);
            if (otExistente) {
                alert('❌ Ya existe un reporte con ese código OT. Use uno diferente.');
                return;
            }
            
            const resultado = await guardarCondicionEnSupabase(reporte);
            
            if (resultado.success) {
                unsafeConditions = await cargarCondicionesDesdeSupabase();
                
                if (resultado.offline) {
                    alert('⚠️ Modo offline. Reporte guardado localmente.');
                } else {
                    alert(`✅ Reporte guardado exitosamente\nOT: ${resultado.ot}\nID: #${resultado.id}`);
                }
                
                document.getElementById('report-form').reset();
                resetPhoto();
                
                // Restablecer fecha por defecto
                const hoy = new Date();
                const fechaDefault = new Date(hoy);
                fechaDefault.setDate(fechaDefault.getDate() + 7);
                document.getElementById('fecha-estimada').value = fechaDefault.toISOString().split('T')[0];
                
                actualizarEstadisticas();
                actualizarTablaReciente();
                actualizarTablaHistorial(currentFilter);
                crearGraficoEvolucion();
                
                document.querySelector('.nav-menu a[data-page="dashboard"]').click();
            } else {
                alert('❌ Error guardando el reporte');
            }
        }
        
      async function cambiarEstado(otCode, nuevoEstado) {
    console.log('=== INICIANDO CAMBIO DE ESTADO ===');
    console.log('OT:', otCode, 'Nuevo estado:', nuevoEstado);
    
    // Buscar por OT
    const condicion = unsafeConditions.find(c => c.OT === otCode);
    
    if (!condicion) {
        alert(`❌ Reporte con OT "${otCode}" no encontrado`);
        console.log('Reportes disponibles:', unsafeConditions.map(c => c.OT));
        return;
    }
    
    console.log('✅ Reporte encontrado:', condicion);
    
    // Preguntar por foto de corrección si es reparado
    let fotoCorreccionUrl = null;
    if (nuevoEstado === 'reparado') {
        const confirmacion = confirm('¿Marcar como reparado?\n\n¿Desea agregar una foto de la corrección realizada?');
        if (confirmacion) {
            fotoCorreccionUrl = await uploadCorrectionPhoto(condicion.ID);
        }
    }
    
    const nuevosDatos = { 
        status: nuevoEstado,
        fechaReparacion: nuevoEstado === 'reparado' ? new Date().toISOString() : null,
        fotoCorreccionUrl: fotoCorreccionUrl
    };
    
    if (nuevoEstado === 'reparado') {
        const reparador = prompt('Ingrese su nombre (quién realiza la reparación):');
        nuevosDatos.repairedBy = reparador && reparador.trim() ? reparador.trim() : 'Técnico';
    }
    
    // Actualizar en Supabase
    const resultado = await actualizarEstadoEnSupabase(condicion.ID, nuevosDatos);
    
    // Actualizar localmente
    condicion.Estado = nuevoEstado;
    condicion.ultimaModificacion = obtenerTimestamp();
    
    if (nuevosDatos.repairedBy) {
        condicion.ReparadoPor = nuevosDatos.repairedBy;
        condicion.FechaReparacion = nuevosDatos.fechaReparacion;
    }
    
    if (fotoCorreccionUrl) {
        condicion.FotoCorreccionUrl = fotoCorreccionUrl;
    }
    
    // Actualizar interfaz
    actualizarEstadisticas();
    actualizarTablaReciente();
    actualizarTablaHistorial(currentFilter);
    crearGraficoEvolucion();
    
    alert(resultado.offline ? '✅ Estado actualizado (modo offline)' : '✅ Estado actualizado');
}
        
        function mostrarEjemplo() {
    // Generar un OT de ejemplo basado en los existentes
    const numerosUsados = unsafeConditions
        .filter(c => c.OT && c.OT.match(/^\d{5}$/))
        .map(c => parseInt(c.OT))
        .filter(n => !isNaN(n));
    
    let ejemploNumero = 10001;
    if (numerosUsados.length > 0) {
        ejemploNumero = Math.max(...numerosUsados) + 100;
    }
    
    document.getElementById('ot-code').value = String(ejemploNumero).padStart(5, '0');
    document.getElementById('reporter-name').value = 'Juan Pérez Rodríguez';
    document.getElementById('description').value = 'Piso resbaladizo por aceite derramado en zona de máquinas. El área no está señalizada y representa un riesgo de caída para el personal.';
    document.getElementById('sector').value = 'Aceites';
    document.getElementById('ubicacion').value = 'Área de producción, Línea 3, Lado derecho';
    document.getElementById('category').value = 'Físico';
    document.getElementById('risk-level').value = 'Alto';
    
    // Fecha 5 días después
    const fecha = new Date();
    fecha.setDate(fecha.getDate() + 5);
    document.getElementById('fecha-estimada').value = fecha.toISOString().split('T')[0];
    
    document.getElementById('observaciones').value = 'Requiere limpieza inmediata y señalización con conos. Prioridad alta por ser zona de paso frecuente.';
}
        
        function forzarActualizacion() {
            unsafeConditions = [...unsafeConditions].sort((a, b) => 
                new Date(b.ultimaModificacion || b.Fecha) - new Date(a.ultimaModificacion || a.Fecha)
            );
            
            actualizarTablaReciente();
            actualizarEstadisticas();
            
            const status = document.getElementById('status-indicator');
            status.innerHTML = '<i class="fas fa-check-circle"></i> <span>Actualizado ✓</span>';
            status.style.backgroundColor = '#27ae60';
            
            setTimeout(() => {
                updateStatusIndicator('connected', 'Conectado ✓');
            }, 2000);
        }
        
        function actualizarAnalisis() {
            const tipo = document.getElementById('analysis-type').value;
            crearGraficoAnalisis(tipo);
            crearGraficoSector();
            crearGraficoTiempos();
        }
        
        function exportarHistorial() {
    const csv = unsafeConditions.map(cond => {
        // Calcular tiempo de reparación si está reparado
        let tiempoReparacion = '';
        if (cond.Estado === 'reparado' && cond.Fecha && cond.FechaReparacion) {
            const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
            tiempoReparacion = tiempo.texto;
        }
        
        // Estado de fecha estimada
        let estadoFecha = '';
        if (cond.FechaEstimadaReparacion) {
            const estado = verificarEstadoFecha(cond.FechaEstimadaReparacion, cond.FechaReparacion);
            estadoFecha = estado.texto;
        }
        
        return [
            cond.OT || '',
            `"${cond.Descripcion || ''}"`,
            cond.Sector || '',
            cond.Categoria || '',
            cond.Riesgo || '',
            cond.FechaEstimadaReparacion || '',
            estadoFecha,
            cond.Fecha || '',
            tiempoReparacion,
            cond.Estado || '',
            cond.ReportadoPor || '',
            cond.ReparadoPor || '',
            cond.FotoUrl ? 'Sí' : 'No',
            cond.ID_secuencial || ''
        ].join(',');
    }).join('\n');
    
    const headers = 'OT,Descripción,Sector,Tipo,Riesgo,Fecha Estimada,Estado Fecha,Fecha Reporte,Tiempo Reparación,Estado,Reportado por,Reparado por,Tiene Foto,ID Secuencial\n';
    const blob = new Blob([headers + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `condiciones_danec_${new Date().toISOString().split('T')[0]}.csv`);
    link.click();
}
        
        function actualizarUIConfiguracion() {
            document.getElementById('current-url').value = CONFIG.supabaseUrl || 'No configurado';
            document.getElementById('current-key').value = CONFIG.supabaseKey ? 
                CONFIG.supabaseKey.substring(0, 20) + '...' : 'No configurado';
            document.getElementById('last-sync').textContent = CONFIG.lastSync;
            document.getElementById('current-mode').textContent = 
                CONFIG.offlineMode ? 'Modo Offline' : 'Modo Online (Supabase)';
        }
        
        function probarConexion() {
            probarConexionSupabase().then(success => {
                if (success) {
                    alert('✅ Conexión exitosa con Supabase');
                } else {
                    alert('❌ Error de conexión. Verifica las credenciales.');
                }
                actualizarUIConfiguracion();
            });
        }
        
        function limpiarDatos() {
            if (confirm('⚠️ ¿Eliminar todos los datos locales?\n\nEsto no afecta la base de datos de Supabase, solo los datos almacenados en este navegador.')) {
                localStorage.removeItem('condiciones_pendientes');
                alert('✅ Datos locales eliminados');
                location.reload();
            }
        }
        
        function resetConfig() {
            if (confirm('¿Restablecer configuración de Supabase?')) {
                localStorage.removeItem('supabase_url');
                localStorage.removeItem('supabase_key');
                localStorage.removeItem('offline_mode');
                localStorage.removeItem('last_sync');
                alert('✅ Configuración restablecida');
                location.reload();
            }
        }
        
        function backupLocal() {
            const datos = localStorage.getItem('condiciones_pendientes');
            if (!datos) {
                alert('No hay datos locales para respaldar');
                return;
            }
            
            const blob = new Blob([datos], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_danec_${new Date().toISOString().split('T')[0]}.json`);
            link.click();
            alert('✅ Backup descargado');
        }
        
        function generarReportePDF() {
            alert('🚧 Función en desarrollo. Por ahora, use la opción "Exportar" para CSV.');
        }
        
        function abrirManualSupabase() {
            const manual = `
            ==============================================
            MANUAL COMPLETO: CONFIGURACIÓN SUPABASE
            ==============================================
            
            1. CREAR CUENTA EN SUPABASE
            ----------------------------
            • Ve a https://supabase.com y crea una cuenta
            • Haz clic en "New Project"
            
            2. CONFIGURAR PROYECTO
            ----------------------
            • Nombre: danec-condiciones-inseguras
            • Contraseña: (guárdala en un lugar seguro)
            • Región: Selecciona la más cercana
            • Haz clic en "Create new project"
            
            3. CREAR LA TABLA EN SQL EDITOR
            --------------------------------
            • Ve a SQL Editor en el menú izquierdo
            • Haz clic en "New query"
            • Copia y pega este SQL:
            
            -----------------------------------------------
            CREATE TABLE condiciones_inseguras (
                id BIGSERIAL PRIMARY KEY,
                ot_code VARCHAR(50) NOT NULL UNIQUE,
                id_secuencial INTEGER NOT NULL,
                fecha TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                reportado_por VARCHAR(100) NOT NULL,
                descripcion TEXT NOT NULL,
                sector VARCHAR(50) NOT NULL,
                ubicacion VARCHAR(200) NOT NULL,
                categoria VARCHAR(50) NOT NULL,
                riesgo VARCHAR(50) NOT NULL,
                estado VARCHAR(20) DEFAULT 'pendiente',
                reparado_por VARCHAR(100),
                fecha_reparacion TIMESTAMP WITH TIME ZONE,
                fecha_estimada DATE,
                observaciones TEXT,
                foto_url TEXT,
                foto_correccion_url TEXT,
                ultima_modificacion TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
            );
            
            -- Índices para mejor performance
            CREATE INDEX idx_estado ON condiciones_inseguras(estado);
            CREATE INDEX idx_sector ON condiciones_inseguras(sector);
            CREATE INDEX idx_fecha ON condiciones_inseguras(fecha);
            CREATE INDEX idx_ot_code ON condiciones_inseguras(ot_code);
            -----------------------------------------------
            
            4. CONFIGURAR POLÍTICAS RLS (Row Level Security)
            -------------------------------------------------
            • Ve a Authentication > Policies
            • Haz clic en "Enable RLS" en la tabla condiciones_inseguras
            • Crea estas políticas:
            
            a) PARA LECTURA (SELECT):
               • Nombre: "Allow public read access"
               • USING: true
               • Con CHECK: true
            
            b) PARA ESCRITURA (INSERT):
               • Nombre: "Allow public insert"
               • USING: true
               • Con CHECK: true
            
            c) PARA ACTUALIZACIÓN (UPDATE):
               • Nombre: "Allow public update"
               • USING: true
               • Con CHECK: true
            
            5. CONFIGURAR BUCKET DE ALMACENAMIENTO
            ---------------------------------------
            • Ve a Storage en el menú izquierdo
            • Haz clic en "Create a new bucket"
            • Nombre: safety_photos
            • Marca "Public bucket"
            • Haz clic en "Create bucket"
            
            6. CONFIGURAR POLÍTICAS DEL BUCKET
            -----------------------------------
            • En el bucket safety_photos, ve a "Policies"
            • Crea estas políticas:
            
            a) PARA SUBIR ARCHIVOS:
               • Nombre: "Allow upload"
               • Operación: INSERT
               • USING: true
               • Con CHECK: true
            
            b) PARA LEER ARCHIVOS:
               • Nombre: "Allow read"
               • Operación: SELECT
               • USING: true
               • Con CHECK: true
            
            7. OBTENER CREDENCIALES
            -----------------------
            • Ve a Settings > API en el menú izquierdo
            • Copia:
               - URL: La que aparece en "Project URL"
               - API Key: La que aparece en "anon public"
            
            8. CONFIGURAR EN LA APLICACIÓN
            ------------------------------
            • En la app, ve a "Configuración"
            • Haz clic en "Cambiar Credenciales"
            • Pega la URL y API Key
            • Haz clic en "Conectar"
            
            9. VERIFICAR CONEXIÓN
            ---------------------
            • Haz clic en "Probar Conexión"
            • Debería aparecer "Conectado ✓"
            
            ==============================================
            ¡LISTO! Tu sistema está configurado.
            ==============================================
            `;
            
            // Crear modal con el manual
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 4000;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 800px;
                max-height: 80vh;
                overflow-y: auto;
                font-family: monospace;
                font-size: 14px;
                line-height: 1.6;
                white-space: pre-wrap;
                border: 3px solid #dc2c3c;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '✕ Cerrar';
            closeBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                background: #dc2c3c;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
            `;
            
            content.textContent = manual;
            modal.appendChild(content);
            modal.appendChild(closeBtn);
            
            closeBtn.onclick = () => document.body.removeChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) document.body.removeChild(modal);
            };
            
            document.body.appendChild(modal);
        }
        
        // ==============================================
        // INICIALIZACIÓN
        // ==============================================
        document.addEventListener('DOMContentLoaded', async function() {
            await inicializarSistema();
            
            // Formulario
            document.getElementById('report-form').addEventListener('submit', guardarNuevoReporte);
            
            // Navegación
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    
                    document.querySelectorAll('.nav-menu a').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
                    document.getElementById(`${pageId}-page`).style.display = 'block';
                    
                    if (pageId === 'analisis') {
                        setTimeout(actualizarAnalisis, 100);
                    }
                    
                    if (pageId !== 'config') {
                        document.getElementById('supabase-config-panel').style.display = 'none';
                    }
                });
            });
            
            // Filtros
            document.getElementById('filter-all').addEventListener('click', () => {
                currentFilter = 'all';
                actualizarTablaHistorial('all');
            });
            document.getElementById('filter-pending').addEventListener('click', () => {
                currentFilter = 'pendiente';
                actualizarTablaHistorial('pendiente');
            });
            document.getElementById('filter-process').addEventListener('click', () => {
                currentFilter = 'en proceso';
                actualizarTablaHistorial('en proceso');
            });
            document.getElementById('filter-repaired').addEventListener('click', () => {
                currentFilter = 'reparado';
                actualizarTablaHistorial('reparado');
            });
            
            // Filtro por sector
            document.getElementById('filter-sector').addEventListener('change', function() {
                actualizarTablaHistorial(currentFilter);
            });
            
            // Búsqueda
            document.getElementById('search-input').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const tbody = document.querySelector('#history-table tbody');
                if (!tbody) return;
                
                tbody.querySelectorAll('tr').forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
            
            // Análisis
            document.getElementById('analysis-type').addEventListener('change', function() {
                crearGraficoAnalisis(this.value);
            });
            
            // Drag & drop para foto
            const dropArea = document.getElementById('photo-drop-area');
            const fileInput = document.getElementById('photo-input');
            
            dropArea.addEventListener('click', () => fileInput.click());
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropArea.classList.add('dragging');
            }
            
            function unhighlight() {
                dropArea.classList.remove('dragging');
            }
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                handlePhotoUpload(file);
            }
        });
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalFoto();
        });
        
        // ==============================================
        // FUNCIONES GLOBALES
        // ==============================================
        window.cambiarEstado = cambiarEstado;
        window.mostrarConfigPanel = mostrarConfigPanel;
        window.probarConexion = probarConexion;
        window.limpiarDatos = limpiarDatos;
        window.guardarConfigSupabase = guardarConfigSupabase;
        window.forzarActualizacion = forzarActualizacion;
        window.mostrarEjemplo = mostrarEjemplo;
        window.exportarHistorial = exportarHistorial;
        window.actualizarAnalisis = actualizarAnalisis;
        window.mostrarModalFoto = mostrarModalFoto;
        window.cerrarModalFoto = cerrarModalFoto;
        window.resetPhoto = resetPhoto;
        window.generarCodigoOT = generarCodigoOT;
        window.resetConfig = resetConfig;
        window.backupLocal = backupLocal;
        window.generarReportePDF = generarReportePDF;
        window.abrirManualSupabase = abrirManualSupabase;
    </script>
</body>
</html>
