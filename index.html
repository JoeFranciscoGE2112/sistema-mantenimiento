<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Condiciones Inseguras - Supabase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        /* ===== ESTILOS BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --danger: #e74c3c;
            --warning: #f39c12;
            --safe: #2ecc71;
            --light: #ecf0f1;
            --dark: #34495e;
            --supabase: #3ecf8e;
            --chart-red: #e74c3c;
            --chart-orange: #f39c12;
            --chart-yellow: #f1c40f;
            --chart-green: #2ecc71;
            --chart-blue: #3498db;
            --chart-purple: #9b59b6;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER ===== */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 28px;
            color: white;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        }

        .main-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ===== COMPONENTES ===== */
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            color: var(--secondary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--supabase);
            color: white;
        }

        .btn-success:hover {
            background-color: #2db57d;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pendiente {
            background-color: rgba(243, 156, 18, 0.2);
            color: #e67e22;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .status-reparado {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .status-en-proceso {
            background-color: rgba(52, 152, 219, 0.2);
            color: #2980b9;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        /* ===== NAVEGACIÓN ===== */
        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 10px;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-radius: 5px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-menu a:hover, .nav-menu a.active {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            transform: translateX(5px);
        }

        /* ===== ESTADÍSTICAS ===== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-title {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== EVOLUCIÓN TIEMPO ===== */
        .evolution-card {
            grid-column: span 2;
            height: 350px; /* Aumentado de 250px */
        }

        /* ===== TABLAS ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background-color: var(--primary);
            color: white;
            text-align: left;
            padding: 12px 15px;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        table tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        table tr:last-child td {
            border-bottom: none;
        }

        /* ===== GRÁFICOS MEJORADOS ===== */
        .chart-container {
            position: relative;
            height: 400px; /* Aumentado de 300px */
            width: 100%;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-item {
            background: white;
            border-radius: 10px;
            padding: 25px; /* Aumentado de 20px */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            min-height: 400px; /* Altura mínima aumentada */
            display: flex;
            flex-direction: column;
        }

        .chart-item h3 {
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-item .chart-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        /* ===== ACCIONES ===== */
        .actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            border: none;
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            border-top: 1px solid #eee;
        }

        /* ===== SUPABASE CONFIG ===== */
        .supabase-config {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .supabase-config h3 {
            color: white;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .supabase-config input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid transparent;
        }

        .supabase-config input:focus {
            border-color: var(--supabase);
            background: white;
        }

        /* ===== STATUS INDICATOR ===== */
        .status-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .status-connected {
            background: var(--supabase);
            color: white;
        }

        .status-disconnected {
            background: var(--warning);
            color: white;
        }

        .status-error {
            background: var(--danger);
            color: white;
        }

        /* ===== TIEMPO REPARACIÓN ===== */
        .tiempo-rapido {
            color: var(--chart-green);
            font-weight: bold;
        }

        .tiempo-medio {
            color: var(--chart-orange);
            font-weight: bold;
        }

        .tiempo-lento {
            color: var(--chart-red);
            font-weight: bold;
        }

        .tiempo-proceso {
            color: var(--chart-blue);
            font-weight: bold;
        }

        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--supabase);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== FOTOGRAFÍAS ===== */
        .photo-upload-container {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8f9fa;
            margin-bottom: 15px;
        }

        .photo-upload-container:hover {
            border-color: #2980b9;
            background-color: #e3f2fd;
        }

        .photo-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-preview {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .remove-photo:hover {
            background: #c0392b;
        }

        .photos-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .photo-viewer {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .photo-thumbnails {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .photo-thumb {
            width: 80px;
            height: 80px;
            border-radius: 5px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .photo-thumb:hover {
            border-color: #3498db;
            transform: scale(1.05);
        }

        .photo-thumb.active {
            border-color: #2ecc71;
            box-shadow: 0 0 5px rgba(46, 204, 113, 0.5);
        }

        .photo-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .photo-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .photo-modal-img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            background: none;
            border: none;
        }

        /* ===== FORMULARIOS CON FOTOS ===== */
        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section-title i {
            color: var(--secondary);
        }

        /* ===== DASHBOARD MEJORADO ===== */
        .dashboard-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-chart-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            min-height: 450px;
        }

        .dashboard-chart-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .chart-container-large {
            height: 350px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ===== RESPONSIVE MEJORADO ===== */
        @media (max-width: 1200px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
            
            .evolution-card {
                grid-column: span 1;
            }
            
            .dashboard-charts {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-item {
                min-height: 350px;
            }
            
            .dashboard-chart-container {
                min-height: 400px;
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            
            .chart-container-large {
                height: 250px;
            }
            
            .chart-item {
                min-height: 300px;
                padding: 15px;
            }
            
            .dashboard-chart-container {
                min-height: 350px;
                padding: 15px;
            }
            
            .photo-preview {
                width: 120px;
                height: 120px;
            }
            
            .photo-thumb {
                width: 60px;
                height: 60px;
            }
        }

        @media (max-width: 576px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .status-indicator {
                bottom: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .chart-container-large {
                height: 200px;
            }
            
            .chart-item {
                min-height: 250px;
            }
            
            .dashboard-chart-container {
                min-height: 300px;
            }
            
            .photo-preview {
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loading-text">Conectando con la base de datos...</p>
    </div>

    <!-- Status Indicator -->
    <div id="status-indicator" class="status-indicator status-disconnected">
        <i class="fas fa-database"></i>
        <span>Desconectado</span>
    </div>

    <!-- Modal para ver fotos -->
    <div id="photoModal" class="photo-modal">
        <button class="close-modal" onclick="cerrarModalFoto()">&times;</button>
        <div class="photo-modal-content">
            <img id="modalPhoto" class="photo-modal-img" src="" alt="Foto ampliada">
            <p id="modalCaption" style="color: white; text-align: center; margin-top: 10px;"></p>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-hard-hat"></i>
                    <h1>Sistema de Condiciones Inseguras</h1>
                </div>
                <div class="user-info">
                    <i class="fas fa-database"></i>
                    <span id="db-status">Supabase</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <nav>
                    <ul class="nav-menu">
                        <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="#" data-page="registro"><i class="fas fa-plus-circle"></i> Nuevo Reporte</a></li>
                        <li><a href="#" data-page="historial"><i class="fas fa-history"></i> Historial</a></li>
                        <li><a href="#" data-page="analisis"><i class="fas fa-chart-bar"></i> Análisis</a></li>
                        <li><a href="#" data-page="config"><i class="fas fa-cog"></i> Configuración</a></li>
                    </ul>
                </nav>

                <!-- Supabase Config Panel -->
                <div id="supabase-config-panel" class="supabase-config" style="display: none;">
                    <h3><i class="fas fa-database"></i> Configurar Supabase</h3>
                    <p>Conecta tu aplicación con la base de datos en la nube</p>
                    
                    <div class="form-group">
                        <label for="supabase-url">URL de Supabase:</label>
                        <input type="text" id="supabase-url" class="form-control" 
                               placeholder="https://abc123.supabase.co">
                    </div>
                    
                    <div class="form-group">
                        <label for="supabase-key">API Key (anon public):</label>
                        <input type="text" id="supabase-key" class="form-control" 
                               placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                    </div>
                    
                    <button class="btn btn-success" onclick="guardarConfigSupabase()">
                        <i class="fas fa-plug"></i> Conectar con Supabase
                    </button>
                    
                    <div style="margin-top: 15px; font-size: 12px; opacity: 0.9;">
                        <p><strong>¿Dónde consigo estos datos?</strong></p>
                        <ol style="margin: 10px 0 0 20px; padding: 0;">
                            <li>Ve a <a href="https://supabase.com" target="_blank" style="color: white; text-decoration: underline;">supabase.com</a></li>
                            <li>Crea proyecto gratis</li>
                            <li>Ve a Settings → API</li>
                            <li>Copia URL y anon public key</li>
                        </ol>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3><i class="fas fa-info-circle"></i> Información</h3>
                    <p style="margin-top: 10px; font-size: 14px;">
                        Sistema conectado a base de datos en la nube. Todos los datos se sincronizan automáticamente.
                    </p>
                </div>
            </aside>

            <!-- Main Panel -->
            <main class="main-panel">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-title">Total Reportes</div>
                            <div class="stat-value" id="total-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Pendientes</div>
                            <div class="stat-value" id="pending-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">En Proceso</div>
                            <div class="stat-value" id="process-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Reparados</div>
                            <div class="stat-value" id="repaired-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Tiempo Promedio</div>
                            <div class="stat-value" id="average-time">0 días</div>
                        </div>
                        
                        <!-- Evolución en el tiempo -->
                        <div class="stat-card evolution-card">
                            <div class="stat-title">Evolución Mensual</div>
                            <div class="chart-container">
                                <canvas id="evolution-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard Charts - Nueva sección -->
                    <div class="dashboard-charts">
                        <div class="dashboard-chart-container">
                            <h3><i class="fas fa-exclamation-triangle"></i> Riesgos por Nivel</h3>
                            <div class="chart-container-large">
                                <canvas id="dashboard-risk-chart"></canvas>
                            </div>
                        </div>
                        <div class="dashboard-chart-container">
                            <h3><i class="fas fa-map-marker-alt"></i> Distribución por Sector</h3>
                            <div class="chart-container-large">
                                <canvas id="dashboard-sector-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2><i class="fas fa-history"></i> Últimas Actividades</h2>
                            <button onclick="forzarActualizacion()" class="btn" style="padding: 5px 10px;">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="recent-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Descripción</th>
                                        <th>Ubicación/Sector</th>
                                        <th>Reportado por</th>
                                        <th>Fecha</th>
                                        <th>Estado</th>
                                        <th>Fotos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Registro Page -->
                <div id="registro-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-plus-circle"></i> Nuevo Reporte de Condición Insegura</h2>
                        <form id="report-form">
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-user"></i> Información del Reportante
                                </div>
                                <div class="form-group">
                                    <label for="reporter-name">Reportado por *</label>
                                    <input type="text" class="form-control" id="reporter-name" 
                                           placeholder="Ingrese su nombre completo" required>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-file-alt"></i> Descripción del Problema
                                </div>
                                <div class="form-group">
                                    <label for="description">Descripción detallada *</label>
                                    <textarea class="form-control" id="description" rows="4" 
                                              placeholder="Describa detalladamente la condición insegura, incluyendo posibles consecuencias..." required></textarea>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-camera"></i> Fotografías de la Condición Insegura
                                </div>
                                <div class="form-group">
                                    <label>Subir fotografías (máximo 5, formato JPG/PNG, máximo 5MB cada una):</label>
                                    <div class="photo-upload-container" onclick="document.getElementById('photos-input').click()">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #3498db; margin-bottom: 10px;"></i>
                                        <p>Haz clic o arrastra imágenes aquí</p>
                                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">Selecciona las fotos de la condición insegura</p>
                                    </div>
                                    <input type="file" id="photos-input" accept="image/*" multiple 
                                           style="display: none;" onchange="previewPhotos(this)">
                                    <div class="photo-preview-container" id="photos-preview"></div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-map-marker-alt"></i> Ubicación
                                </div>
                                <div class="form-group">
                                    <label for="sector">Sector/Área *</label>
                                    <select class="form-control" id="sector" required>
                                        <option value="">Seleccione el sector</option>
                                        <option value="produccion">Área de Producción</option>
                                        <option value="almacen">Almacén</option>
                                        <option value="mantenimiento">Mantenimiento</option>
                                        <option value="oficinas">Oficinas</option>
                                        <option value="laboratorio">Laboratorio</option>
                                        <option value="exteriores">Áreas Exteriores</option>
                                        <option value="servicios">Servicios Generales</option>
                                        <option value="otros">Otros</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="ubicacion-especifica">Ubicación específica *</label>
                                    <input type="text" class="form-control" id="ubicacion-especifica" 
                                           placeholder="Ej: Línea 3, Estación 5, Pasillo principal" required>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-shield-alt"></i> Evaluación de Riesgo
                                </div>
                                <div class="form-group">
                                    <label for="category">Tipo de riesgo *</label>
                                    <select class="form-control" id="category" required>
                                        <option value="">Seleccione el tipo</option>
                                        <option value="electrico">Riesgo Eléctrico</option>
                                        <option value="mecanico">Riesgo Mecánico</option>
                                        <option value="alturas">Trabajo en Alturas</option>
                                        <option value="quimico">Riesgo Químico</option>
                                        <option value="incendio">Riesgo de Incendio</option>
                                        <option value="ergonomico">Riesgo Ergonómico</option>
                                        <option value="biologico">Riesgo Biológico</option>
                                        <option value="psicosocial">Riesgo Psicosocial</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="risk-level">Nivel de Riesgo *</label>
                                    <select class="form-control" id="risk-level" required>
                                        <option value="">Seleccione el nivel</option>
                                        <option value="bajo">Bajo (Verde)</option>
                                        <option value="medio">Medio (Amarillo)</option>
                                        <option value="alto">Alto (Naranja)</option>
                                        <option value="critico">Crítico (Rojo)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="fas fa-sticky-note"></i> Información Adicional
                                </div>
                                <div class="form-group">
                                    <label for="observaciones">Observaciones adicionales</label>
                                    <textarea class="form-control" id="observaciones" rows="2" 
                                              placeholder="Observaciones, recomendaciones o información adicional..."></textarea>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; flex-wrap: wrap;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Guardar Reporte
                                </button>
                                <button type="reset" class="btn" style="background-color: #95a5a6; color: white;" onclick="limpiarFotos()">
                                    <i class="fas fa-undo"></i> Limpiar Todo
                                </button>
                                <button type="button" class="btn btn-warning" onclick="mostrarEjemplo()">
                                    <i class="fas fa-eye"></i> Ver Ejemplo
                                </button>
                                <button type="button" class="btn" style="background-color: #9b59b6; color: white;" onclick="mostrarReporteConFotos()">
                                    <i class="fas fa-images"></i> Ejemplo con Fotos
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Historial Page -->
                <div id="historial-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-history"></i> Historial de Reportes</h2>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn" id="filter-all">Todos</button>
                                <button class="btn btn-warning" id="filter-pending">Pendientes</button>
                                <button class="btn btn-primary" id="filter-process">En Proceso</button>
                                <button class="btn btn-success" id="filter-repaired">Reparados</button>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" class="form-control" id="search-input" placeholder="Buscar..." style="width: 200px;">
                                <button class="btn" onclick="exportarHistorial()" title="Exportar a CSV">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table id="history-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Descripción</th>
                                        <th>Sector</th>
                                        <th>Ubicación</th>
                                        <th>Tipo Riesgo</th>
                                        <th>Nivel Riesgo</th>
                                        <th>Fotos</th>
                                        <th>Fecha Reporte</th>
                                        <th>Tiempo Reparación</th>
                                        <th>Reportado por</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Análisis Page -->
                <div id="analisis-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-chart-bar"></i> Análisis de Condiciones Inseguras</h2>
                        
                        <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <select class="form-control" id="analysis-type" style="width: 200px;">
                                <option value="risk">Por Nivel de Riesgo</option>
                                <option value="sector">Por Sector/Área</option>
                                <option value="category">Por Tipo de Riesgo</option>
                                <option value="status">Por Estado</option>
                                <option value="evolution">Evolución Temporal</option>
                            </select>
                            <button class="btn btn-primary" onclick="actualizarAnalisis()">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                        
                        <!-- Gráfico principal mejorado -->
                        <div class="chart-container">
                            <canvas id="data-chart"></canvas>
                        </div>
                        
                        <!-- Dos gráficos adicionales mejorados -->
                        <div class="chart-row">
                            <div class="chart-item">
                                <h3><i class="fas fa-exclamation-triangle"></i> Riesgos por Sector</h3>
                                <div class="chart-wrapper">
                                    <canvas id="sector-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-item">
                                <h3><i class="fas fa-chart-pie"></i> Distribución por Estado</h3>
                                <div class="chart-wrapper">
                                    <canvas id="status-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nuevo gráfico de fotos -->
                        <div class="chart-item" style="margin-top: 20px;">
                            <h3><i class="fas fa-camera"></i> Reportes con Fotografías</h3>
                            <div class="chart-wrapper">
                                <canvas id="photos-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Estadísticas detalladas -->
                        <div id="analisis-detallado" style="margin-top: 30px;">
                            <!-- Se llenará con JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Configuración Page -->
                <div id="config-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-cog"></i> Configuración del Sistema</h2>
                        
                        <div class="supabase-config">
                            <h3><i class="fas fa-database"></i> Conexión Supabase</h3>
                            
                            <div class="form-group">
                                <label>Estado de conexión:</label>
                                <div id="connection-status" style="padding: 10px; background: rgba(255, 255, 255, 0.2); border-radius: 5px;">
                                    Verificando...
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="current-url">URL Actual:</label>
                                <input type="text" id="current-url" class="form-control" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="current-key">API Key Actual:</label>
                                <input type="text" id="current-key" class="form-control" readonly>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="probarConexion()">
                                    <i class="fas fa-sync-alt"></i> Probar Conexión
                                </button>
                                <button class="btn btn-warning" onclick="mostrarConfigPanel()">
                                    <i class="fas fa-edit"></i> Cambiar Configuración
                                </button>
                                <button class="btn btn-danger" onclick="limpiarDatos()">
                                    <i class="fas fa-trash"></i> Limpiar Datos Locales
                                </button>
                                <button class="btn" onclick="generarDatosPrueba()" style="background-color: #9b59b6; color: white;">
                                    <i class="fas fa-vial"></i> Datos de Prueba
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3><i class="fas fa-info-circle"></i> Información Técnica</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                                <p><strong>Total reportes en base de datos:</strong> <span id="total-db-count">0</span></p>
                                <p><strong>Reportes con fotos:</strong> <span id="reports-with-photos">0</span></p>
                                <p><strong>Total fotos almacenadas:</strong> <span id="total-photos">0</span></p>
                                <p><strong>Última sincronización:</strong> <span id="last-sync">Nunca</span></p>
                                <p><strong>Modo actual:</strong> <span id="current-mode">Desconocido</span></p>
                                <p><strong>Versión:</strong> <span id="app-version">2.1.0</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <footer class="footer">
            <p>Sistema de Condiciones Inseguras &copy; 2024 - Conectado a Supabase</p>
            <p style="font-size: 14px; margin-top: 5px;">Base de datos en la nube - Todos los datos se sincronizan automáticamente</p>
        </footer>
    </div>

    <script>
        // ==============================================
        // CONFIGURACIÓN Y VARIABLES GLOBALES
        // ==============================================
        let supabaseClient = null;
        let unsafeConditions = [];
        let currentFilter = 'all';
        let dataChart = null;
        let sectorChart = null;
        let statusChart = null;
        let evolutionChart = null;
        let dashboardRiskChart = null;
        let dashboardSectorChart = null;
        let photosChart = null;
        
        // Variables para fotos
        let photosToUpload = [];
        let maxPhotos = 5;
        let maxFileSize = 5 * 1024 * 1024; // 5MB
        
        // Configuración por defecto
        let CONFIG = {
            supabaseUrl: localStorage.getItem('supabase_url') || 'https://gcbmkwshpsiovxawkvuy.supabase.co',
            supabaseKey: localStorage.getItem('supabase_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjYm1rd3NocHNpb3Z4YXdrdnV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMjMyMDQsImV4cCI6MjA4Mzc5OTIwNH0.HSW3m1VGK3Vhv-Pq14B_2_TEaxX9AX1JP38HPYRFfyY',
            lastSync: localStorage.getItem('last_sync') || 'Nunca',
            offlineMode: localStorage.getItem('offline_mode') === 'true' || false
        };
        
        // Paleta de colores para gráficos
        const CHART_COLORS = {
            riesgo: {
                critico: '#e74c3c', // Rojo para crítico
                alto: '#e67e22',    // Naranja para alto
                medio: '#f1c40f',   // Amarillo para medio
                bajo: '#2ecc71'     // Verde para bajo
            },
            estado: {
                pendiente: '#e74c3c',   // Rojo
                proceso: '#3498db',     // Azul
                reparado: '#2ecc71'     // Verde
            },
            sector: [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', 
                '#9b59b6', '#1abc9c', '#d35400', '#c0392b'
            ],
            categoria: [
                '#e74c3c', '#3498db', '#f39c12', '#2ecc71',
                '#9b59b6', '#1abc9c', '#34495e', '#7f8c8d'
            ]
        };
        
        // ==============================================
        // FUNCIONES DE UTILIDAD
        // ==============================================
        
        function showLoading(show, text = 'Cargando...') {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            
            if (loading) {
                loading.style.display = show ? 'flex' : 'none';
            }
            
            if (loadingText && text) {
                loadingText.textContent = text;
            }
        }
        
        function updateStatusIndicator(status, message) {
            const indicator = document.getElementById('status-indicator');
            if (!indicator) return;
            
            indicator.classList.remove('status-connected', 'status-disconnected', 'status-error');
            indicator.classList.add(`status-${status}`);
            
            let icon = 'fa-database';
            if (status === 'connected') icon = 'fa-check-circle';
            if (status === 'error') icon = 'fa-exclamation-triangle';
            if (status === 'disconnected') icon = 'fa-unlink';
            
            indicator.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            
            const dbStatus = document.getElementById('db-status');
            if (dbStatus) {
                dbStatus.textContent = status === 'connected' ? 'Conectado' : 'Desconectado';
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function obtenerTimestamp() {
            return new Date().toISOString();
        }
        
        // ==============================================
        // FUNCIONES PARA FOTOGRAFÍAS
        // ==============================================
        
        function previewPhotos(input) {
            const previewContainer = document.getElementById('photos-preview');
            const files = input.files;
            
            if (files.length > maxPhotos) {
                alert(`Solo puedes subir un máximo de ${maxPhotos} fotos`);
                input.value = '';
                return;
            }
            
            // Limpiar preview anterior
            previewContainer.innerHTML = '';
            photosToUpload = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Validar tamaño
                if (file.size > maxFileSize) {
                    alert(`La foto "${file.name}" es demasiado grande. Máximo 5MB.`);
                    continue;
                }
                
                // Validar tipo
                if (!file.type.match('image.*')) {
                    alert(`El archivo "${file.name}" no es una imagen válida.`);
                    continue;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-preview';
                    photoDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${i + 1}">
                        <button type="button" class="remove-photo" onclick="removePhoto(${i})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    previewContainer.appendChild(photoDiv);
                    
                    // Guardar para upload
                    photosToUpload.push({
                        file: file,
                        preview: e.target.result,
                        name: file.name
                    });
                };
                
                reader.readAsDataURL(file);
            }
            
            // Actualizar contador
            updatePhotoCount();
        }
        
        function removePhoto(index) {
            photosToUpload.splice(index, 1);
            
            // Recrear preview
            const previewContainer = document.getElementById('photos-preview');
            previewContainer.innerHTML = '';
            
            photosToUpload.forEach((photo, i) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-preview';
                photoDiv.innerHTML = `
                    <img src="${photo.preview}" alt="Preview ${i + 1}">
                    <button type="button" class="remove-photo" onclick="removePhoto(${i})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                previewContainer.appendChild(photoDiv);
            });
            
            updatePhotoCount();
        }
        
        function limpiarFotos() {
            photosToUpload = [];
            document.getElementById('photos-preview').innerHTML = '';
            document.getElementById('photos-input').value = '';
            updatePhotoCount();
        }
        
        function updatePhotoCount() {
            const count = photosToUpload.length;
            const uploadContainer = document.querySelector('.photo-upload-container p:last-child');
            if (uploadContainer) {
                uploadContainer.textContent = `Fotos seleccionadas: ${count}/${maxPhotos}`;
            }
        }
        
        async function uploadPhotosToSupabase(conditionId) {
            if (!supabaseClient || photosToUpload.length === 0) {
                return [];
            }
            
            const uploadedPhotos = [];
            
            for (let i = 0; i < photosToUpload.length; i++) {
                const photo = photosToUpload[i];
                const fileName = `${conditionId}_${Date.now()}_${i}.jpg`;
                
                try {
                    // Convertir a blob si es base64
                    let blob;
                    if (photo.file) {
                        blob = photo.file;
                    } else {
                        // Convertir base64 a blob
                        const base64Data = photo.preview.split(',')[1];
                        const byteCharacters = atob(base64Data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let j = 0; j < byteCharacters.length; j++) {
                            byteNumbers[j] = byteCharacters.charCodeAt(j);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        blob = new Blob([byteArray], { type: 'image/jpeg' });
                    }
                    
                    const { data, error } = await supabaseClient.storage
                        .from('condition_photos')
                        .upload(fileName, blob, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) throw error;
                    
                    uploadedPhotos.push({
                        url: `${CONFIG.supabaseUrl}/storage/v1/object/public/condition_photos/${fileName}`,
                        name: fileName,
                        index: i
                    });
                    
                } catch (error) {
                    console.error('Error subiendo foto:', error);
                    // Continuar con otras fotos
                }
            }
            
            return uploadedPhotos;
        }
        
        async function uploadCorrectionPhotoToSupabase(conditionId) {
            return new Promise((resolve) => {
                // Crear input para foto de corrección
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.style.display = 'none';
                
                input.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (!file) {
                        resolve(null);
                        return;
                    }
                    
                    if (file.size > maxFileSize) {
                        alert('La foto es demasiado grande. Máximo 5MB.');
                        resolve(null);
                        return;
                    }
                    
                    const fileName = `${conditionId}_correction_${Date.now()}.jpg`;
                    
                    try {
                        const { data, error } = await supabaseClient.storage
                            .from('correction_photos')
                            .upload(fileName, file, {
                                cacheControl: '3600',
                                upsert: false
                            });
                        
                        if (error) throw error;
                        
                        resolve({
                            url: `${CONFIG.supabaseUrl}/storage/v1/object/public/correction_photos/${fileName}`,
                            name: fileName
                        });
                        
                    } catch (error) {
                        console.error('Error subiendo foto de corrección:', error);
                        resolve(null);
                    }
                };
                
                document.body.appendChild(input);
                input.click();
                setTimeout(() => document.body.removeChild(input), 100);
            });
        }
        
        function mostrarModalFoto(url, descripcion = '') {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalPhoto');
            const caption = document.getElementById('modalCaption');
            
            modalImg.src = url;
            caption.textContent = descripcion;
            modal.style.display = 'flex';
        }
        
        function cerrarModalFoto() {
            document.getElementById('photoModal').style.display = 'none';
        }
        
        function mostrarFotosEnTabla(fotos) {
            if (!fotos || fotos.length === 0) {
                return '<span style="color: #95a5a6;"><i class="fas fa-times"></i> Sin fotos</span>';
            }
            
            let html = `<div style="display: flex; gap: 5px; flex-wrap: wrap;">`;
            
            fotos.forEach((foto, index) => {
                html += `
                    <img src="${foto}" 
                         alt="Foto ${index + 1}" 
                         style="width: 30px; height: 30px; border-radius: 3px; cursor: pointer; object-fit: cover;"
                         onclick="mostrarModalFoto('${foto}', 'Foto ${index + 1}')"
                         title="Ver foto ${index + 1}">
                `;
            });
            
            html += `</div>`;
            return html;
        }
        
        function mostrarReporteConFotos() {
            document.getElementById('reporter-name').value = 'Carlos Rodríguez';
            document.getElementById('description').value = 'Extintor bloqueado por materiales de almacenamiento en el pasillo principal. No se puede acceder en caso de emergencia.';
            document.getElementById('sector').value = 'almacen';
            document.getElementById('ubicacion-especifica').value = 'Pasillo principal del almacén, cerca de la salida de emergencia';
            document.getElementById('category').value = 'incendio';
            document.getElementById('risk-level').value = 'alto';
            document.getElementById('observaciones').value = 'Los materiales deben ser reubicados inmediatamente para liberar acceso al extintor.';
            
            // Simular fotos (en realidad se necesitarían archivos reales)
            alert('En un caso real, aquí se cargarían fotos de ejemplo. Para probar, puedes seleccionar fotos reales desde tu computadora.');
        }
        
        // ==============================================
        // FUNCIONES DE TIEMPO DE REPARACIÓN
        // ==============================================
        
        function calcularTiempoReparacion(fechaInicio, fechaFin) {
            if (!fechaInicio || !fechaFin) {
                return { texto: 'No reparado', dias: 0, clase: '' };
            }
            
            try {
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                const diffMs = fin - inicio;
                
                if (isNaN(diffMs) || diffMs < 0) {
                    return { texto: 'Fechas inválidas', dias: 0, clase: '' };
                }
                
                const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                let texto = '';
                if (dias > 0) {
                    texto = `${dias} día${dias !== 1 ? 's' : ''}`;
                    if (horas > 0) texto += ` ${horas}h`;
                } else if (horas > 0) {
                    texto = `${horas} hora${horas !== 1 ? 's' : ''}`;
                    if (minutos > 0) texto += ` ${minutos}min`;
                } else if (minutos > 0) {
                    texto = `${minutos} minuto${minutos !== 1 ? 's' : ''}`;
                } else {
                    texto = '< 1 minuto';
                }
                
                let clase = 'tiempo-rapido';
                if (dias > 3) clase = 'tiempo-lento';
                else if (dias > 1) clase = 'tiempo-medio';
                
                return {
                    texto: texto,
                    dias: dias,
                    horas: horas,
                    minutos: minutos,
                    totalHoras: Math.floor(diffMs / (1000 * 60 * 60)),
                    clase: clase
                };
                
            } catch (error) {
                return { texto: 'Error cálculo', dias: 0, clase: '' };
            }
        }
        
        // ==============================================
        // FUNCIONES DE CONFIGURACIÓN SUPABASE
        // ==============================================
        
        function mostrarConfigPanel() {
            document.getElementById('supabase-config-panel').style.display = 'block';
            document.getElementById('supabase-url').value = CONFIG.supabaseUrl;
            document.getElementById('supabase-key').value = CONFIG.supabaseKey;
        }
        
        function guardarConfigSupabase() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                alert('❌ Por favor ingresa tanto la URL como la API Key');
                return;
            }
            
            if (!url.includes('.supabase.co')) {
                alert('❌ La URL debe terminar en .supabase.co');
                return;
            }
            
            CONFIG.supabaseUrl = url;
            CONFIG.supabaseKey = key;
            
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            
            alert('✅ Configuración guardada. Reiniciando conexión...');
            inicializarSupabase();
        }
        
        function inicializarSupabase() {
            if (!CONFIG.supabaseUrl || !CONFIG.supabaseKey) {
                updateStatusIndicator('disconnected', 'Sin configuración');
                mostrarConfigPanel();
                return false;
            }
            
            try {
                supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
                probarConexionSupabase();
                return true;
            } catch (error) {
                console.error('Error inicializando Supabase:', error);
                updateStatusIndicator('error', 'Error de configuración');
                mostrarConfigPanel();
                return false;
            }
        }
        
        async function probarConexionSupabase() {
            if (!supabaseClient) {
                updateStatusIndicator('disconnected', 'Cliente no inicializado');
                return false;
            }
            
            showLoading(true, 'Probando conexión con Supabase...');
            
            try {
                // Probar conexión y crear buckets si no existen
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('count', { count: 'exact', head: true });
                
                if (error) throw error;
                
                // Intentar crear buckets de almacenamiento
                try {
                    // Bucket para fotos de condiciones
                    await supabaseClient.storage.createBucket('condition_photos', {
                        public: true,
                        allowedMimeTypes: ['image/jpeg', 'image/png', 'image/gif'],
                        fileSizeLimit: 5242880 // 5MB
                    });
                } catch (e) {
                    // El bucket ya existe, está bien
                }
                
                try {
                    // Bucket para fotos de corrección
                    await supabaseClient.storage.createBucket('correction_photos', {
                        public: true,
                        allowedMimeTypes: ['image/jpeg', 'image/png', 'image/gif'],
                        fileSizeLimit: 5242880 // 5MB
                    });
                } catch (e) {
                    // El bucket ya existe, está bien
                }
                
                updateStatusIndicator('connected', 'Conectado a Supabase');
                CONFIG.offlineMode = false;
                localStorage.setItem('offline_mode', 'false');
                
                if (document.getElementById('connection-status')) {
                    document.getElementById('connection-status').innerHTML = 
                        '<span style="color: #3ecf8e;"><i class="fas fa-check-circle"></i> Conectado</span>';
                }
                
                showLoading(false);
                return true;
                
            } catch (error) {
                console.error('Error probando conexión:', error);
                
                if (error.message.includes('permission') || error.message.includes('JWT')) {
                    updateStatusIndicator('error', 'Error de permisos');
                    alert('❌ Error de permisos. Verifica:\n1. La tabla existe\n2. Las políticas RLS\n3. La API Key es correcta');
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    updateStatusIndicator('disconnected', 'Sin conexión a internet');
                    CONFIG.offlineMode = true;
                    localStorage.setItem('offline_mode', 'true');
                } else {
                    updateStatusIndicator('error', 'Error de conexión');
                }
                
                showLoading(false);
                return false;
            }
        }
        
        // ==============================================
        // FUNCIONES CRUD PARA SUPABASE
        // ==============================================
        
        async function cargarCondicionesDesdeSupabase() {
            if (!supabaseClient || CONFIG.offlineMode) {
                return cargarDesdeLocalStorage();
            }
            
            showLoading(true, 'Cargando datos desde la nube...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('*')
                    .order('fecha', { ascending: false });
                
                if (error) throw error;
                
                CONFIG.lastSync = new Date().toLocaleString();
                localStorage.setItem('last_sync', CONFIG.lastSync);
                
                showLoading(false);
                
                // Cargar también fotos si existen
                const condicionesConFotos = await Promise.all(data.map(async (item) => {
                    let fotos = [];
                    let fotosCorreccion = [];
                    
                    try {
                        // Cargar fotos de condición
                        const { data: photosData } = await supabaseClient.storage
                            .from('condition_photos')
                            .list(`${item.id}/`);
                        
                        if (photosData) {
                            fotos = photosData.map(photo => 
                                `${CONFIG.supabaseUrl}/storage/v1/object/public/condition_photos/${item.id}/${photo.name}`
                            );
                        }
                        
                        // Cargar fotos de corrección
                        const { data: correctionPhotosData } = await supabaseClient.storage
                            .from('correction_photos')
                            .list(`${item.id}/`);
                        
                        if (correctionPhotosData) {
                            fotosCorreccion = correctionPhotosData.map(photo => 
                                `${CONFIG.supabaseUrl}/storage/v1/object/public/correction_photos/${item.id}/${photo.name}`
                            );
                        }
                        
                    } catch (e) {
                        console.log('No se pudieron cargar las fotos:', e);
                    }
                    
                    return {
                        ID: item.id,
                        Fecha: item.fecha,
                        ReportadoPor: item.reportado_por,
                        Descripcion: item.descripcion,
                        Sector: item.sector || 'sin-sector',
                        Ubicacion: item.ubicacion,
                        Categoria: item.categoria,
                        Riesgo: item.riesgo,
                        Estado: item.estado || 'pendiente',
                        ReparadoPor: item.reparado_por,
                        FechaReparacion: item.fecha_reparacion,
                        Observaciones: item.observaciones,
                        CreadoEn: item.creado_en,
                        ultimaModificacion: item.ultima_modificacion || item.fecha,
                        Fotos: fotos,
                        FotosCorreccion: fotosCorreccion,
                        TieneFotos: fotos.length > 0
                    };
                }));
                
                return condicionesConFotos;
                
            } catch (error) {
                console.error('Error cargando desde Supabase:', error);
                showLoading(false);
                return cargarDesdeLocalStorage();
            }
        }
        
        async function guardarCondicionEnSupabase(reporte) {
            if (!supabaseClient || CONFIG.offlineMode) {
                return guardarEnLocalStorage(reporte);
            }
            
            showLoading(true, 'Guardando en la base de datos...');
            
            try {
                const idSecuencial = await obtenerProximoIdSecuencial();
                
                const nuevaCondicion = {
                    reportado_por: reporte.reportedBy,
                    descripcion: reporte.description,
                    sector: reporte.sector,
                    ubicacion: reporte.location,
                    categoria: reporte.category,
                    riesgo: reporte.riskLevel,
                    observaciones: reporte.observaciones,
                    estado: 'pendiente',
                    fecha: new Date().toISOString().split('T')[0],
                    id_secuencial: idSecuencial,
                    ultima_modificacion: obtenerTimestamp(),
                    tiene_fotos: photosToUpload.length > 0
                };
                
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .insert([nuevaCondicion])
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Subir fotos si hay
                let fotosUrls = [];
                if (photosToUpload.length > 0) {
                    fotosUrls = await uploadPhotosToSupabase(data.id);
                }
                
                showLoading(false);
                updateStatusIndicator('connected', 'Reporte guardado ✓');
                
                // Limpiar fotos
                limpiarFotos();
                
                return {
                    success: true,
                    id: idSecuencial,
                    supabaseId: data.id,
                    data: data,
                    fotos: fotosUrls
                };
                
            } catch (error) {
                console.error('Error guardando en Supabase:', error);
                showLoading(false);
                return guardarEnLocalStorage(reporte);
            }
        }
        
        async function actualizarEstadoEnSupabase(id, nuevosDatos) {
            if (!supabaseClient || CONFIG.offlineMode) {
                return { success: false, offline: true };
            }
            
            try {
                const datosActualizar = {
                    estado: nuevosDatos.status,
                    ultima_modificacion: obtenerTimestamp()
                };
                
                if (nuevosDatos.repairedBy) {
                    datosActualizar.reparado_por = nuevosDatos.repairedBy;
                    datosActualizar.fecha_reparacion = new Date().toISOString().split('T')[0];
                }
                
                // Subir foto de corrección si se marca como reparado
                if (nuevosDatos.status === 'reparado' && nuevosDatos.uploadCorrectionPhoto) {
                    const correctionPhoto = await uploadCorrectionPhotoToSupabase(id);
                    if (correctionPhoto) {
                        datosActualizar.tiene_fotos_correccion = true;
                    }
                }
                
                const { error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .update(datosActualizar)
                    .eq('id', id);
                
                if (error) throw error;
                
                return { success: true };
                
            } catch (error) {
                console.error('Error actualizando en Supabase:', error);
                return { success: false, offline: true };
            }
        }
        
        async function obtenerProximoIdSecuencial() {
            try {
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('id_secuencial')
                    .order('id_secuencial', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0 && data[0].id_secuencial) {
                    return data[0].id_secuencial + 1;
                }
                return 1;
                
            } catch (error) {
                console.error('Error obteniendo próximo ID:', error);
                return unsafeConditions.length + 1;
            }
        }
        
        // ==============================================
        // FUNCIONES LOCALSTORAGE (RESPALDO OFFLINE)
        // ==============================================
        
        function cargarDesdeLocalStorage() {
            const datos = localStorage.getItem('condiciones_pendientes');
            if (datos) {
                const parsed = JSON.parse(datos);
                return Array.isArray(parsed) ? parsed : [];
            }
            return [];
        }
        
        function guardarEnLocalStorage(reporte) {
            const condiciones = cargarDesdeLocalStorage();
            const nuevoId = condiciones.length + 1;
            
            const nuevoReporte = {
                ID: nuevoId,
                ID_secuencial: nuevoId,
                Fecha: new Date().toISOString().split('T')[0],
                ReportadoPor: reporte.reportedBy,
                Descripcion: reporte.description,
                Sector: reporte.sector,
                Ubicacion: reporte.location,
                Categoria: reporte.category,
                Riesgo: reporte.riskLevel,
                Observaciones: reporte.observaciones,
                Estado: "pendiente",
                ReparadoPor: "",
                local: true,
                pendienteSincronizacion: true,
                ultimaModificacion: obtenerTimestamp(),
                Fotos: photosToUpload.map(photo => photo.preview),
                TieneFotos: photosToUpload.length > 0
            };
            
            condiciones.unshift(nuevoReporte);
            localStorage.setItem('condiciones_pendientes', JSON.stringify(condiciones));
            
            // Guardar fotos en localStorage
            if (photosToUpload.length > 0) {
                localStorage.setItem(`fotos_${nuevoId}`, JSON.stringify(photosToUpload.map(p => p.preview)));
            }
            
            // Limpiar fotos
            limpiarFotos();
            
            return {
                success: true,
                id: nuevoId,
                offline: true
            };
        }
        
        function actualizarEnLocalStorage(id, nuevosDatos) {
            const condiciones = cargarDesdeLocalStorage();
            const index = condiciones.findIndex(c => parseInt(c.ID) === parseInt(id));
            
            if (index !== -1) {
                if (nuevosDatos.status) condiciones[index].Estado = nuevosDatos.status;
                if (nuevosDatos.repairedBy) condiciones[index].ReparadoPor = nuevosDatos.repairedBy;
                if (nuevosDatos.fechaReparacion) condiciones[index].FechaReparacion = nuevosDatos.fechaReparacion;
                
                condiciones[index].ultimaModificacion = obtenerTimestamp();
                condiciones[index].pendienteSincronizacion = true;
                localStorage.setItem('condiciones_pendientes', JSON.stringify(condiciones));
                return true;
            }
            return false;
        }
        
        // ==============================================
        // FUNCIONES DE ANÁLISIS Y GRÁFICOS MEJORADOS
        // ==============================================
        
        function generarAnalisis(tipo = 'risk') {
            if (!unsafeConditions.length) return null;
            
            let datos = {};
            
            switch(tipo) {
                case 'risk':
                    datos = unsafeConditions.reduce((acc, cond) => {
                        const riesgo = cond.Riesgo || 'sin definir';
                        acc[riesgo] = (acc[riesgo] || 0) + 1;
                        return acc;
                    }, {});
                    break;
                    
                case 'sector':
                    datos = unsafeConditions.reduce((acc, cond) => {
                        const sector = cond.Sector || 'sin sector';
                        acc[sector] = (acc[sector] || 0) + 1;
                        return acc;
                    }, {});
                    break;
                    
                case 'category':
                    datos = unsafeConditions.reduce((acc, cond) => {
                        const categoria = cond.Categoria || 'sin categoría';
                        acc[categoria] = (acc[categoria] || 0) + 1;
                        return acc;
                    }, {});
                    break;
                    
                case 'status':
                    datos = unsafeConditions.reduce((acc, cond) => {
                        const estado = cond.Estado || 'pendiente';
                        acc[estado] = (acc[estado] || 0) + 1;
                        return acc;
                    }, {});
                    break;
                    
                case 'evolution':
                    // Agrupar por mes
                    datos = unsafeConditions.reduce((acc, cond) => {
                        const fecha = new Date(cond.Fecha);
                        const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                        acc[mes] = (acc[mes] || 0) + 1;
                        return acc;
                    }, {});
                    break;
                    
                default:
                    datos = {};
            }
            
            return datos;
        }
        
        function crearGraficoAnalisis(tipo = 'risk') {
            const ctx = document.getElementById('data-chart');
            if (!ctx) return;
            
            if (dataChart) dataChart.destroy();
            
            const datos = generarAnalisis(tipo);
            if (!datos || Object.keys(datos).length === 0) {
                ctx.parentElement.innerHTML = '<p style="text-align: center; padding: 50px;">No hay datos para mostrar</p>';
                return;
            }
            
            const labels = Object.keys(datos);
            const values = Object.values(datos);
            
            let backgroundColor = [];
            let titulo = '';
            
            switch(tipo) {
                case 'risk':
                    backgroundColor = labels.map(label => CHART_COLORS.riesgo[label] || '#95a5a6');
                    titulo = 'Reportes por Nivel de Riesgo';
                    break;
                    
                case 'sector':
                    backgroundColor = CHART_COLORS.sector.slice(0, labels.length);
                    titulo = 'Reportes por Sector/Área';
                    break;
                    
                case 'category':
                    backgroundColor = CHART_COLORS.categoria.slice(0, labels.length);
                    titulo = 'Reportes por Tipo de Riesgo';
                    break;
                    
                case 'status':
                    backgroundColor = labels.map(label => CHART_COLORS.estado[label] || '#95a5a6');
                    titulo = 'Reportes por Estado';
                    break;
                    
                case 'evolution':
                    backgroundColor = CHART_COLORS.sector[0];
                    titulo = 'Evolución Temporal de Reportes';
                    break;
            }
            
            const chartType = tipo === 'evolution' ? 'line' : 'bar';
            
            dataChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Cantidad de reportes`,
                        data: values,
                        backgroundColor: chartType === 'bar' ? backgroundColor : undefined,
                        borderColor: tipo === 'evolution' ? CHART_COLORS.sector[0] : undefined,
                        fill: tipo === 'evolution',
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: titulo,
                            font: { 
                                size: 18,
                                weight: 'bold'
                            },
                            padding: 20
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                stepSize: 1,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12
                                },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        function crearGraficoSector() {
            const ctx = document.getElementById('sector-chart');
            if (!ctx) return;
            
            if (sectorChart) sectorChart.destroy();
            
            const datos = generarAnalisis('sector');
            if (!datos || Object.keys(datos).length === 0) {
                ctx.parentElement.innerHTML = '<p style="text-align: center; padding: 50px;">No hay datos para mostrar</p>';
                return;
            }
            
            const labels = Object.keys(datos);
            const values = Object.values(datos);
            
            sectorChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: CHART_COLORS.sector.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: 'Distribución por Sector',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
        
        function crearGraficoStatus() {
            const ctx = document.getElementById('status-chart');
            if (!ctx) return;
            
            if (statusChart) statusChart.destroy();
            
            const datos = generarAnalisis('status');
            if (!datos || Object.keys(datos).length === 0) {
                ctx.parentElement.innerHTML = '<p style="text-align: center; padding: 50px;">No hay datos para mostrar</p>';
                return;
            }
            
            const labels = Object.keys(datos);
            const values = Object.values(datos);
            const backgroundColors = labels.map(label => CHART_COLORS.estado[label] || '#95a5a6');
            
            statusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: 'Distribución por Estado',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }
        
        function crearGraficoEvolucion() {
            const ctx = document.getElementById('evolution-chart');
            if (!ctx) return;
            
            if (evolutionChart) evolutionChart.destroy();
            
            // Agrupar por mes los últimos 6 meses
            const ultimos6Meses = [];
            const hoy = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                ultimos6Meses.push(mes);
            }
            
            const datosPorMes = {};
            unsafeConditions.forEach(cond => {
                const fecha = new Date(cond.Fecha);
                const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                if (ultimos6Meses.includes(mes)) {
                    datosPorMes[mes] = (datosPorMes[mes] || 0) + 1;
                }
            });
            
            // Rellenar meses sin datos con 0
            const labels = ultimos6Meses.map(mes => {
                const [año, mesNum] = mes.split('-');
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                return `${meses[parseInt(mesNum) - 1]} ${año}`;
            });
            
            const values = ultimos6Meses.map(mes => datosPorMes[mes] || 0);
            
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reportes',
                        data: values,
                        borderColor: CHART_COLORS.sector[0],
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: CHART_COLORS.sector[0],
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        title: {
                            display: true,
                            text: 'Evolución Mensual de Reportes',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                stepSize: 1,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function crearGraficoDashboardRiesgo() {
            const ctx = document.getElementById('dashboard-risk-chart');
            if (!ctx) return;
            
            if (dashboardRiskChart) dashboardRiskChart.destroy();
            
            const datos = generarAnalisis('risk');
            if (!datos || Object.keys(datos).length === 0) return;
            
            const labels = Object.keys(datos);
            const values = Object.values(datos);
            const backgroundColor = labels.map(label => CHART_COLORS.riesgo[label] || '#95a5a6');
            
            dashboardRiskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: values,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        function crearGraficoDashboardSector() {
            const ctx = document.getElementById('dashboard-sector-chart');
            if (!ctx) return;
            
            if (dashboardSectorChart) dashboardSectorChart.destroy();
            
            const datos = generarAnalisis('sector');
            if (!datos || Object.keys(datos).length === 0) return;
            
            const labels = Object.keys(datos);
            const values = Object.values(datos);
            
            dashboardSectorChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: CHART_COLORS.sector.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        function crearGraficoFotos() {
            const ctx = document.getElementById('photos-chart');
            if (!ctx) return;
            
            if (photosChart) photosChart.destroy();
            
            const conFotos = unsafeConditions.filter(c => c.TieneFotos || (c.Fotos && c.Fotos.length > 0)).length;
            const sinFotos = unsafeConditions.length - conFotos;
            
            if (unsafeConditions.length === 0) {
                ctx.parentElement.innerHTML = '<p style="text-align: center; padding: 50px;">No hay datos para mostrar</p>';
                return;
            }
            
            photosChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Con Fotos', 'Sin Fotos'],
                    datasets: [{
                        data: [conFotos, sinFotos],
                        backgroundColor: ['#3498db', '#95a5a6'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'Reportes con Fotografías',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }
        
        function mostrarAnalisisDetallado() {
            const container = document.getElementById('analisis-detallado');
            if (!container) return;
            
            const total = unsafeConditions.length;
            const reparados = unsafeConditions.filter(c => c.Estado === 'reparado').length;
            const pendientes = unsafeConditions.filter(c => c.Estado === 'pendiente').length;
            const enProceso = unsafeConditions.filter(c => c.Estado === 'en proceso').length;
            const conFotos = unsafeConditions.filter(c => c.TieneFotos || (c.Fotos && c.Fotos.length > 0)).length;
            
            // Calcular tiempo promedio de reparación
            let tiempoPromedio = 'N/A';
            let repRapida = { dias: Infinity };
            let repLenta = { dias: 0 };
            
            const reparacionesCompletadas = unsafeConditions.filter(c => 
                c.Estado === 'reparado' && c.Fecha && c.FechaReparacion
            );
            
            if (reparacionesCompletadas.length > 0) {
                let totalDias = 0;
                
                reparacionesCompletadas.forEach(cond => {
                    const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
                    totalDias += tiempo.dias;
                    
                    if (tiempo.dias < repRapida.dias) {
                        repRapida = { ...cond, tiempo };
                    }
                    if (tiempo.dias > repLenta.dias) {
                        repLenta = { ...cond, tiempo };
                    }
                });
                
                const promedio = totalDias / reparacionesCompletadas.length;
                tiempoPromedio = promedio < 1 ? 
                    `${(promedio * 24).toFixed(1)} horas` : 
                    `${promedio.toFixed(1)} días`;
            }
            
            container.innerHTML = `
                <h3><i class="fas fa-chart-line"></i> Estadísticas Detalladas</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                        <h4><i class="fas fa-info-circle"></i> Resumen General</h4>
                        <p>Total reportes: <strong>${total}</strong></p>
                        <p>Reportes con fotos: <strong>${conFotos} (${total > 0 ? ((conFotos / total) * 100).toFixed(1) : 0}%)</strong></p>
                        <p>Tasa de reparación: <strong>${total > 0 ? ((reparados / total) * 100).toFixed(1) : 0}%</strong></p>
                        <p>Tiempo promedio: <strong>${tiempoPromedio}</strong></p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                        <h4><i class="fas fa-tachometer-alt"></i> Eficiencia</h4>
                        <p>Reparados: <strong>${reparados}</strong></p>
                        <p>En proceso: <strong>${enProceso}</strong></p>
                        <p>Pendientes: <strong>${pendientes}</strong></p>
                        <div style="margin-top: 10px; background: #e0e0e0; border-radius: 10px; height: 10px;">
                            <div style="width: ${total > 0 ? (reparados / total * 100) : 0}%; background: #2ecc71; height: 100%; border-radius: 10px;"></div>
                        </div>
                    </div>
                    
                    ${reparacionesCompletadas.length > 0 ? `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                        <h4><i class="fas fa-stopwatch"></i> Tiempos de Reparación</h4>
                        <p><strong>Más rápida:</strong> ${repRapida.tiempo?.texto || 'N/A'}</p>
                        <p><strong>Más lenta:</strong> ${repLenta.tiempo?.texto || 'N/A'}</p>
                        <p><strong>Promedio:</strong> ${tiempoPromedio}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function actualizarAnalisis() {
            const tipo = document.getElementById('analysis-type').value;
            crearGraficoAnalisis(tipo);
            crearGraficoSector();
            crearGraficoStatus();
            crearGraficoFotos();
            mostrarAnalisisDetallado();
        }
        
        // ==============================================
        // FUNCIONES DE INTERFAZ PRINCIPALES
        // ==============================================
        
        async function inicializarSistema() {
            showLoading(true, 'Inicializando sistema...');
            
            inicializarSupabase();
            
            unsafeConditions = await cargarCondicionesDesdeSupabase();
            
            actualizarEstadisticas();
            actualizarTablaReciente();
            actualizarTablaHistorial();
            crearGraficoEvolucion();
            crearGraficoDashboardRiesgo();
            crearGraficoDashboardSector();
            actualizarUIConfiguracion();
            actualizarContadoresFotos();
            
            showLoading(false);
            
            // Actualizar automáticamente cada 30 segundos
            setInterval(async () => {
                unsafeConditions = await cargarCondicionesDesdeSupabase();
                actualizarEstadisticas();
                actualizarTablaReciente();
                actualizarContadoresFotos();
            }, 30000);
        }
        
        function actualizarEstadisticas() {
            const total = unsafeConditions.length;
            const pendientes = unsafeConditions.filter(c => c.Estado === 'pendiente').length;
            const enProceso = unsafeConditions.filter(c => c.Estado === 'en proceso').length;
            const reparados = unsafeConditions.filter(c => c.Estado === 'reparado').length;
            
            // Calcular tiempo promedio
            const reparacionesCompletadas = unsafeConditions.filter(c => 
                c.Estado === 'reparado' && c.Fecha && c.FechaReparacion
            );
            
            let tiempoPromedio = '0 días';
            if (reparacionesCompletadas.length > 0) {
                const totalDias = reparacionesCompletadas.reduce((sum, cond) => {
                    const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
                    return sum + tiempo.dias;
                }, 0);
                
                const promedio = totalDias / reparacionesCompletadas.length;
                tiempoPromedio = promedio < 1 ? 
                    `${(promedio * 24).toFixed(1)} h` : 
                    `${promedio.toFixed(1)} días`;
            }
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('pending-count').textContent = pendientes;
            document.getElementById('process-count').textContent = enProceso;
            document.getElementById('repaired-count').textContent = reparados;
            document.getElementById('average-time').textContent = tiempoPromedio;
            
            if (document.getElementById('total-db-count')) {
                document.getElementById('total-db-count').textContent = total;
            }
        }
        
        function actualizarContadoresFotos() {
            const conFotos = unsafeConditions.filter(c => c.TieneFotos || (c.Fotos && c.Fotos.length > 0)).length;
            let totalFotos = 0;
            
            unsafeConditions.forEach(cond => {
                if (cond.Fotos) totalFotos += cond.Fotos.length;
                if (cond.FotosCorreccion) totalFotos += cond.FotosCorreccion.length;
            });
            
            if (document.getElementById('reports-with-photos')) {
                document.getElementById('reports-with-photos').textContent = conFotos;
            }
            
            if (document.getElementById('total-photos')) {
                document.getElementById('total-photos').textContent = totalFotos;
            }
        }
        
        function actualizarTablaReciente() {
            const tbody = document.querySelector('#recent-table tbody');
            if (!tbody) return;
            
            const recientes = [...unsafeConditions]
                .sort((a, b) => {
                    const modA = new Date(a.ultimaModificacion || a.Fecha);
                    const modB = new Date(b.ultimaModificacion || b.Fecha);
                    return modB - modA;
                })
                .slice(0, 8);
            
            if (recientes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>No hay reportes registrados</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = recientes.map((cond, index) => {
                const idVisual = cond.ID_secuencial || cond.ID || (index + 1);
                const descripcion = cond.Descripcion || 'Sin descripción';
                const sector = cond.Sector || 'Sin sector';
                const reportadoPor = cond.ReportadoPor || 'Anónimo';
                const fecha = cond.ultimaModificacion || cond.Fecha || 'N/A';
                const estado = cond.Estado || 'pendiente';
                
                let estadoBadge = '';
                if (estado === 'pendiente') {
                    estadoBadge = '<span class="status-badge status-pendiente">Pendiente</span>';
                } else if (estado === 'en proceso') {
                    estadoBadge = '<span class="status-badge status-en-proceso">En Proceso</span>';
                } else {
                    estadoBadge = '<span class="status-badge status-reparado">Reparado</span>';
                }
                
                const descCorta = descripcion.length > 50 
                    ? descripcion.substring(0, 50) + '...' 
                    : descripcion;
                
                // Mostrar icono de fotos
                const tieneFotos = cond.TieneFotos || (cond.Fotos && cond.Fotos.length > 0);
                const fotosHtml = tieneFotos 
                    ? `<i class="fas fa-camera" style="color: #3498db;" title="Tiene ${cond.Fotos?.length || 0} fotos"></i>` 
                    : `<i class="fas fa-times" style="color: #95a5a6;"></i>`;
                
                return `
                    <tr>
                        <td><strong>#${idVisual}</strong></td>
                        <td>${descCorta}</td>
                        <td>${sector}</td>
                        <td>${reportadoPor}</td>
                        <td>${formatDate(fecha)}</td>
                        <td>${estadoBadge}</td>
                        <td style="text-align: center;">${fotosHtml}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function actualizarTablaHistorial(filtro = 'all') {
            const tbody = document.querySelector('#history-table tbody');
            if (!tbody) return;
            
            let condicionesFiltradas = [...unsafeConditions];
            
            if (filtro !== 'all') {
                condicionesFiltradas = unsafeConditions.filter(c => 
                    (c.Estado || 'pendiente') === filtro
                );
            }
            
            condicionesFiltradas.sort((a, b) => {
                const fechaA = new Date(a.Fecha || a.ultimaModificacion);
                const fechaB = new Date(b.Fecha || b.ultimaModificacion);
                return fechaB - fechaA;
            });
            
            if (condicionesFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 50px; color: #7f8c8d;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>No hay reportes ${filtro !== 'all' ? `con estado "${filtro}"` : 'registrados'}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = condicionesFiltradas.map(cond => {
                const id = cond.ID_secuencial || cond.ID || 'N/A';
                const descripcion = cond.Descripcion || 'Sin descripción';
                const sector = cond.Sector || 'Sin sector';
                const ubicacion = cond.Ubicacion || 'Sin ubicación';
                const categoria = cond.Categoria || 'sin categoría';
                const riesgo = cond.Riesgo || 'sin definir';
                const fecha = cond.Fecha || 'N/A';
                const reportadoPor = cond.ReportadoPor || 'Anónimo';
                const reparadoPor = cond.ReparadoPor || '';
                const estado = cond.Estado || 'pendiente';
                const fotos = cond.Fotos || [];
                
                let estadoBadge = '';
                if (estado === 'pendiente') {
                    estadoBadge = '<span class="status-badge status-pendiente">Pendiente</span>';
                } else if (estado === 'en proceso') {
                    estadoBadge = '<span class="status-badge status-en-proceso">En Proceso</span>';
                } else {
                    estadoBadge = '<span class="status-badge status-reparado">Reparado</span>';
                }
                
                // Calcular tiempo de reparación
                let tiempoHTML = '';
                if (estado === 'reparado' && cond.Fecha && cond.FechaReparacion) {
                    const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
                    tiempoHTML = `<span class="${tiempo.clase}"><i class="fas fa-clock"></i> ${tiempo.texto}</span>`;
                } else if (estado === 'en proceso') {
                    const tiempo = calcularTiempoReparacion(cond.Fecha, new Date());
                    tiempoHTML = `<span class="tiempo-proceso"><i class="fas fa-hourglass-half"></i> ${tiempo.texto} en proceso</span>`;
                } else {
                    tiempoHTML = '<span style="color: #95a5a6;"><i class="fas fa-minus"></i> Pendiente</span>';
                }
                
                // Badge de riesgo con color
                let riesgoBadge = '';
                let riesgoColor = '';
                if (riesgo === 'critico') riesgoColor = '#e74c3c';
                else if (riesgo === 'alto') riesgoColor = '#e67e22';
                else if (riesgo === 'medio') riesgoColor = '#f1c40f';
                else if (riesgo === 'bajo') riesgoColor = '#2ecc71';
                
                if (riesgoColor) {
                    riesgoBadge = `<span style="background-color: ${riesgoColor}20; color: ${riesgoColor}; padding: 3px 8px; border-radius: 10px; border: 1px solid ${riesgoColor}40;">${riesgo}</span>`;
                }
                
                // Mostrar fotos
                const fotosHTML = mostrarFotosEnTabla(fotos);
                
                let acciones = '';
                if (estado === 'pendiente') {
                    acciones = `
                        <button class="action-btn btn-primary" onclick="cambiarEstado(${id}, 'en proceso')" title="Marcar como en proceso">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="action-btn btn-success" onclick="cambiarEstado(${id}, 'reparado')" title="Marcar como reparado">
                            <i class="fas fa-check"></i>
                        </button>
                    `;
                } else if (estado === 'en proceso') {
                    acciones = `
                        <button class="action-btn btn-success" onclick="cambiarEstado(${id}, 'reparado')" title="Marcar como reparado">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="action-btn btn-warning" onclick="cambiarEstado(${id}, 'pendiente')" title="Volver a pendiente">
                            <i class="fas fa-undo"></i>
                        </button>
                    `;
                } else {
                    acciones = `
                        <button class="action-btn btn-warning" onclick="cambiarEstado(${id}, 'pendiente')" title="Volver a pendiente">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="action-btn btn-primary" onclick="verFotosCorreccion(${id})" title="Ver fotos de corrección">
                            <i class="fas fa-camera"></i>
                        </button>
                    `;
                }
                
                return `
                    <tr>
                        <td><strong>#${id}</strong></td>
                        <td title="${descripcion}">${descripcion.length > 60 ? descripcion.substring(0, 60) + '...' : descripcion}</td>
                        <td>${sector}</td>
                        <td>${ubicacion}</td>
                        <td>${categoria}</td>
                        <td>${riesgoBadge}</td>
                        <td>${fotosHTML}</td>
                        <td>${formatDate(fecha)}</td>
                        <td>${tiempoHTML}</td>
                        <td>${reportadoPor}</td>
                        <td>${estadoBadge}</td>
                        <td class="actions">${acciones}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function guardarNuevoReporte(event) {
            event.preventDefault();
            
            const reporte = {
                reportedBy: document.getElementById('reporter-name').value.trim(),
                description: document.getElementById('description').value.trim(),
                sector: document.getElementById('sector').value,
                location: document.getElementById('ubicacion-especifica').value.trim(),
                category: document.getElementById('category').value,
                riskLevel: document.getElementById('risk-level').value,
                observaciones: document.getElementById('observaciones').value.trim()
            };
            
            if (!reporte.reportedBy || !reporte.description || !reporte.sector || 
                !reporte.location || !reporte.category || !reporte.riskLevel) {
                alert('❌ Por favor complete todos los campos obligatorios (*)');
                return;
            }
            
            const resultado = await guardarCondicionEnSupabase(reporte);
            
            if (resultado.success) {
                unsafeConditions = await cargarCondicionesDesdeSupabase();
                
                if (resultado.offline) {
                    alert('⚠️ Modo offline\nReporte guardado localmente\nSe sincronizará cuando haya conexión');
                } else {
                    alert(`✅ Reporte guardado exitosamente\nID: #${resultado.id}`);
                }
                
                document.getElementById('report-form').reset();
                
                actualizarEstadisticas();
                actualizarTablaReciente();
                actualizarTablaHistorial(currentFilter);
                crearGraficoEvolucion();
                crearGraficoDashboardRiesgo();
                crearGraficoDashboardSector();
                actualizarContadoresFotos();
                
                document.querySelector('.nav-menu a[data-page="dashboard"]').click();
            } else {
                alert('❌ Error guardando el reporte');
            }
        }
        
        async function cambiarEstado(id, nuevoEstado) {
            const condicion = unsafeConditions.find(c => {
                const condId = parseInt(c.ID_secuencial || c.ID || 0);
                return condId === parseInt(id);
            });
            
            if (!condicion) {
                alert('Reporte no encontrado');
                return;
            }
            
            let uploadCorrectionPhoto = false;
            if (nuevoEstado === 'reparado') {
                const confirmar = confirm('¿Desea agregar una foto de la corrección realizada?');
                if (confirmar) {
                    uploadCorrectionPhoto = true;
                }
            }
            
            const nuevosDatos = { 
                status: nuevoEstado,
                fechaReparacion: nuevoEstado === 'reparado' ? new Date().toISOString() : undefined,
                uploadCorrectionPhoto: uploadCorrectionPhoto
            };
            
            if (nuevoEstado === 'reparado') {
                const reparador = prompt('Ingrese su nombre (quién realiza la reparación):');
                nuevosDatos.repairedBy = reparador && reparador.trim() ? reparador.trim() : 'Técnico no identificado';
            }
            
            const resultado = await actualizarEstadoEnSupabase(id, nuevosDatos);
            
            // Actualizar localmente
            condicion.Estado = nuevoEstado;
            condicion.ultimaModificacion = obtenerTimestamp();
            
            if (nuevosDatos.repairedBy) {
                condicion.ReparadoPor = nuevosDatos.repairedBy;
                condicion.FechaReparacion = nuevosDatos.fechaReparacion;
            }
            
            if (resultado.offline) {
                actualizarEnLocalStorage(id, nuevosDatos);
            }
            
            actualizarEstadisticas();
            actualizarTablaReciente();
            actualizarTablaHistorial(currentFilter);
            crearGraficoEvolucion();
            crearGraficoDashboardRiesgo();
            crearGraficoDashboardSector();
            actualizarContadoresFotos();
            
            alert(resultado.offline ? 'Estado actualizado (modo offline)' : 'Estado actualizado correctamente');
        }
        
        function verFotosCorreccion(id) {
            const condicion = unsafeConditions.find(c => {
                const condId = parseInt(c.ID_secuencial || c.ID || 0);
                return condId === parseInt(id);
            });
            
            if (!condicion) {
                alert('Reporte no encontrado');
                return;
            }
            
            const fotosCorreccion = condicion.FotosCorreccion || [];
            if (fotosCorreccion.length === 0) {
                alert('No hay fotos de corrección para este reporte');
                return;
            }
            
            // Mostrar primera foto en modal
            mostrarModalFoto(fotosCorreccion[0], 'Foto de corrección');
        }
        
        function forzarActualizacion() {
            unsafeConditions = [...unsafeConditions].sort((a, b) => {
                return new Date(b.ultimaModificacion || b.Fecha) - new Date(a.ultimaModificacion || a.Fecha);
            });
            
            actualizarTablaReciente();
            actualizarEstadisticas();
            
            const status = document.getElementById('status-indicator');
            const originalText = status.innerHTML;
            status.innerHTML = '<i class="fas fa-check-circle"></i> <span>Actualizado</span>';
            status.style.backgroundColor = '#2ecc71';
            
            setTimeout(() => {
                status.innerHTML = originalText;
                status.style.backgroundColor = '';
            }, 2000);
        }
        
        function mostrarEjemplo() {
            document.getElementById('reporter-name').value = 'Juan Pérez Rodríguez';
            document.getElementById('description').value = 'Cable eléctrico expuesto y pelado en el panel de control de la línea 3. Presenta riesgo de electrocución para el personal de mantenimiento.';
            document.getElementById('sector').value = 'produccion';
            document.getElementById('ubicacion-especifica').value = 'Línea 3, Estación 5, Panel de control principal';
            document.getElementById('category').value = 'electrico';
            document.getElementById('risk-level').value = 'critico';
            document.getElementById('observaciones').value = 'Se requiere intervención inmediata del área de mantenimiento eléctrico. Aislar el área hasta la reparación.';
            
            limpiarFotos();
        }
        
        function exportarHistorial() {
            const condiciones = [...unsafeConditions];
            let csv = 'ID,Descripción,Sector,Ubicación,Tipo Riesgo,Nivel Riesgo,Fecha Reporte,Estado,Reportado por,Reparado por,Tiempo Reparación,Fotos\n';
            
            condiciones.forEach(cond => {
                const tiempo = cond.Estado === 'reparado' && cond.Fecha && cond.FechaReparacion 
                    ? calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion).texto 
                    : 'Pendiente';
                
                const tieneFotos = cond.TieneFotos || (cond.Fotos && cond.Fotos.length > 0) ? 'Sí' : 'No';
                
                csv += `"${cond.ID_secuencial || cond.ID}","${cond.Descripcion || ''}","${cond.Sector || ''}","${cond.Ubicacion || ''}","${cond.Categoria || ''}","${cond.Riesgo || ''}","${cond.Fecha || ''}","${cond.Estado || ''}","${cond.ReportadoPor || ''}","${cond.ReparadoPor || ''}","${tiempo}","${tieneFotos}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `condiciones_inseguras_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function actualizarUIConfiguracion() {
            if (document.getElementById('current-url')) {
                document.getElementById('current-url').value = CONFIG.supabaseUrl || 'No configurado';
            }
            if (document.getElementById('current-key')) {
                const key = CONFIG.supabaseKey || '';
                document.getElementById('current-key').value = key ? 
                    key.substring(0, 20) + '...' : 'No configurado';
            }
            if (document.getElementById('last-sync')) {
                document.getElementById('last-sync').textContent = CONFIG.lastSync;
            }
            if (document.getElementById('current-mode')) {
                document.getElementById('current-mode').textContent = 
                    CONFIG.offlineMode ? 'Modo Offline' : 'Modo Online';
            }
        }
        
        function probarConexion() {
            probarConexionSupabase().then(success => {
                if (success) {
                    alert('✅ Conexión exitosa con Supabase');
                } else {
                    alert('❌ Error de conexión. Verifica la configuración.');
                }
                actualizarUIConfiguracion();
            });
        }
        
        function limpiarDatos() {
            if (confirm('¿Estás seguro de que quieres limpiar todos los datos locales?\n\nEsto solo borra los datos en tu navegador, no en la base de datos.')) {
                localStorage.removeItem('condiciones_pendientes');
                alert('✅ Datos locales eliminados. Recargando...');
                location.reload();
            }
        }
        
        function generarDatosPrueba() {
            if (unsafeConditions.length > 0 && !confirm('Ya existen datos. ¿Desea agregar datos de prueba adicionales?')) {
                return;
            }
            
            const datosPrueba = [
                {
                    ID: 1001,
                    ID_secuencial: 1001,
                    Fecha: '2024-01-15',
                    ReportadoPor: 'Carlos Mendoza',
                    Descripcion: 'Extintor vencido en pasillo principal del área de producción',
                    Sector: 'produccion',
                    Ubicacion: 'Pasillo principal, área de producción',
                    Categoria: 'incendio',
                    Riesgo: 'critico',
                    Estado: 'pendiente',
                    TieneFotos: true,
                    Fotos: ['https://via.placeholder.com/150/FF0000/FFFFFF?text=Extintor+Vencido'],
                    ultimaModificacion: '2024-01-15T08:30:00'
                },
                {
                    ID: 1002,
                    ID_secuencial: 1002,
                    Fecha: '2024-01-10',
                    FechaReparacion: '2024-01-12',
                    ReportadoPor: 'Ana López',
                    Descripcion: 'Piso resbaladizo por aceite derramado en taller',
                    Sector: 'mantenimiento',
                    Ubicacion: 'Taller de mantenimiento, zona de máquinas',
                    Categoria: 'mecanico',
                    Riesgo: 'alto',
                    Estado: 'reparado',
                    ReparadoPor: 'José Ramírez',
                    TieneFotos: true,
                    Fotos: ['https://via.placeholder.com/150/FFA500/FFFFFF?text=Aceite+Derramado'],
                    FotosCorreccion: ['https://via.placeholder.com/150/008000/FFFFFF?text=Piso+Limpio'],
                    ultimaModificacion: '2024-01-12T14:20:00'
                },
                {
                    ID: 1003,
                    ID_secuencial: 1003,
                    Fecha: '2024-01-05',
                    ReportadoPor: 'Roberto Sánchez',
                    Descripcion: 'Falta de barandas de protección en plataforma elevada',
                    Sector: 'almacen',
                    Ubicacion: 'Plataforma de carga, almacén principal',
                    Categoria: 'alturas',
                    Riesgo: 'alto',
                    Estado: 'en proceso',
                    TieneFotos: true,
                    Fotos: ['https://via.placeholder.com/150/FFA500/FFFFFF?text=Sin+Barandas'],
                    ultimaModificacion: '2024-01-08T10:15:00'
                },
                {
                    ID: 1004,
                    ID_secuencial: 1004,
                    Fecha: '2023-12-20',
                    FechaReparacion: '2023-12-21',
                    ReportadoPor: 'María González',
                    Descripcion: 'Conexión eléctrica sin protección en oficinas',
                    Sector: 'oficinas',
                    Ubicacion: 'Oficina 203, segundo piso',
                    Categoria: 'electrico',
                    Riesgo: 'medio',
                    Estado: 'reparado',
                    ReparadoPor: 'Juan Electricista',
                    TieneFotos: false,
                    ultimaModificacion: '2023-12-21T16:45:00'
                },
                {
                    ID: 1005,
                    ID_secuencial: 1005,
                    Fecha: '2023-12-15',
                    ReportadoPor: 'Pedro Martínez',
                    Descripcion: 'Ventilación inadecuada en laboratorio químico',
                    Sector: 'laboratorio',
                    Ubicacion: 'Laboratorio de análisis químico',
                    Categoria: 'quimico',
                    Riesgo: 'alto',
                    Estado: 'pendiente',
                    TieneFotos: true,
                    Fotos: ['https://via.placeholder.com/150/FF0000/FFFFFF?text=Ventilacion+Mala', 'https://via.placeholder.com/150/FFA500/FFFFFF?text=Extractor+Dañado'],
                    ultimaModificacion: '2023-12-15T09:30:00'
                }
            ];
            
            unsafeConditions = [...datosPrueba, ...unsafeConditions];
            actualizarEstadisticas();
            actualizarTablaReciente();
            actualizarTablaHistorial();
            crearGraficoEvolucion();
            crearGraficoDashboardRiesgo();
            crearGraficoDashboardSector();
            actualizarContadoresFotos();
            
            alert(`✅ ${datosPrueba.length} datos de prueba agregados`);
        }
        
        // ==============================================
        // INICIALIZACIÓN Y EVENT LISTENERS
        // ==============================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            await inicializarSistema();
            
            const form = document.getElementById('report-form');
            if (form) {
                form.addEventListener('submit', guardarNuevoReporte);
            }
            
            const navLinks = document.querySelectorAll('.nav-menu a');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.page').forEach(page => {
                        page.style.display = 'none';
                    });
                    
                    document.getElementById(`${pageId}-page`).style.display = 'block';
                    
                    if (pageId === 'analisis') {
                        setTimeout(() => {
                            actualizarAnalisis();
                        }, 100);
                    }
                    
                    if (pageId !== 'config') {
                        document.getElementById('supabase-config-panel').style.display = 'none';
                    }
                });
            });
            
            document.getElementById('filter-all').addEventListener('click', () => {
                currentFilter = 'all';
                actualizarTablaHistorial('all');
            });
            document.getElementById('filter-pending').addEventListener('click', () => {
                currentFilter = 'pendiente';
                actualizarTablaHistorial('pendiente');
            });
            document.getElementById('filter-process').addEventListener('click', () => {
                currentFilter = 'en proceso';
                actualizarTablaHistorial('en proceso');
            });
            document.getElementById('filter-repaired').addEventListener('click', () => {
                currentFilter = 'reparado';
                actualizarTablaHistorial('reparado');
            });
            
            document.getElementById('search-input').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const tbody = document.querySelector('#history-table tbody');
                
                if (!tbody) return;
                
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
            
            document.getElementById('analysis-type').addEventListener('change', function() {
                crearGraficoAnalisis(this.value);
            });
            
            // Permitir arrastrar y soltar fotos
            const uploadContainer = document.querySelector('.photo-upload-container');
            if (uploadContainer) {
                uploadContainer.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#2980b9';
                    this.style.backgroundColor = '#e3f2fd';
                });
                
                uploadContainer.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#3498db';
                    this.style.backgroundColor = '#f8f9fa';
                });
                
                uploadContainer.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#3498db';
                    this.style.backgroundColor = '#f8f9fa';
                    
                    const files = e.dataTransfer.files;
                    const input = document.getElementById('photos-input');
                    
                    // Crear un DataTransfer para asignar los archivos
                    const dataTransfer = new DataTransfer();
                    for (let file of files) {
                        dataTransfer.items.add(file);
                    }
                    input.files = dataTransfer.files;
                    
                    // Disparar el evento change
                    const event = new Event('change', { bubbles: true });
                    input.dispatchEvent(event);
                });
            }
        });
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalFoto();
            }
        });
        
        // ==============================================
        // FUNCIONES GLOBALES
        // ==============================================
        window.cambiarEstado = cambiarEstado;
        window.mostrarConfigPanel = mostrarConfigPanel;
        window.probarConexion = probarConexion;
        window.limpiarDatos = limpiarDatos;
        window.guardarConfigSupabase = guardarConfigSupabase;
        window.forzarActualizacion = forzarActualizacion;
        window.mostrarEjemplo = mostrarEjemplo;
        window.exportarHistorial = exportarHistorial;
        window.generarDatosPrueba = generarDatosPrueba;
        window.actualizarAnalisis = actualizarAnalisis;
        window.mostrarModalFoto = mostrarModalFoto;
        window.cerrarModalFoto = cerrarModalFoto;
        window.removePhoto = removePhoto;
        window.limpiarFotos = limpiarFotos;
        window.mostrarReporteConFotos = mostrarReporteConFotos;
        window.verFotosCorreccion = verFotosCorreccion;
        
    </script>
</body>
</html>
