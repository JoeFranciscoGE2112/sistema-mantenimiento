<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DANEC - Gestión de Seguridad Industrial</title>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
        }
        
        .sidebar {
            background-color: var(--primary-color);
            min-height: 100vh;
            color: white;
            position: fixed;
            width: 250px;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .nav-link {
            color: #ecf0f1;
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .btn-report {
            background-color: var(--danger-color);
            color: white;
            padding: 10px 25px;
            border-radius: 5px;
            border: none;
            font-weight: bold;
        }
        
        .btn-report:hover {
            background-color: #c0392b;
            color: white;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                min-height: auto;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column">
        <div class="p-4">
            <h3 class="text-center">
                <i class="fas fa-shield-alt me-2"></i>
                DANEC
            </h3>
            <p class="text-center text-muted">Gestión de Seguridad Industrial</p>
        </div>
        
        <div class="px-3 mb-3">
            <div class="input-group">
                <span class="input-group-text bg-dark border-dark">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control bg-dark border-dark text-white" 
                       placeholder="Buscar..." id="searchInput">
            </div>
        </div>
        
        <nav class="flex-grow-1">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-tab="dashboard">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="nuevo-reporte">
                        <i class="fas fa-plus-circle me-2"></i> Nuevo Reporte
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="historial">
                        <i class="fas fa-history me-2"></i> Historial
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="pendientes">
                        <i class="fas fa-clock me-2"></i> Pendientes
                        <span class="badge bg-danger float-end" id="pendientesBadge">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="calendario">
                        <i class="fas fa-calendar-alt me-2"></i> Calendario
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="analisis">
                        <i class="fas fa-chart-bar me-2"></i> Análisis
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="configuracion">
                        <i class="fas fa-cog me-2"></i> Configuración
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="p-3 border-top border-secondary">
            <div class="system-status">
                <p class="mb-1">
                    <i class="fas fa-circle text-success me-2"></i>
                    <span id="dbStatus">Conectando...</span>
                </p>
                <p class="mb-1 small text-muted" id="lastSync">Última sincronización: -</p>
                <p class="mb-1 small text-muted">Versión: 6.0.0</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Tab (Default) -->
        <div id="dashboardTab" class="tab-content active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Dashboard</h2>
                <button class="btn btn-report" id="newReportBtn">
                    <i class="fas fa-plus me-2"></i> Nuevo Reporte
                </button>
            </div>
            
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card stat-card bg-primary text-white">
                        <i class="fas fa-file-alt fa-2x"></i>
                        <h3 class="stat-number" id="totalReports">0</h3>
                        <p>Total Reportes</p>
                        <small id="monthlyChange">↑ 12% este mes</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-warning text-dark">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <h3 class="stat-number" id="pendingCount">0</h3>
                        <p>Pendientes</p>
                        <small>Atención</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-info text-white">
                        <i class="fas fa-sync-alt fa-2x"></i>
                        <h3 class="stat-number" id="inProgressCount">0</h3>
                        <p>En Proceso</p>
                        <small id="inProgressChange">↑ 5% hoy</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card bg-success text-white">
                        <i class="fas fa-check-circle fa-2x"></i>
                        <h3 class="stat-number" id="repairedCount">0</h3>
                        <p>Reparados</p>
                        <small id="repairSpeed">↓ 20% más rápido</small>
                    </div>
                </div>
            </div>
            
            <!-- Second Row -->
            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Evolución Temporal</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="timeChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Vencen Pronto</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group" id="expiringList">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    No hay reportes por vencer
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0">Últimos 30 días</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="monthChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nuevo Reporte Tab -->
        <div id="nuevoReporteTab" class="tab-content" style="display: none;">
            <h2 class="mb-4">Nuevo Reporte</h2>
            <div class="card">
                <div class="card-body">
                    <form id="reportForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="reportTitle" class="form-label">Título del Reporte</label>
                                    <input type="text" class="form-control" id="reportTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="reportType" class="form-label">Tipo de Condición Insegura</label>
                                    <select class="form-select" id="reportType" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="electrico">Riesgo Eléctrico</option>
                                        <option value="mecanico">Riesgo Mecánico</option>
                                        <option value="alturas">Trabajo en Alturas</option>
                                        <option value="quimico">Manejo de Químicos</option>
                                        <option value="incendio">Riesgo de Incendio</option>
                                        <option value="otros">Otros</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="reportLocation" class="form-label">Ubicación</label>
                                    <input type="text" class="form-control" id="reportLocation" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="reportPriority" class="form-label">Prioridad</label>
                                    <select class="form-select" id="reportPriority" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="alta">Alta</option>
                                        <option value="media">Media</option>
                                        <option value="baja">Baja</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="reportDueDate" class="form-label">Fecha Límite</label>
                                    <input type="date" class="form-control" id="reportDueDate" required>
                                </div>
                                <div class="mb-3">
                                    <label for="reportResponsible" class="form-label">Responsable</label>
                                    <input type="text" class="form-control" id="reportResponsible" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reportDescription" class="form-label">Descripción Detallada</label>
                            <textarea class="form-control" id="reportDescription" rows="4" required></textarea>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" id="cancelReport">Cancelar</button>
                            <button type="submit" class="btn btn-report">
                                <i class="fas fa-save me-2"></i> Guardar Reporte
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Historial Tab -->
        <div id="historialTab" class="tab-content" style="display: none;">
            <h2 class="mb-4">Historial de Reportes</h2>
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="reportsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Título</th>
                                    <th>Tipo</th>
                                    <th>Ubicación</th>
                                    <th>Prioridad</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody">
                                <!-- Los reportes se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pendientes Tab -->
        <div id="pendientesTab" class="tab-content" style="display: none;">
            <h2 class="mb-4">Reportes Pendientes</h2>
            <div id="pendingReportsContainer">
                <!-- Los reportes pendientes se cargarán aquí -->
            </div>
        </div>

        <!-- Configuración Tab -->
        <div id="configuracionTab" class="tab-content" style="display: none;">
            <h2 class="mb-4">Configuración</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Configuración de Supabase</h5>
                    <div class="mb-3">
                        <label for="supabaseUrl" class="form-label">URL de Supabase</label>
                        <input type="text" class="form-control" id="supabaseUrl" 
                               placeholder="https://tu-proyecto.supabase.co">
                    </div>
                    <div class="mb-3">
                        <label for="supabaseKey" class="form-label">API Key</label>
                        <input type="password" class="form-control" id="supabaseKey" 
                               placeholder="tu-anon-key">
                    </div>
                    <button class="btn btn-primary" id="saveConfig">
                        <i class="fas fa-save me-2"></i> Guardar Configuración
                    </button>
                    <button class="btn btn-secondary" id="testConnection">
                        <i class="fas fa-plug me-2"></i> Probar Conexión
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- JavaScript Principal -->
    <script>
        // Configuración inicial
        const CONFIG = {
            supabaseUrl: localStorage.getItem('supabaseUrl') || '',
            supabaseKey: localStorage.getItem('supabaseKey') || ''
        };

        // Inicializar Supabase
        let supabase = null;
        if (CONFIG.supabaseUrl && CONFIG.supabaseKey) {
            supabase = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
        }

        // Datos de ejemplo (para cuando no hay conexión a Supabase)
        let reportsData = [];

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkDatabaseConnection();
            loadReports();
        });

        function initializeApp() {
            updateStats();
            setupCharts();
        }

        function setupEventListeners() {
            // Navegación entre pestañas
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                    
                    // Actualizar clase activa
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Botón nuevo reporte en dashboard
            document.getElementById('newReportBtn').addEventListener('click', function() {
                switchTab('nuevo-reporte');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-tab="nuevo-reporte"]').classList.add('active');
            });

            // Formulario de nuevo reporte
            document.getElementById('reportForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveNewReport();
            });

            // Cancelar reporte
            document.getElementById('cancelReport').addEventListener('click', function() {
                document.getElementById('reportForm').reset();
                switchTab('dashboard');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-tab="dashboard"]').classList.add('active');
            });

            // Guardar configuración
            document.getElementById('saveConfig').addEventListener('click', saveConfiguration);
            document.getElementById('testConnection').addEventListener('click', testConnection);

            // Cargar configuración guardada
            if (CONFIG.supabaseUrl) {
                document.getElementById('supabaseUrl').value = CONFIG.supabaseUrl;
            }
            if (CONFIG.supabaseKey) {
                document.getElementById('supabaseKey').value = CONFIG.supabaseKey;
            }

            // Buscar
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                searchReports(searchTerm);
            });
        }

        function switchTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Mostrar la pestaña seleccionada
            const tabId = tabName + 'Tab';
            const tabElement = document.getElementById(tabId);
            if (tabElement) {
                tabElement.style.display = 'block';
                
                // Cargar datos específicos de la pestaña
                if (tabName === 'historial') {
                    loadReportsTable();
                } else if (tabName === 'pendientes') {
                    loadPendingReports();
                }
            }
        }

        async function checkDatabaseConnection() {
            const statusElement = document.getElementById('dbStatus');
            const syncElement = document.getElementById('lastSync');
            
            if (supabase) {
                try {
                    // Intentar una consulta simple
                    const { data, error } = await supabase
                        .from('reports')
                        .select('count')
                        .limit(1);
                    
                    if (error) throw error;
                    
                    statusElement.innerHTML = '<i class="fas fa-circle text-success me-2"></i> Conectado a: Supabase';
                    syncElement.textContent = `Última sincronización: ${new Date().toLocaleTimeString()}`;
                } catch (error) {
                    statusElement.innerHTML = '<i class="fas fa-circle text-danger me-2"></i> Error de conexión';
                    console.error('Error de conexión:', error);
                }
            } else {
                statusElement.innerHTML = '<i class="fas fa-circle text-warning me-2"></i> Sin configuración';
            }
        }

        async function loadReports() {
            if (supabase) {
                try {
                    const { data, error } = await supabase
                        .from('reports')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    reportsData = data || [];
                } catch (error) {
                    console.error('Error cargando reportes:', error);
                    // Usar datos de ejemplo si hay error
                    reportsData = getSampleData();
                }
            } else {
                reportsData = getSampleData();
            }
            
            updateStats();
            updateCharts();
        }

        function getSampleData() {
            return [
                {
                    id: 1,
                    title: "Cableado expuesto en área de producción",
                    type: "electrico",
                    location: "Área de Producción A",
                    priority: "alta",
                    status: "pendiente",
                    description: "Cableado eléctrico expuesto que representa riesgo de electrocución",
                    due_date: "2024-01-30",
                    responsible: "Juan Pérez",
                    created_at: "2024-01-15"
                },
                {
                    id: 2,
                    title: "Equipo de protección dañado",
                    type: "mecanico",
                    location: "Almacén",
                    priority: "media",
                    status: "en_proceso",
                    description: "Casco de seguridad con grietas",
                    due_date: "2024-02-10",
                    responsible: "María García",
                    created_at: "2024-01-10"
                },
                {
                    id: 3,
                    title: "Piso resbaladizo en pasillo principal",
                    type: "otros",
                    location: "Pasillo Principal",
                    priority: "alta",
                    status: "reparado",
                    description: "Derrame de aceite no limpiado adecuadamente",
                    due_date: "2024-01-20",
                    responsible: "Carlos López",
                    created_at: "2024-01-05"
                }
            ];
        }

        async function saveNewReport() {
            const reportData = {
                title: document.getElementById('reportTitle').value,
                type: document.getElementById('reportType').value,
                location: document.getElementById('reportLocation').value,
                priority: document.getElementById('reportPriority').value,
                status: 'pendiente',
                description: document.getElementById('reportDescription').value,
                due_date: document.getElementById('reportDueDate').value,
                responsible: document.getElementById('reportResponsible').value,
                created_at: new Date().toISOString()
            };

            if (supabase) {
                try {
                    const { data, error } = await supabase
                        .from('reports')
                        .insert([reportData]);
                    
                    if (error) throw error;
                    
                    alert('Reporte guardado exitosamente!');
                    document.getElementById('reportForm').reset();
                    switchTab('dashboard');
                    loadReports();
                } catch (error) {
                    console.error('Error guardando reporte:', error);
                    alert('Error al guardar el reporte: ' + error.message);
                }
            } else {
                // Guardar localmente
                reportData.id = reportsData.length + 1;
                reportsData.unshift(reportData);
                alert('Reporte guardado localmente (modo offline)');
                document.getElementById('reportForm').reset();
                switchTab('dashboard');
                updateStats();
                updateCharts();
            }
        }

        function updateStats() {
            const total = reportsData.length;
            const pending = reportsData.filter(r => r.status === 'pendiente').length;
            const inProgress = reportsData.filter(r => r.status === 'en_proceso').length;
            const repaired = reportsData.filter(r => r.status === 'reparado').length;

            document.getElementById('totalReports').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('repairedCount').textContent = repaired;

            // Actualizar badge de pendientes
            document.getElementById('pendientesBadge').textContent = pending;

            // Calcular tiempo promedio (simulado)
            const avgTime = total > 0 ? Math.floor(Math.random() * 24) : 0;
            document.getElementById('avgTime').textContent = `${avgTime}h`;
        }

        function loadReportsTable() {
            const tbody = document.getElementById('reportsTableBody');
            tbody.innerHTML = '';
            
            reportsData.forEach(report => {
                const statusBadge = getStatusBadge(report.status);
                const priorityBadge = getPriorityBadge(report.priority);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${report.id}</td>
                    <td>${report.title}</td>
                    <td>${getTypeLabel(report.type)}</td>
                    <td>${report.location}</td>
                    <td>${priorityBadge}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(report.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewReport(${report.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadPendingReports() {
            const container = document.getElementById('pendingReportsContainer');
            const pendingReports = reportsData.filter(r => r.status === 'pendiente');
            
            if (pendingReports.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        No hay reportes pendientes.
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row">';
            pendingReports.forEach(report => {
                const daysLeft = Math.ceil((new Date(report.due_date) - new Date()) / (1000 * 60 * 60 * 24));
                let daysClass = 'success';
                if (daysLeft < 3) daysClass = 'danger';
                else if (daysLeft < 7) daysClass = 'warning';
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${report.title}</h5>
                                <p class="card-text">${report.description.substring(0, 100)}...</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-${getPriorityColor(report.priority)}">
                                        ${report.priority.toUpperCase()}
                                    </span>
                                    <span class="badge bg-${daysClass}">
                                        ${daysLeft} días restantes
                                    </span>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-map-marker-alt me-1"></i> ${report.location}
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-user me-1"></i> ${report.responsible}
                                    </small>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-success" onclick="updateStatus(${report.id}, 'en_proceso')">
                                        <i class="fas fa-play me-1"></i> Iniciar
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="viewReport(${report.id})">
                                        <i class="fas fa-eye me-1"></i> Ver
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function getStatusBadge(status) {
            const badges = {
                'pendiente': '<span class="badge bg-warning">Pendiente</span>',
                'en_proceso': '<span class="badge bg-info">En Proceso</span>',
                'reparado': '<span class="badge bg-success">Reparado</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">Desconocido</span>';
        }

        function getPriorityBadge(priority) {
            const colors = {
                'alta': 'danger',
                'media': 'warning',
                'baja': 'success'
            };
            return `<span class="badge bg-${colors[priority] || 'secondary'}">${priority.toUpperCase()}</span>`;
        }

        function getPriorityColor(priority) {
            const colors = {
                'alta': 'danger',
                'media': 'warning',
                'baja': 'success'
            };
            return colors[priority] || 'secondary';
        }

        function getTypeLabel(type) {
            const labels = {
                'electrico': 'Eléctrico',
                'mecanico': 'Mecánico',
                'alturas': 'Alturas',
                'quimico': 'Químico',
                'incendio': 'Incendio',
                'otros': 'Otros'
            };
            return labels[type] || type;
        }

        function setupCharts() {
            // Gráfico de evolución temporal
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            window.timeChart = new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Reportes',
                        data: [12, 19, 8, 15, 12, 18],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Gráfico de últimos 30 días
            const monthCtx = document.getElementById('monthChart').getContext('2d');
            window.monthChart = new Chart(monthCtx, {
                type: 'bar',
                data: {
                    labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                    datasets: [{
                        label: 'Reportes',
                        data: [5, 8, 12, 7],
                        backgroundColor: [
                            '#e74c3c',
                            '#f39c12',
                            '#3498db',
                            '#2ecc71'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateCharts() {
            // Aquí puedes actualizar los gráficos con datos reales
            // Por ahora usamos datos de ejemplo
        }

        function saveConfiguration() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                alert('Por favor, ingresa la URL y la API Key de Supabase');
                return;
            }
            
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            
            CONFIG.supabaseUrl = url;
            CONFIG.supabaseKey = key;
            
            // Recrear el cliente Supabase
            supabase = window.supabase.createClient(url, key);
            
            alert('Configuración guardada correctamente');
            checkDatabaseConnection();
            loadReports();
        }

        async function testConnection() {
            if (!supabase) {
                alert('Primero guarda la configuración');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('reports')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                alert('¡Conexión exitosa a Supabase!');
            } catch (error) {
                alert('Error de conexión: ' + error.message);
            }
        }

        function searchReports(term) {
            // Implementar búsqueda según la pestaña activa
            console.log('Buscando:', term);
        }

        // Funciones globales para usar en los botones
        window.viewReport = function(id) {
            const report = reportsData.find(r => r.id === id);
            if (report) {
                alert(`Reporte: ${report.title}\n\nDescripción: ${report.description}\n\nEstado: ${report.status}\n\nResponsable: ${report.responsible}`);
            }
        };

        window.updateStatus = async function(id, newStatus) {
            const report = reportsData.find(r => r.id === id);
            if (report) {
                report.status = newStatus;
                
                if (supabase) {
                    try {
                        const { error } = await supabase
                            .from('reports')
                            .update({ status: newStatus })
                            .eq('id', id);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error actualizando estado:', error);
                    }
                }
                
                alert(`Estado actualizado a: ${newStatus}`);
                loadReports();
                if (document.getElementById('pendientesTab').style.display !== 'none') {
                    loadPendingReports();
                }
            }
        };
    </script>
</body>
</html>
