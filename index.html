<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Condiciones Inseguras - Danec</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        /* ===== ESTILOS BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #dc2c3c;    /* Rojo Danec */
            --secondary: #2c3e50;  /* Gris oscuro */
            --accent: #f39c12;     /* Naranja */
            --danger: #e74c3c;     /* Rojo más claro */
            --warning: #f1c40f;    /* Amarillo */
            --safe: #27ae60;       /* Verde */
            --light: #f5f5f5;      /* Gris claro */
            --dark: #2c3e50;       /* Gris oscuro */
            --supabase: #3ecf8e;   /* Verde Supabase */
            --fisico: #9b59b6;     /* Púrpura para tipo Físico */
            --dark-red: #b71540;   /* Rojo oscuro para altos riesgos */
            --light-red: #ff6b6b;  /* Rojo claro */
            --blue: #3498db;       /* Azul para OT */
        }

        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== HEADER ===== */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark-red) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(220, 44, 60, 0.2);
            border-bottom: 4px solid var(--accent);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 28px;
            color: white;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .logo span {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 300;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.08);
            border-left: 4px solid var(--primary);
        }

        .main-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ===== COMPONENTES ===== */
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 3px solid var(--light);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(220, 44, 60, 0.1);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(220, 44, 60, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .card h2 i {
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group label.required::after {
            content: " *";
            color: var(--primary);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(220, 44, 60, 0.1);
            background-color: white;
        }

        .btn {
            padding: 12px 22px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #c22534;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 44, 60, 0.3);
        }

        .btn-success {
            background-color: var(--safe);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: #333;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-info {
            background-color: var(--blue);
            color: white;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pendiente {
            background-color: rgba(220, 44, 60, 0.15);
            color: var(--primary);
            border: 1px solid rgba(220, 44, 60, 0.3);
        }

        .status-reparado {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--safe);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .status-en-proceso {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--blue);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        /* ===== TIEMPO DE REPARACIÓN ===== */
        .tiempo-reparacion {
            font-weight: 700;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .tiempo-rapido {
            background-color: rgba(39, 174, 96, 0.15);
            color: var(--safe);
        }

        .tiempo-medio {
            background-color: rgba(241, 196, 15, 0.15);
            color: #d35400;
        }

        .tiempo-lento {
            background-color: rgba(220, 44, 60, 0.15);
            color: var(--primary);
        }

        /* ===== TIPO FÍSICO ===== */
        .tipo-fisico {
            background-color: rgba(155, 89, 182, 0.15);
            color: #9b59b6;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        /* ===== CÓDIGO OT ===== */
        .ot-code {
            background-color: rgba(52, 152, 219, 0.15);
            color: var(--blue);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 14px;
            border-left: 3px solid var(--blue);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* ===== FECHA ARREGLO ===== */
        .fecha-arreglo {
            background-color: rgba(243, 156, 18, 0.15);
            color: #e67e22;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* ===== NAVEGACIÓN ===== */
        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 8px;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 8px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
            background-color: #f9f9f9;
        }

        .nav-menu a:hover, .nav-menu a.active {
            background-color: rgba(220, 44, 60, 0.1);
            color: var(--primary);
            transform: translateX(5px);
            border-left: 3px solid var(--primary);
        }

        .nav-menu a i {
            width: 20px;
            text-align: center;
        }

        /* ===== ESTADÍSTICAS ===== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.05);
            text-align: center;
            transition: transform 0.3s;
            border-top: 4px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(220, 44, 60, 0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            margin: 10px 0;
            color: var(--primary);
        }

        .stat-title {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* ===== EVOLUCIÓN SEPARADA ===== */
        .evolution-section {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.05);
            border-top: 4px solid var(--blue);
        }

        .evolution-container {
            position: relative;
            height: 350px;
            width: 100%;
            margin-top: 15px;
        }

        /* ===== TABLAS CON FOTOS ===== */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background-color: var(--primary);
            color: white;
            text-align: left;
            padding: 14px 16px;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        table th:last-child {
            border-right: none;
        }

        table td {
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        table tr:hover {
            background-color: rgba(220, 44, 60, 0.03);
        }

        table tr:last-child td {
            border-bottom: none;
        }

        /* ===== GRÁFICOS ===== */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            margin-top: 20px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(220, 44, 60, 0.05);
            min-height: 350px;
            display: flex;
            flex-direction: column;
            border-top: 4px solid var(--accent);
        }

        .chart-item h3 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary);
            font-weight: 600;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
        }

        /* ===== FOTOS EN TABLA ===== */
        .photo-cell {
            text-align: center;
        }

        .table-photo {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #eee;
            transition: all 0.3s;
        }

        .table-photo:hover {
            transform: scale(1.1);
            border-color: var(--primary);
            box-shadow: 0 3px 8px rgba(220, 44, 60, 0.2);
        }

        .no-photo {
            color: #95a5a6;
            font-style: italic;
            font-size: 12px;
        }

        /* ===== SUBIDA DE FOTOS ===== */
        .photo-upload-container {
            border: 2px dashed var(--primary);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9f9f9;
            margin-bottom: 15px;
        }

        .photo-upload-container:hover {
            border-color: var(--dark-red);
            background-color: rgba(220, 44, 60, 0.05);
        }

        .photo-upload-container.dragging {
            border-color: var(--safe);
            background-color: rgba(39, 174, 96, 0.05);
        }

        .photo-preview {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .preview-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: contain;
            border: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .remove-photo-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .remove-photo-btn:hover {
            background-color: var(--dark-red);
            transform: translateY(-2px);
        }

        /* ===== MODAL DE FOTO ===== */
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .photo-modal-content {
            max-width: 90%;
            max-height: 80vh;
            position: relative;
        }

        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 2px solid var(--primary);
        }

        .modal-caption {
            color: white;
            text-align: center;
            margin-top: 15px;
            font-size: 16px;
            background-color: rgba(220, 44, 60, 0.3);
            padding: 10px;
            border-radius: 5px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            background: none;
            border: none;
            z-index: 3001;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: var(--primary);
            transform: scale(1.2);
        }

        /* ===== ACCIONES ===== */
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            border: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
            
            .evolution-container {
                height: 300px;
            }
            
            .chart-item {
                min-height: 300px;
            }
            
            .table-photo {
                width: 50px;
                height: 50px;
            }
            
            .preview-image {
                max-width: 250px;
                max-height: 150px;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 14px;
            }
        }

        @media (max-width: 576px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .table-photo {
                width: 40px;
                height: 40px;
            }
            
            .preview-image {
                max-width: 200px;
                max-height: 120px;
            }
            
            .card {
                padding: 20px;
            }
            
            .nav-menu a {
                padding: 12px 15px;
                font-size: 14px;
            }
        }

        /* ===== LOADING ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== STATUS INDICATOR ===== */
        .status-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .status-connected {
            background: var(--safe);
            color: white;
        }

        .status-disconnected {
            background: var(--warning);
            color: #333;
        }

        .status-error {
            background: var(--danger);
            color: white;
        }

        /* ===== FECHAS ===== */
        .date-input-group {
            display: flex;
            gap: 10px;
        }

        .date-input-group .form-control {
            flex: 1;
        }

        .date-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .date-pendiente {
            background-color: rgba(220, 44, 60, 0.1);
            color: var(--primary);
        }

        .date-cumplida {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--safe);
        }

        .date-atrasada {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }

        /* ===== ALERTAS ===== */
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .alert-warning {
            background-color: rgba(241, 196, 15, 0.1);
            border-left: 4px solid var(--warning);
            color: #d35400;
        }

        .alert-success {
            background-color: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--safe);
            color: var(--safe);
        }

        /* ===== BADGE DE RIESGO ===== */
        .risk-badge {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        .risk-critico {
            background-color: rgba(220, 44, 60, 0.2);
            color: var(--primary);
            border: 1px solid rgba(220, 44, 60, 0.3);
        }

        .risk-alto {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .risk-medio {
            background-color: rgba(241, 196, 15, 0.2);
            color: #d35400;
            border: 1px solid rgba(241, 196, 15, 0.3);
        }

        .risk-bajo {
            background-color: rgba(39, 174, 96, 0.2);
            color: var(--safe);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        /* ===== MEJORAS PARA MÓVIL ===== */
        @media (max-width: 768px) {
            .action-btn {
                padding: 12px 16px !important;
                font-size: 14px !important;
                min-height: 44px;
                min-width: 44px;
            }
            
            .btn {
                padding: 14px 20px !important;
                font-size: 16px !important;
                min-height: 48px;
            }
            
            .table-photo {
                width: 70px !important;
                height: 70px !important;
            }
            
            .form-control {
                font-size: 16px !important;
                padding: 14px !important;
            }
            
            .actions {
                gap: 12px !important;
            }
            
            .photo-upload-container {
                padding: 20px !important;
                min-height: 120px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            
            .photo-upload-container i {
                font-size: 36px !important;
                margin-bottom: 8px !important;
            }
            
            .photo-upload-container p {
                font-size: 14px !important;
                margin: 5px 0 !important;
                text-align: center;
            }
            
            .preview-image {
                max-width: 100% !important;
                max-height: 200px !important;
            }
            
            .remove-photo-btn {
                padding: 10px 20px !important;
                font-size: 14px !important;
                width: 100%;
                max-width: 200px;
            }
        }

        /* Mejoras de touch para móvil */
        .action-btn, .btn, .table-photo {
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            user-select: none;
        }

        /* Evitar zoom en inputs en iOS */
        input, select, textarea {
            font-size: 16px !important;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loading-text">Conectando con la base de datos...</p>
    </div>

    <!-- Status Indicator -->
    <div id="status-indicator" class="status-indicator status-disconnected">
        <i class="fas fa-database"></i>
        <span>Desconectado</span>
    </div>

    <!-- Modal para ver fotos -->
    <div id="photoModal" class="photo-modal">
        <button class="close-modal" onclick="cerrarModalFoto()">&times;</button>
        <div class="photo-modal-content">
            <img id="modalPhoto" class="modal-image" src="" alt="Foto ampliada">
            <p id="modalCaption" class="modal-caption"></p>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-hard-hat"></i>
                    <div>
                        <h1>Sistema de Condiciones Inseguras</h1>
                        <span>Danec S.A. - Seguridad Industrial</span>
                    </div>
                </div>
                <div class="user-info">
                    <i class="fas fa-database"></i>
                    <span id="db-status">Supabase</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <nav>
                    <ul class="nav-menu">
                        <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="#" data-page="registro"><i class="fas fa-plus-circle"></i> Nuevo Reporte</a></li>
                        <li><a href="#" data-page="historial"><i class="fas fa-history"></i> Historial</a></li>
                        <li><a href="#" data-page="analisis"><i class="fas fa-chart-bar"></i> Análisis</a></li>
                        <li><a href="#" data-page="config"><i class="fas fa-cog"></i> Configuración</a></li>
                    </ul>
                </nav>

                <!-- Supabase Config Panel -->
                <div id="supabase-config-panel" class="card" style="display: none; margin-top: 20px;">
                    <h3><i class="fas fa-database"></i> Configurar Supabase</h3>
                    <div class="form-group">
                        <label for="supabase-url" class="required">URL de Supabase:</label>
                        <input type="text" id="supabase-url" class="form-control" 
                               placeholder="https://abc123.supabase.co" required>
                        <small style="color: #7f8c8d; font-size: 12px;">Obtén esto desde el dashboard de Supabase</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="supabase-key" class="required">API Key (anon public):</label>
                        <input type="text" id="supabase-key" class="form-control" 
                               placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." required>
                        <small style="color: #7f8c8d; font-size: 12px;">Clave pública anónima desde Settings > API</small>
                    </div>
                    
                    <button class="btn btn-success" onclick="guardarConfigSupabase()">
                        <i class="fas fa-plug"></i> Conectar a Supabase
                    </button>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3><i class="fas fa-info-circle"></i> Información</h3>
                    <p style="margin-top: 10px; font-size: 14px;">
                        Sistema para reportar y gestionar condiciones inseguras en Danec S.A.
                    </p>
                    <div style="margin-top: 15px; padding: 15px; background-color: rgba(220, 44, 60, 0.05); border-radius: 6px;">
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-map-marker-alt" style="color: #dc2c3c;"></i> <strong>Zonas:</strong> Aceites y Jabonería-Confitería
                        </p>
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-tag" style="color: var(--blue);"></i> <strong>Nuevo:</strong> Código OT para identificación
                        </p>
                        <p style="font-size: 12px; color: #7f8c8d; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-calendar-alt" style="color: var(--accent);"></i> <strong>Nuevo:</strong> Fecha estimada de reparación
                        </p>
                    </div>
                </div>
            </aside>

            <!-- Main Panel -->
            <main class="main-panel">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-title">Total Reportes</div>
                            <div class="stat-value" id="total-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Pendientes</div>
                            <div class="stat-value" id="pending-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">En Proceso</div>
                            <div class="stat-value" id="process-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Reparados</div>
                            <div class="stat-value" id="repaired-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Tiempo Promedio</div>
                            <div class="stat-value" id="avg-time">0h</div>
                        </div>
                    </div>

                    <!-- Sección de Evolución Separada -->
                    <div class="evolution-section">
                        <h2><i class="fas fa-chart-line"></i> Evolución Temporal</h2>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">Reportes por mes en los últimos 6 meses</p>
                        <div class="evolution-container">
                            <canvas id="evolution-chart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2><i class="fas fa-history"></i> Últimas Actividades</h2>
                            <button onclick="forzarActualizacion()" class="btn btn-primary" style="padding: 8px 15px;">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="recent-table">
                                <thead>
                                    <tr>
                                        <th>OT</th>
                                        <th>Descripción</th>
                                        <th>Sector</th>
                                        <th>Tipo</th>
                                        <th>Fecha Est.</th>
                                        <th>Tiempo Rep.</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Registro Page -->
                <div id="registro-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-plus-circle"></i> Nuevo Reporte</h2>
                        <form id="report-form">
                            <!-- SECCIÓN 1: DATOS BÁSICOS -->
                            <div style="background-color: rgba(220, 44, 60, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--primary); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-id-card"></i> Datos de Identificación
                                </h3>
                                
                                <div class="form-group">
                                    <label for="ot-code" class="required">Código OT *</label>
                                    <input type="text" class="form-control" id="ot-code" 
                                           placeholder="Ej: 00001, 12345 (5 dígitos)" required
                                           pattern="^\d{5}$"
                                           title="Ingrese un código OT de 5 dígitos numéricos"
                                           maxlength="5">
                                    <small style="color: #7f8c8d; font-size: 12px;">Código único de 5 dígitos (ej: 00001)</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="reporter-name" class="required">Reportado por *</label>
                                    <input type="text" class="form-control" id="reporter-name" 
                                           placeholder="Nombre completo" required>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN 2: DESCRIPCIÓN -->
                            <div style="background-color: rgba(52, 152, 219, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--blue); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-file-alt"></i> Descripción del Problema
                                </h3>
                                
                                <div class="form-group">
                                    <label for="description" class="required">Descripción *</label>
                                    <textarea class="form-control" id="description" rows="4" 
                                              placeholder="Describa detalladamente la condición insegura..." required></textarea>
                                </div>
                                
                                <!-- SUBIDA DE FOTO SIMPLIFICADA PARA MÓVIL -->
                                <div class="form-group">
                                    <label for="foto-simple">Foto (opcional):</label>
                                    
                                    <div style="text-align: center;">
                                        <input type="file" 
                                               id="foto-simple" 
                                               accept="image/*" 
                                               capture="environment"
                                               onchange="manejarFotoSimple(this)"
                                               style="
                                                   width: 100%;
                                                   padding: 20px;
                                                   border: 3px dashed #dc2c3c;
                                                   border-radius: 10px;
                                                   background: #f9f9f9;
                                                   font-size: 16px;
                                                   cursor: pointer;
                                               ">
                                        
                                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 8px;">
                                            <i class="fas fa-info-circle"></i> Toca para tomar foto o elegir de galería
                                        </p>
                                    </div>
                                    
                                    <div id="preview-foto-simple"></div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN 3: UBICACIÓN Y RIESGO -->
                            <div style="background-color: rgba(39, 174, 96, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--safe); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-map-marker-alt"></i> Ubicación y Clasificación
                                </h3>
                                
                                <div class="form-group">
                                    <label for="sector" class="required">Sector/Área *</label>
                                    <select class="form-control" id="sector" required>
                                        <option value="">Seleccione</option>
                                        <option value="Aceites">Aceites</option>
                                        <option value="Jabonería-Confitería">Jabonería-Confitería</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="ubicacion" class="required">Ubicación específica *</label>
                                    <input type="text" class="form-control" id="ubicacion" 
                                           placeholder="Ej: Zona 1 - Línea 3, Estación 5" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="category" class="required">Tipo de riesgo *</label>
                                    <select class="form-control" id="category" required>
                                        <option value="">Seleccione</option>
                                        <option value="Físico">Físico</option>
                                        <option value="Estructural">Estructural</option>
                                        <option value="Eléctrico">Eléctrico</option>
                                        <option value="Ambiental">Ambiental</option>
                                        <option value="Operacional">Operacional</option>
                                        <option value="Químico">Químico</option>
                                        <option value="Mecánico">Mecánico</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="risk-level" class="required">Nivel de Riesgo *</label>
                                    <select class="form-control" id="risk-level" required>
                                        <option value="">Seleccione</option>
                                        <option value="Bajo">Bajo</option>
                                        <option value="Medio">Medio</option>
                                        <option value="Alto">Alto</option>
                                        <option value="Crítico">Crítico</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN 4: PLANIFICACIÓN -->
                            <div style="background-color: rgba(243, 156, 18, 0.05); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h3 style="color: var(--accent); font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-calendar-alt"></i> Planificación y Observaciones
                                </h3>
                                
                                <div class="form-group">
                                    <label for="fecha-estimada" class="required">Fecha estimada de reparación *</label>
                                    <input type="date" class="form-control" id="fecha-estimada" required>
                                    <small style="color: #7f8c8d; font-size: 12px;">Fecha límite para resolver la condición</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="observaciones">Observaciones adicionales</label>
                                    <textarea class="form-control" id="observaciones" rows="2" 
                                              placeholder="Información adicional, recomendaciones, prioridad..."></textarea>
                                </div>
                            </div>
                            
                            <!-- BOTONES DE ACCIÓN -->
                            <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; flex-wrap: wrap;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Guardar Reporte
                                </button>
                                <button type="reset" class="btn" style="background-color: #95a5a6; color: white;" onclick="eliminarFotoSimple()">
                                    <i class="fas fa-undo"></i> Limpiar Formulario
                                </button>
                                <button type="button" class="btn btn-warning" onclick="mostrarEjemplo()">
                                    <i class="fas fa-eye"></i> Ver Ejemplo
                                </button>
                                <button type="button" class="btn btn-info" onclick="generarCodigoOT()">
                                    <i class="fas fa-bolt"></i> Generar OT
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Historial Page -->
                <div id="historial-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-history"></i> Historial de Reportes</h2>
                        
                        <!-- Filtros y Búsqueda -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn" id="filter-all">Todos</button>
                                <button class="btn btn-primary" id="filter-pending">Pendientes</button>
                                <button class="btn btn-info" id="filter-process">En Proceso</button>
                                <button class="btn btn-success" id="filter-repaired">Reparados</button>
                                <button class="btn btn-warning" onclick="diagnosticarProblemas()">
                                    <i class="fas fa-stethoscope"></i> Diagnosticar
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select class="form-control" id="filter-sector" style="width: 150px;">
                                    <option value="">Todos los sectores</option>
                                    <option value="Aceites">Aceites</option>
                                    <option value="Jabonería-Confitería">Jabonería-Confitería</option>
                                </select>
                                <input type="text" class="form-control" id="search-input" placeholder="Buscar por OT, descripción..." style="width: 200px;">
                                <button class="btn btn-primary" onclick="exportarHistorial()" title="Exportar a CSV">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tabla de Historial -->
                        <div class="table-container">
                            <table id="history-table">
                                <thead>
                                    <tr>
                                        <th>OT</th>
                                        <th>Descripción</th>
                                        <th>Sector</th>
                                        <th>Tipo</th>
                                        <th>Riesgo</th>
                                        <th>Fecha Est.</th>
                                        <th>Foto</th>
                                        <th>Fecha Reporte</th>
                                        <th>Tiempo Rep.</th>
                                        <th>Reportado por</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Datos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Análisis Page -->
                <div id="analisis-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-chart-bar"></i> Análisis y Reportes</h2>
                        
                        <!-- Selector de análisis -->
                        <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <select class="form-control" id="analysis-type" style="width: 200px;">
                                <option value="risk">Por Nivel de Riesgo</option>
                                <option value="sector">Por Sector</option>
                                <option value="category">Por Tipo</option>
                                <option value="status">Por Estado</option>
                                <option value="time">Por Tiempo de Reparación</option>
                            </select>
                            <button class="btn btn-primary" onclick="actualizarAnalisis()">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                            <button class="btn btn-success" onclick="generarReportePDF()">
                                <i class="fas fa-file-pdf"></i> Generar PDF
                            </button>
                        </div>
                        
                        <!-- Gráfico principal -->
                        <div class="chart-container">
                            <canvas id="data-chart"></canvas>
                        </div>
                        
                        <!-- Gráficos secundarios -->
                        <div class="chart-row">
                            <div class="chart-item">
                                <h3><i class="fas fa-map-marker-alt"></i> Distribución por Sector</h3>
                                <div class="chart-wrapper">
                                    <canvas id="sector-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-item">
                                <h3><i class="fas fa-clock"></i> Tiempos de Reparación</h3>
                                <div class="chart-wrapper">
                                    <canvas id="time-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KPIs -->
                        <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--dark-red) 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;" id="kpi-tiempo-promedio">0h</div>
                                <div style="font-size: 12px; opacity: 0.9;">Tiempo Promedio</div>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--safe) 0%, #219653 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;" id="kpi-cumplimiento">0%</div>
                                <div style="font-size: 12px; opacity: 0.9;">Cumplimiento Fechas</div>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--accent) 0%, #e67e22 100%); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 800;" id="kpi-reportes-mes">0</div>
                                <div style="font-size: 12px; opacity: 0.9;">Reportes/Mes</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración Page -->
                <div id="config-page" class="page" style="display: none;">
                    <div class="card">
                        <h2><i class="fas fa-cog"></i> Configuración del Sistema</h2>
                        
                        <!-- Conexión Supabase -->
                        <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--dark-red) 100%); color: white; margin-top: 20px;">
                            <h3><i class="fas fa-database"></i> Conexión Supabase</h3>
                            
                            <div class="form-group">
                                <label>Estado de la conexión:</label>
                                <div id="connection-status" style="padding: 12px; background: rgba(255, 255, 255, 0.15); border-radius: 6px; font-weight: 600;">
                                    <i class="fas fa-circle-notch fa-spin"></i> Verificando...
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="current-url">URL Actual:</label>
                                <input type="text" id="current-url" class="form-control" readonly style="background: rgba(255, 255, 255, 0.9);">
                            </div>
                            
                            <div class="form-group">
                                <label for="current-key">API Key:</label>
                                <input type="text" id="current-key" class="form-control" readonly style="background: rgba(255, 255, 255, 0.9);">
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="probarConexion()">
                                    <i class="fas fa-sync-alt"></i> Probar Conexión
                                </button>
                                <button class="btn btn-warning" onclick="mostrarConfigPanel()">
                                    <i class="fas fa-edit"></i> Cambiar Credenciales
                                </button>
                                <button class="btn" style="background-color: white; color: var(--primary);" onclick="abrirManualSupabase()">
                                    <i class="fas fa-book"></i> Ver Manual
                                </button>
                            </div>
                        </div>
                        
                        <!-- Información del Sistema -->
                        <div style="margin-top: 30px;">
                            <h3><i class="fas fa-info-circle"></i> Información del Sistema</h3>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 10px; border-left: 4px solid var(--primary);">
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-hashtag" style="color: var(--primary);"></i> Total reportes:</strong> <span id="total-db-count">0</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-camera" style="color: var(--primary);"></i> Reportes con fotos:</strong> <span id="reports-with-photos">0</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-clock" style="color: var(--accent);"></i> Tiempo promedio reparación:</strong> <span id="avg-repair-time">0h</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-calendar-check" style="color: var(--safe);"></i> Cumplimiento fechas:</strong> <span id="cumplimiento-fechas">0%</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-sync-alt" style="color: var(--blue);"></i> Última sincronización:</strong> <span id="last-sync">Nunca</span></p>
                                <p style="margin-bottom: 8px;"><strong><i class="fas fa-laptop" style="color: var(--dark);"></i> Modo:</strong> <span id="current-mode">Desconocido</span></p>
                                <p><strong><i class="fas fa-code-branch" style="color: var(--dark);"></i> Versión:</strong> Danec v5.0</p>
                            </div>
                        </div>
                        
                        <!-- Herramientas -->
                        <div style="margin-top: 30px;">
                            <h3><i class="fas fa-tools"></i> Herramientas</h3>
                            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                <button class="btn btn-danger" onclick="limpiarDatos()">
                                    <i class="fas fa-trash"></i> Limpiar Datos Locales
                                </button>
                                <button class="btn btn-warning" onclick="resetConfig()">
                                    <i class="fas fa-redo"></i> Resetear Configuración
                                </button>
                                <button class="btn btn-info" onclick="backupLocal()">
                                    <i class="fas fa-download"></i> Backup Local
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <footer style="text-align: center; margin-top: 30px; padding: 20px; color: #7f8c8d; border-top: 1px solid #eee; background-color: rgba(220, 44, 60, 0.05);">
            <p><strong>Sistema de Condiciones Inseguras Danec S.A.</strong> &copy; 2024 | Versión 5.0 | Colores corporativos: #dc2c3c</p>
            <p style="font-size: 12px; margin-top: 5px;">Sectores: Aceites y Jabonería-Confitería | Código OT de 5 dígitos</p>
        </footer>
    </div>

    <script>
        // ==============================================
        // CONFIGURACIÓN GLOBAL
        // ==============================================
        let supabaseClient = null;
        let unsafeConditions = [];
        let currentFilter = 'all';
        let dataChart = null;
        let sectorChart = null;
        let timeChart = null;
        let evolutionChart = null;
        let fotoSeleccionada = null;
    

// ⭐⭐ CREDENCIALES ACTUALIZADAS ⭐⭐
const MIS_CREDENCIALES = {
    URL: 'https://poaqbdzvqdqdxvchwjwc.supabase.co',
    API_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvYXFiZHp2cWRxZHh2Y2h3andjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5OTczNDEsImV4cCI6MjA4NDU3MzM0MX0.LQw5ytCns_xl_Z-wAEeIbNvz1wgpFoiABd5ie1fgmIk'
};

let CONFIG = {
    supabaseUrl: '',
    supabaseKey: '',
    lastSync: 'Nunca',
    offlineMode: true,
    initialized: false
};
        
        // Guardar en localStorage también
        localStorage.setItem('supabase_url', CONFIG.supabaseUrl);
        localStorage.setItem('supabase_key', CONFIG.supabaseKey);
        
        // Colores Danec para gráficos
        const CHART_COLORS = {
            riesgo: {
                'Crítico': '#dc2c3c',
                'Alto': '#e74c3c',
                'Medio': '#f39c12',
                'Bajo': '#27ae60'
            },
            estado: {
                'pendiente': '#dc2c3c',
                'en proceso': '#3498db',
                'reparado': '#27ae60'
            },
            sector: ['#dc2c3c', '#2c3e50'], // Solo 2 colores para las 2 zonas
            tipo: {
                'Físico': '#9b59b6',
                'Estructural': '#dc2c3c',
                'Eléctrico': '#f1c40f',
                'Ambiental': '#1abc9c',
                'Operacional': '#3498db',
                'Químico': '#e67e22',
                'Mecánico': '#7f8c8d'
            },
            tiempo: ['#27ae60', '#f1c40f', '#e67e22', '#dc2c3c']
        };
        
        // ==============================================
        // FUNCIONES DE UTILIDAD
        // ==============================================
        function showLoading(show, text = 'Cargando...') {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            
            if (loading) loading.style.display = show ? 'flex' : 'none';
            if (loadingText && text) loadingText.textContent = text;
        }
        
        function updateStatusIndicator(status, message) {
            const indicator = document.getElementById('status-indicator');
            if (!indicator) return;
            
            indicator.classList.remove('status-connected', 'status-disconnected', 'status-error');
            indicator.classList.add(`status-${status}`);
            
            let icon = 'fa-database';
            if (status === 'connected') icon = 'fa-check-circle';
            if (status === 'error') icon = 'fa-exclamation-triangle';
            if (status === 'disconnected') icon = 'fa-unlink';
            
            indicator.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            
            const dbStatus = document.getElementById('db-status');
            if (dbStatus) {
                dbStatus.textContent = status === 'connected' ? 'Conectado ✓' : 'Desconectado ✗';
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function obtenerTimestamp() {
            return new Date().toISOString();
        }
        
        function generarCodigoOT() {
            // Obtener el próximo número disponible
            const numerosUsados = unsafeConditions
                .filter(c => c.OT && c.OT.match(/^\d{5}$/))
                .map(c => parseInt(c.OT))
                .filter(n => !isNaN(n));
            
            let siguienteNumero = 1;
            if (numerosUsados.length > 0) {
                const maxNumero = Math.max(...numerosUsados);
                siguienteNumero = maxNumero + 1;
            }
            
            // Formatear a 5 dígitos con ceros a la izquierda
            const otCode = String(siguienteNumero).padStart(5, '0');
            document.getElementById('ot-code').value = otCode;
            
            // Mostrar feedback
            const otField = document.getElementById('ot-code');
            otField.style.borderColor = '#27ae60';
            otField.style.boxShadow = '0 0 0 3px rgba(39, 174, 96, 0.2)';
            
            setTimeout(() => {
                otField.style.borderColor = '';
                otField.style.boxShadow = '';
            }, 1500);
        }
        
        function calcularTiempoReparacion(fechaInicio, fechaFin) {
            if (!fechaInicio || !fechaFin) {
                return { texto: 'No reparado', horas: 0, clase: '' };
            }
            
            try {
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                
                if (isNaN(inicio.getTime()) || isNaN(fin.getTime())) {
                    return { texto: 'Fechas inválidas', horas: 0, clase: '' };
                }
                
                const diffMs = fin - inicio;
                
                if (diffMs < 0) {
                    return { texto: 'Fecha reparación anterior al reporte', horas: 0, clase: '' };
                }
                
                const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                let texto = '';
                if (dias > 0) {
                    texto = `${dias}d ${horas}h`;
                } else if (horas > 0) {
                    texto = `${horas}h ${minutos}m`;
                } else if (minutos > 0) {
                    texto = `${minutos} min`;
                } else {
                    texto = '< 1 min';
                }
                
                let clase = 'tiempo-rapido';
                const totalHoras = (diffMs / (1000 * 60 * 60));
                if (totalHoras > 72) clase = 'tiempo-lento';
                else if (totalHoras > 24) clase = 'tiempo-medio';
                
                return { 
                    texto, 
                    horas: totalHoras, 
                    dias: dias,
                    minutos: minutos,
                    clase 
                };
                
            } catch (error) {
                console.error('Error calculando tiempo:', error);
                return { texto: 'Error cálculo', horas: 0, clase: '' };
            }
        }
        
        function calcularTiempoPromedioReparacion() {
            const reparados = unsafeConditions.filter(c => c.Estado === 'reparado' && c.Fecha && c.FechaReparacion);
            
            if (reparados.length === 0) {
                return '0h';
            }
            
            let totalHoras = 0;
            let contadorValidos = 0;
            
            reparados.forEach(cond => {
                const tiempo = calcularTiempoReparacion(cond.Fecha, cond.FechaReparacion);
                if (tiempo.horas > 0) {
                    totalHoras += tiempo.horas;
                    contadorValidos++;
                }
            });
            
            if (contadorValidos === 0) return '0h';
            
            const promedioHoras = Math.round(totalHoras / contadorValidos);
            
            if (promedioHoras < 1) {
                return '< 1h';
            } else if (promedioHoras < 24) {
                return `${promedioHoras}h`;
            } else {
                const dias = Math.floor(promedioHoras / 24);
                const horas = promedioHoras % 24;
                return horas > 0 ? `${dias}d ${horas}h` : `${dias}d`;
            }
        }
        
        function verificarEstadoFecha(fechaEstimada, fechaReparacion = null) {
            if (!fechaEstimada) return { estado: 'sin-fecha', clase: '', icono: 'fa-minus' };
            
            const hoy = new Date();
            const fechaEst = new Date(fechaEstimada);
            const fechaRep = fechaReparacion ? new Date(fechaReparacion) : null;
            
            if (fechaRep) {
                // Ya reparado, verificar si fue a tiempo
                if (fechaRep <= fechaEst) {
                    return { 
                        estado: 'cumplida', 
                        clase: 'date-cumplida', 
                        icono: 'fa-check-circle',
                        texto: 'A tiempo'
                    };
                } else {
                    return { 
                        estado: 'atrasada', 
                        clase: 'date-atrasada', 
                        icono: 'fa-exclamation-circle',
                        texto: 'Con retraso'
                    };
                }
            } else {
                // Pendiente o en proceso
                if (fechaEst < hoy) {
                    return { 
                        estado: 'atrasada', 
                        clase: 'date-atrasada', 
                        icono: 'fa-exclamation-triangle',
                        texto: 'Vencida'
                    };
                } else {
                    const diffDias = Math.ceil((fechaEst - hoy) / (1000 * 60 * 60 * 24));
                    return { 
                        estado: 'pendiente', 
                        clase: 'date-pendiente', 
                        icono: 'fa-calendar',
                        texto: `En ${diffDias} día(s)`
                    };
                }
            }
        }
        
        function calcularCumplimientoFechas() {
            const conFechaEst = unsafeConditions.filter(c => c.FechaEstimadaReparacion);
            if (conFechaEst.length === 0) return 0;
            
            const cumplidas = conFechaEst.filter(c => {
                if (!c.FechaReparacion) return false;
                const fechaEst = new Date(c.FechaEstimadaReparacion);
                const fechaRep = new Date(c.FechaReparacion);
                return fechaRep <= fechaEst;
            }).length;
            
            return Math.round((cumplidas / conFechaEst.length) * 100);
        }
        
        // ==============================================
        // FUNCIONES PARA FOTOS SIMPLIFICADAS
        // ==============================================
        
        function manejarFotoSimple(input) {
            console.log('📸 Foto seleccionada');
            
            if (!input.files || !input.files[0]) {
                console.log('No se seleccionó archivo');
                return;
            }
            
            const file = input.files[0];
            
            // Validaciones básicas
            if (!file.type.startsWith('image/')) {
                alert('❌ Por favor selecciona una imagen (JPG, PNG, etc.)');
                input.value = '';
                return;
            }
            
            // Limitar a 2MB para free tier
            const MAX_SIZE = 2 * 1024 * 1024; // 2MB
            if (file.size > MAX_SIZE) {
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                alert(`⚠️ La imagen es muy grande (${sizeMB} MB). Máximo: 2MB`);
                input.value = '';
                return;
            }
            
            // Guardar referencia
            fotoSeleccionada = file;
            
            // Mostrar preview
            mostrarPreviewSimple(file);
        }
        
        function mostrarPreviewSimple(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const previewDiv = document.getElementById('preview-foto-simple');
                if (!previewDiv) return;
                
                const tamañoKB = (file.size / 1024).toFixed(1);
                
                previewDiv.innerHTML = `
                    <div style="margin-top: 15px; padding: 15px; background: rgba(220, 44, 60, 0.05); border-radius: 10px; text-align: center;">
                        <h4 style="color: #dc2c3c; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> Foto lista
                        </h4>
                        
                        <img src="${e.target.result}" 
                             style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 3px solid white;"
                             alt="Vista previa">
                        
                        <div style="margin-top: 15px;">
                            <button type="button" onclick="eliminarFotoSimple()" 
                                    style="padding: 10px 20px; background: #dc2c3c; color: white; border: none; border-radius: 6px; font-weight: bold;">
                                <i class="fas fa-trash"></i> Eliminar
                                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                <i class="fas fa-info-circle"></i> Tamaño: ${tamañoKB} KB
                            </div>
                        </div>
                    </div>
                `;
            };
            
            reader.readAsDataURL(file);
        }

        function eliminarFotoSimple() {
            fotoSeleccionada = null;
            const input = document.getElementById('foto-simple');
            if (input) input.value = '';
            
            const previewDiv = document.getElementById('preview-foto-simple');
            if (previewDiv) previewDiv.innerHTML = '';
        }

        // ==============================================
        // FUNCIONES DE GESTIÓN DE FOTOS
        // ==============================================
        async function subirFotoSupabase(file, otCode) {
            if (!supabaseClient) return null;
            
            try {
                const fileName = `condicion_${otCode}_${Date.now()}.jpg`;
                
                const { data, error } = await supabaseClient.storage
                    .from('condiciones_imagenes')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;
                
                // Obtener URL pública
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('condiciones_imagenes')
                    .getPublicUrl(fileName);
                    
                return publicUrl;
                
            } catch (error) {
                console.error('Error subiendo foto:', error);
                
                // Si falla la subida, guardar como base64 localmente
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve(e.target.result);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function verFoto(url, caption = '') {
            if (!url) return;
            
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalPhoto');
            const modalCaption = document.getElementById('modalCaption');
            
            modalImg.src = url;
            modalCaption.textContent = caption || 'Foto de condición insegura';
            modal.style.display = 'flex';
            
            // Cerrar al hacer clic fuera de la imagen
            modal.onclick = function(e) {
                if (e.target === modal) cerrarModalFoto();
            };
        }

        function cerrarModalFoto() {
            document.getElementById('photoModal').style.display = 'none';
        }

        // ==============================================
        // FUNCIONES DE NAVEGACIÓN
        // ==============================================
        function cambiarPagina(pagina) {
            // Ocultar todas las páginas
            document.querySelectorAll('.page').forEach(p => {
                p.style.display = 'none';
                p.classList.remove('active');
            });
            
            // Mostrar página seleccionada
            const pageElement = document.getElementById(`${pagina}-page`);
            if (pageElement) {
                pageElement.style.display = 'block';
                pageElement.classList.add('active');
            }
            
            // Actualizar navegación activa
            document.querySelectorAll('.nav-menu a').forEach(a => {
                a.classList.remove('active');
                if (a.getAttribute('data-page') === pagina) {
                    a.classList.add('active');
                }
            });
            
            // Cargar datos según la página
            switch(pagina) {
                case 'dashboard':
                    cargarDashboard();
                    break;
                case 'historial':
                    cargarHistorial();
                    break;
                case 'analisis':
                    cargarAnalisis();
                    break;
                case 'config':
                    cargarConfiguracion();
                    break;
            }
        }

        // ==============================================
        // FUNCIONES PARA DASHBOARD
        // ==============================================
        async function cargarDashboard() {
            try {
                // Actualizar estadísticas
                actualizarEstadisticas();
                
                // Cargar actividades recientes
                await cargarActividadesRecientes();
                
                // Actualizar gráfico de evolución
                actualizarGraficoEvolucion();
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        function actualizarEstadisticas() {
            const total = unsafeConditions.length;
            const pendientes = unsafeConditions.filter(c => c.Estado === 'pendiente').length;
            const enProceso = unsafeConditions.filter(c => c.Estado === 'en proceso').length;
            const reparados = unsafeConditions.filter(c => c.Estado === 'reparado').length;
            const tiempoPromedio = calcularTiempoPromedioReparacion();
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('pending-count').textContent = pendientes;
            document.getElementById('process-count').textContent = enProceso;
            document.getElementById('repaired-count').textContent = reparados;
            document.getElementById('avg-time').textContent = tiempoPromedio;
        }

        async function cargarActividadesRecientes() {
            const tbody = document.querySelector('#recent-table tbody');
            if (!tbody) return;
            
            // Ordenar por fecha más reciente
            const recientes = [...unsafeConditions]
                .sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha))
                .slice(0, 5);
            
            tbody.innerHTML = '';
            
            recientes.forEach(condicion => {
                const tiempo = condicion.Estado === 'reparado' ? 
                    calcularTiempoReparacion(condicion.Fecha, condicion.FechaReparacion) : 
                    { texto: 'En proceso', clase: 'tiempo-medio' };
                
                const estadoFecha = verificarEstadoFecha(condicion.FechaEstimadaReparacion, condicion.FechaReparacion);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="ot-code">${condicion.OT || 'Sin OT'}</span></td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${condicion.Descripcion}">
                        ${condicion.Descripcion?.substring(0, 50)}${condicion.Descripcion?.length > 50 ? '...' : ''}
                    </td>
                    <td>${condicion.Sector}</td>
                    <td>${condicion.Tipo === 'Físico' ? '<span class="tipo-fisico">' + condicion.Tipo + '</span>' : condicion.Tipo}</td>
                    <td>
                        <span class="date-badge ${estadoFecha.clase}">
                            <i class="fas ${estadoFecha.icono}"></i>
                            ${formatDate(condicion.FechaEstimadaReparacion) || 'Sin fecha'}
                        </span>
                    </td>
                    <td><span class="tiempo-reparacion ${tiempo.clase}">${tiempo.texto}</span></td>
                    <td><span class="status-badge status-${condicion.Estado?.replace(' ', '-')}">${condicion.Estado}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function actualizarGraficoEvolucion() {
            const ctx = document.getElementById('evolution-chart');
            if (!ctx) return;
            
            if (evolutionChart) {
                evolutionChart.destroy();
            }
            
            // Agrupar por mes
            const ultimos6Meses = [];
            const hoy = new Date();
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
                ultimos6Meses.push({
                    mes: fecha.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }),
                    fechaObj: fecha
                });
            }
            
            // Contar reportes por mes
            const datos = ultimos6Meses.map(mes => {
                const reportesMes = unsafeConditions.filter(c => {
                    try {
                        const fechaReporte = new Date(c.Fecha);
                        return fechaReporte.getFullYear() === mes.fechaObj.getFullYear() && 
                               fechaReporte.getMonth() === mes.fechaObj.getMonth();
                    } catch {
                        return false;
                    }
                });
                return reportesMes.length;
            });
            
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ultimos6Meses.map(m => m.mes),
                    datasets: [{
                        label: 'Reportes por mes',
                        data: datos,
                        borderColor: '#dc2c3c',
                        backgroundColor: 'rgba(220, 44, 60, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#dc2c3c',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#2c3e50',
                                font: {
                                    size: 12,
                                    family: "'Segoe UI', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#7f8c8d',
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Cantidad de Reportes',
                                color: '#2c3e50',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#2c3e50',
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // ==============================================
        // FUNCIONES PARA REGISTRO
        // ==============================================
        async function manejarRegistro(event) {
            event.preventDefault();
            
            const form = event.target;
            
            // Validar código OT (5 dígitos numéricos)
            const otInput = document.getElementById('ot-code');
            const otRegex = /^\d{5}$/;
            if (!otRegex.test(otInput.value)) {
                alert('❌ El código OT debe ser un número de 5 dígitos (ej: 00001)');
                otInput.focus();
                otInput.style.borderColor = '#dc2c3c';
                otInput.style.boxShadow = '0 0 0 3px rgba(220, 44, 60, 0.2)';
                return;
            }
            
            // Verificar si el código OT ya existe
            const otExistente = unsafeConditions.find(c => c.OT === otInput.value);
            if (otExistente) {
                if (!confirm(`⚠️ El código OT ${otInput.value} ya existe. ¿Desea actualizar el reporte existente?`)) {
                    return;
                }
            }
            
            showLoading(true, 'Guardando reporte...');
            
            try {
                // Subir foto si existe
                let fotoUrl = null;
                if (fotoSeleccionada) {
                    fotoUrl = await subirFotoSupabase(fotoSeleccionada, otInput.value);
                }
                
                // Crear objeto de condición
                const nuevaCondicion = {
                    OT: otInput.value,
                    ReportadoPor: document.getElementById('reporter-name').value,
                    Descripcion: document.getElementById('description').value,
                    Sector: document.getElementById('sector').value,
                    Ubicacion: document.getElementById('ubicacion').value,
                    Tipo: document.getElementById('category').value,
                    NivelRiesgo: document.getElementById('risk-level').value,
                    FechaEstimadaReparacion: document.getElementById('fecha-estimada').value,
                    Observaciones: document.getElementById('observaciones').value || '',
                    Foto: fotoUrl,
                    Fecha: obtenerTimestamp(),
                    Estado: 'pendiente',
                    FechaReparacion: null,
                    TipoReparacion: null,
                    CostoEstimado: null
                };
                
                // Guardar en Supabase
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('condiciones_inseguras')
                        .upsert([nuevaCondicion], { onConflict: 'OT' });
                    
                    if (error) throw error;
                } else {
                    // Guardar localmente si no hay conexión
                    guardarLocalmente(nuevaCondicion);
                }
                
                // Actualizar datos locales
                if (otExistente) {
                    const index = unsafeConditions.findIndex(c => c.OT === otInput.value);
                    unsafeConditions[index] = nuevaCondicion;
                } else {
                    unsafeConditions.push(nuevaCondicion);
                }
                
                // Guardar localmente
                guardarDatosLocales();
                
                // Mostrar éxito
                alert('✅ Reporte guardado exitosamente!');
                
                // Limpiar formulario
                form.reset();
                eliminarFotoSimple();
                
                // Volver al dashboard
                cambiarPagina('dashboard');
                
            } catch (error) {
                console.error('Error guardando reporte:', error);
                alert('❌ Error al guardar el reporte. Verifica la conexión y los datos.');
            } finally {
                showLoading(false);
            }
        }

        function mostrarEjemplo() {
            document.getElementById('ot-code').value = '00123';
            document.getElementById('reporter-name').value = 'Juan Pérez';
            document.getElementById('description').value = 'Fuga de aceite en válvula principal de línea 3. Posible riesgo de resbalones y contaminación. Se requiere atención inmediata.';
            document.getElementById('sector').value = 'Aceites';
            document.getElementById('ubicacion').value = 'Zona 2 - Línea 3, Válvula V-203';
            document.getElementById('category').value = 'Físico';
            document.getElementById('risk-level').value = 'Alto';
            
            // Fecha de mañana
            const mañana = new Date();
            mañana.setDate(mañana.getDate() + 1);
            document.getElementById('fecha-estimada').value = mañana.toISOString().split('T')[0];
            
            document.getElementById('observaciones').value = 'Prioridad alta. Solicito revisión del equipo de mantenimiento.';
            
            // Mostrar mensaje
            alert('📝 Ejemplo cargado. Revisa los datos y modifica según sea necesario.');
        }

        // ==============================================
        // FUNCIONES PARA HISTORIAL
        // ==============================================
        function cargarHistorial() {
            const tbody = document.querySelector('#history-table tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Filtrar según filtro actual
            let condicionesFiltradas = [...unsafeConditions];
            
            if (currentFilter === 'pending') {
                condicionesFiltradas = condicionesFiltradas.filter(c => c.Estado === 'pendiente');
            } else if (currentFilter === 'process') {
                condicionesFiltradas = condicionesFiltradas.filter(c => c.Estado === 'en proceso');
            } else if (currentFilter === 'repaired') {
                condicionesFiltradas = condicionesFiltradas.filter(c => c.Estado === 'reparado');
            }
            
            // Aplicar filtro de sector
            const sectorFiltro = document.getElementById('filter-sector').value;
            if (sectorFiltro) {
                condicionesFiltradas = condicionesFiltradas.filter(c => c.Sector === sectorFiltro);
            }
            
            // Aplicar búsqueda
            const busqueda = document.getElementById('search-input').value.toLowerCase();
            if (busqueda) {
                condicionesFiltradas = condicionesFiltradas.filter(c => 
                    (c.OT && c.OT.toLowerCase().includes(busqueda)) ||
                    (c.Descripcion && c.Descripcion.toLowerCase().includes(busqueda)) ||
                    (c.ReportadoPor && c.ReportadoPor.toLowerCase().includes(busqueda))
                );
            }
            
            // Ordenar por fecha (más recientes primero)
            condicionesFiltradas.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));
            
            // Mostrar en tabla
            condicionesFiltradas.forEach(condicion => {
                const tiempo = condicion.Estado === 'reparado' ? 
                    calcularTiempoReparacion(condicion.Fecha, condicion.FechaReparacion) : 
                    { texto: 'En proceso', clase: 'tiempo-medio' };
                
                const estadoFecha = verificarEstadoFecha(condicion.FechaEstimadaReparacion, condicion.FechaReparacion);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="ot-code"><i class="fas fa-hashtag"></i>${condicion.OT}</span></td>
                    <td style="max-width: 150px;" title="${condicion.Descripcion}">${condicion.Descripcion?.substring(0, 60)}${condicion.Descripcion?.length > 60 ? '...' : ''}</td>
                    <td>${condicion.Sector}</td>
                    <td>${condicion.Tipo === 'Físico' ? '<span class="tipo-fisico">' + condicion.Tipo + '</span>' : condicion.Tipo}</td>
                    <td><span class="risk-badge risk-${condicion.NivelRiesgo?.toLowerCase()}">${condicion.NivelRiesgo}</span></td>
                    <td>
                        <span class="date-badge ${estadoFecha.clase}">
                            <i class="fas ${estadoFecha.icono}"></i>
                            ${condicion.FechaEstimadaReparacion ? formatDate(condicion.FechaEstimadaReparacion).split(' ')[0] : 'Sin fecha'}
                        </span>
                    </td>
                    <td class="photo-cell">
                        ${condicion.Foto ? 
                            `<img src="${condicion.Foto}" class="table-photo" onclick="verFoto('${condicion.Foto}', 'OT: ${condicion.OT} - ${condicion.Descripcion?.substring(0, 50)}...')">` : 
                            '<span class="no-photo">Sin foto</span>'}
                    </td>
                    <td>${formatDate(condicion.Fecha)}</td>
                    <td><span class="tiempo-reparacion ${tiempo.clase}">${tiempo.texto}</span></td>
                    <td>${condicion.ReportadoPor}</td>
                    <td><span class="status-badge status-${condicion.Estado?.replace(' ', '-')}">${condicion.Estado}</span></td>
                    <td>
                        <div class="actions">
                            <button class="action-btn btn-primary" onclick="editarReporte('${condicion.OT}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn btn-success" onclick="marcarEnProceso('${condicion.OT}')" title="En Proceso">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="action-btn btn-danger" onclick="marcarReparado('${condicion.OT}')" title="Reparado">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function marcarEnProceso(ot) {
            if (!confirm('¿Marcar este reporte como "En Proceso"?')) return;
            
            try {
                const condicion = unsafeConditions.find(c => c.OT === ot);
                if (!condicion) return;
                
                condicion.Estado = 'en proceso';
                condicion.TipoReparacion = 'En proceso';
                
                // Actualizar en Supabase
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('condiciones_inseguras')
                        .update({ 
                            Estado: 'en proceso',
                            TipoReparacion: 'En proceso'
                        })
                        .eq('OT', ot);
                    
                    if (error) throw error;
                }
                
                // Actualizar localmente
                guardarDatosLocales();
                
                // Recargar historial
                cargarHistorial();
                actualizarEstadisticas();
                
                alert('✅ Reporte marcado como "En Proceso"');
                
            } catch (error) {
                console.error('Error actualizando estado:', error);
                alert('❌ Error al actualizar estado');
            }
        }

        async function marcarReparado(ot) {
            const tipoReparacion = prompt('Ingrese el tipo de reparación realizada:', 'Mantenimiento preventivo');
            if (!tipoReparacion) return;
            
            const costo = prompt('Ingrese el costo estimado (opcional):', '0');
            
            try {
                const condicion = unsafeConditions.find(c => c.OT === ot);
                if (!condicion) return;
                
                condicion.Estado = 'reparado';
                condicion.FechaReparacion = obtenerTimestamp();
                condicion.TipoReparacion = tipoReparacion;
                condicion.CostoEstimado = costo || 0;
                
                // Actualizar en Supabase
                if (supabaseClient) {
                    const { error } = await supabaseClient
                        .from('condiciones_inseguras')
                        .update({ 
                            Estado: 'reparado',
                            FechaReparacion: condicion.FechaReparacion,
                            TipoReparacion: tipoReparacion,
                            CostoEstimado: costo || 0
                        })
                        .eq('OT', ot);
                    
                    if (error) throw error;
                }
                
                // Actualizar localmente
                guardarDatosLocales();
                
                // Recargar historial
                cargarHistorial();
                actualizarEstadisticas();
                
                alert('✅ Reporte marcado como "Reparado"');
                
            } catch (error) {
                console.error('Error actualizando estado:', error);
                alert('❌ Error al actualizar estado');
            }
        }

        function editarReporte(ot) {
            const condicion = unsafeConditions.find(c => c.OT === ot);
            if (!condicion) return;
            
            // Llenar formulario con datos existentes
            document.getElementById('ot-code').value = condicion.OT;
            document.getElementById('reporter-name').value = condicion.ReportadoPor;
            document.getElementById('description').value = condicion.Descripcion;
            document.getElementById('sector').value = condicion.Sector;
            document.getElementById('ubicacion').value = condicion.Ubicacion;
            document.getElementById('category').value = condicion.Tipo;
            document.getElementById('risk-level').value = condicion.NivelRiesgo;
            document.getElementById('fecha-estimada').value = condicion.FechaEstimadaReparacion ? 
                condicion.FechaEstimadaReparacion.split('T')[0] : '';
            document.getElementById('observaciones').value = condicion.Observaciones || '';
            
            // Si tiene foto, mostrar preview
            if (condicion.Foto) {
                const previewDiv = document.getElementById('preview-foto-simple');
                if (previewDiv) {
                    previewDiv.innerHTML = `
                        <div style="margin-top: 15px; padding: 15px; background: rgba(220, 44, 60, 0.05); border-radius: 10px; text-align: center;">
                            <h4 style="color: #dc2c3c; margin-bottom: 10px;">
                                <i class="fas fa-camera"></i> Foto existente
                            </h4>
                            <img src="${condicion.Foto}" 
                                 style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 3px solid white;"
                                 alt="Foto existente">
                            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                                <i class="fas fa-info-circle"></i> Esta foto se mantendrá si no subes una nueva
                            </p>
                        </div>
                    `;
                }
                fotoSeleccionada = null; // No tenemos el archivo original, solo la URL
            }
            
            // Ir a la página de registro
            cambiarPagina('registro');
            
            // Desplazar al inicio del formulario
            window.scrollTo(0, 0);
        }

        function diagnosticarProblemas() {
            const hoy = new Date();
            
            // Reportes pendientes vencidos
            const pendientesVencidos = unsafeConditions.filter(c => {
                if (c.Estado !== 'pendiente') return false;
                if (!c.FechaEstimadaReparacion) return false;
                
                const fechaEst = new Date(c.FechaEstimadaReparacion);
                return fechaEst < hoy;
            });
            
            // Reportes con fechas estimadas cercanas (2 días)
            const proximosVencer = unsafeConditions.filter(c => {
                if (c.Estado !== 'pendiente') return false;
                if (!c.FechaEstimadaReparacion) return false;
                
                const fechaEst = new Date(c.FechaEstimadaReparacion);
                const diffDias = Math.ceil((fechaEst - hoy) / (1000 * 60 * 60 * 24));
                return diffDias <= 2 && diffDias >= 0;
            });
            
            // Reportes sin fecha estimada
            const sinFecha = unsafeConditions.filter(c => {
                return !c.FechaEstimadaReparacion && c.Estado === 'pendiente';
            });
            
            // Reportes críticos no atendidos
            const criticosNoAtendidos = unsafeConditions.filter(c => {
                return c.NivelRiesgo === 'Crítico' && c.Estado === 'pendiente';
            });
            
            // Crear mensaje de diagnóstico
            let mensaje = `🔍 DIAGNÓSTICO DEL SISTEMA 🔍\n\n`;
            
            if (pendientesVencidos.length > 0) {
                mensaje += `❌ REPORTES VENCIDOS: ${pendientesVencidos.length}\n`;
                pendientesVencidos.slice(0, 3).forEach(c => {
                    mensaje += `   • OT ${c.OT}: ${c.Descripcion.substring(0, 50)}...\n`;
                });
                mensaje += '\n';
            }
            
            if (criticosNoAtendidos.length > 0) {
                mensaje += `⚠️ RIESGOS CRÍTICOS PENDIENTES: ${criticosNoAtendidos.length}\n`;
                criticosNoAtendidos.forEach(c => {
                    mensaje += `   • OT ${c.OT}: ${c.Descripcion.substring(0, 50)}...\n`;
                });
                mensaje += '\n';
            }
            
            if (proximosVencer.length > 0) {
                mensaje += `⏰ POR VENCER (≤2 días): ${proximosVencer.length}\n`;
                mensaje += '\n';
            }
            
            if (sinFecha.length > 0) {
                mensaje += `📅 SIN FECHA ESTIMADA: ${sinFecha.length}\n`;
                mensaje += '\n';
            }
            
            if (pendientesVencidos.length === 0 && criticosNoAtendidos.length === 0) {
                mensaje += '✅ No hay problemas críticos detectados. El sistema funciona correctamente.\n\n';
            }
            
            mensaje += `📊 RESUMEN:\n`;
            mensaje += `• Total reportes: ${unsafeConditions.length}\n`;
            mensaje += `• Pendientes: ${unsafeConditions.filter(c => c.Estado === 'pendiente').length}\n`;
            mensaje += `• Cumplimiento fechas: ${calcularCumplimientoFechas()}%\n`;
            mensaje += `• Tiempo promedio reparación: ${calcularTiempoPromedioReparacion()}\n`;
            
            alert(mensaje);
        }

        function exportarHistorial() {
            const datos = unsafeConditions.map(c => ({
                OT: c.OT,
                Descripcion: c.Descripcion,
                Sector: c.Sector,
                Ubicacion: c.Ubicacion,
                Tipo: c.Tipo,
                NivelRiesgo: c.NivelRiesgo,
                ReportadoPor: c.ReportadoPor,
                FechaReporte: formatDate(c.Fecha),
                FechaEstimadaReparacion: c.FechaEstimadaReparacion ? formatDate(c.FechaEstimadaReparacion) : '',
                FechaReparacion: c.FechaReparacion ? formatDate(c.FechaReparacion) : '',
                Estado: c.Estado,
                TipoReparacion: c.TipoReparacion || '',
                CostoEstimado: c.CostoEstimado || '',
                Observaciones: c.Observaciones || '',
                Foto: c.Foto ? 'Sí' : 'No'
            }));
            
            // Convertir a CSV
            const cabeceras = Object.keys(datos[0] || {});
            const filas = datos.map(fila => 
                cabeceras.map(header => 
                    `"${(fila[header] || '').toString().replace(/"/g, '""')}"`
                ).join(',')
            );
            
            const csvContent = [cabeceras.join(','), ...filas].join('\n');
            
            // Descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `condiciones_inseguras_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ Historial exportado: ${datos.length} registros`);
        }

        // ==============================================
        // FUNCIONES PARA ANÁLISIS
        // ==============================================
        function cargarAnalisis() {
            actualizarGraficoPrincipal();
            actualizarGraficoSector();
            actualizarGraficoTiempo();
            actualizarKPIs();
        }

        function actualizarGraficoPrincipal() {
            const tipo = document.getElementById('analysis-type').value;
            const ctx = document.getElementById('data-chart');
            
            if (dataChart) {
                dataChart.destroy();
            }
            
            let titulo = '';
            let labels = [];
            let datos = [];
            let colores = [];
            
            switch(tipo) {
                case 'risk':
                    titulo = 'Reportes por Nivel de Riesgo';
                    labels = ['Crítico', 'Alto', 'Medio', 'Bajo'];
                    datos = labels.map(nivel => 
                        unsafeConditions.filter(c => c.NivelRiesgo === nivel).length
                    );
                    colores = labels.map(nivel => CHART_COLORS.riesgo[nivel]);
                    break;
                    
                case 'sector':
                    titulo = 'Reportes por Sector';
                    labels = ['Aceites', 'Jabonería-Confitería'];
                    datos = labels.map(sector => 
                        unsafeConditions.filter(c => c.Sector === sector).length
                    );
                    colores = CHART_COLORS.sector;
                    break;
                    
                case 'category':
                    titulo = 'Reportes por Tipo';
                    const tiposUnicos = [...new Set(unsafeConditions.map(c => c.Tipo))];
                    labels = tiposUnicos;
                    datos = tiposUnicos.map(tipoCat => 
                        unsafeConditions.filter(c => c.Tipo === tipoCat).length
                    );
                    colores = tiposUnicos.map(tipoCat => 
                        CHART_COLORS.tipo[tipoCat] || '#3498db'
                    );
                    break;
                    
                case 'status':
                    titulo = 'Reportes por Estado';
                    labels = ['Pendiente', 'En Proceso', 'Reparado'];
                    datos = [
                        unsafeConditions.filter(c => c.Estado === 'pendiente').length,
                        unsafeConditions.filter(c => c.Estado === 'en proceso').length,
                        unsafeConditions.filter(c => c.Estado === 'reparado').length
                    ];
                    colores = [CHART_COLORS.estado['pendiente'], CHART_COLORS.estado['en proceso'], CHART_COLORS.estado['reparado']];
                    break;
                    
                case 'time':
                    titulo = 'Tiempos de Reparación';
                    // Crear rangos de tiempo
                    labels = ['< 24h', '1-3 días', '3-7 días', '> 7 días'];
                    const reparados = unsafeConditions.filter(c => c.Estado === 'reparado' && c.Fecha && c.FechaReparacion);
                    
                    datos = [
                        reparados.filter(c => {
                            const tiempo = calcularTiempoReparacion(c.Fecha, c.FechaReparacion);
                            return tiempo.horas <= 24;
                        }).length,
                        reparados.filter(c => {
                            const tiempo = calcularTiempoReparacion(c.Fecha, c.FechaReparacion);
                            return tiempo.horas > 24 && tiempo.horas <= 72;
                        }).length,
                        reparados.filter(c => {
                            const tiempo = calcularTiempoReparacion(c.Fecha, c.FechaReparacion);
                            return tiempo.horas > 72 && tiempo.horas <= 168;
                        }).length,
                        reparados.filter(c => {
                            const tiempo = calcularTiempoReparacion(c.Fecha, c.FechaReparacion);
                            return tiempo.horas > 168;
                        }).length
                    ];
                    colores = CHART_COLORS.tiempo;
                    break;
            }
            
            dataChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: titulo,
                        data: datos,
                        backgroundColor: colores,
                        borderColor: colores.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: titulo,
                            color: '#2c3e50',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleColor: '#fff',
                            bodyColor: '#fff'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#7f8c8d',
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#2c3e50'
                            }
                        }
                    }
                }
            });
        }

        function actualizarGraficoSector() {
            const ctx = document.getElementById('sector-chart');
            if (!ctx) return;
            
            if (sectorChart) {
                sectorChart.destroy();
            }
            
            const sectores = ['Aceites', 'Jabonería-Confitería'];
            const datos = sectores.map(sector => 
                unsafeConditions.filter(c => c.Sector === sector).length
            );
            
            sectorChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sectores,
                    datasets: [{
                        data: datos,
                        backgroundColor: CHART_COLORS.sector,
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#2c3e50',
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function actualizarGraficoTiempo() {
            const ctx = document.getElementById('time-chart');
            if (!ctx) return;
            
            if (timeChart) {
                timeChart.destroy();
            }
            
            // Crear rangos de tiempo para reparaciones
            const reparados = unsafeConditions.filter(c => c.Estado === 'reparado' && c.Fecha && c.FechaReparacion);
            const rangos = ['< 24h', '1-3 días', '3-7 días', '> 7 días'];
            
            const datos = [
                reparados.filter(c => {
                    const tiempo = calcularTiempoReparacion(c.Fecha, c.FechaReparacion);
                    return tiempo.horas <= 24;
                }).length,
                reparados.filter(c => {
                    const tiempo = calcularTiempoReparacion(c.Fecha, c.FechaReparacion);
                    return tiempo.horas > 24 && tiempo.horas <= 72;
                }).length,
                reparados.filter(c => {
                    const tiempo = calcularTiempoReparacion(c.Fecha, c.FechaReparacion);
                    return tiempo.horas > 72 && tiempo.horas <= 168;
                }).length,
                reparados.filter(c => {
                    const tiempo = calcularTiempoReparacion(c.Fecha, c.FechaReparacion);
                    return tiempo.horas > 168;
                }).length
            ];
            
            timeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: rangos,
                    datasets: [{
                        data: datos,
                        backgroundColor: CHART_COLORS.tiempo,
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#2c3e50',
                                padding: 20,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} reporte${value !== 1 ? 's' : ''} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function actualizarKPIs() {
            document.getElementById('kpi-tiempo-promedio').textContent = calcularTiempoPromedioReparacion();
            document.getElementById('kpi-cumplimiento').textContent = `${calcularCumplimientoFechas()}%`;
            
            // Reportes del mes actual
            const hoy = new Date();
            const reportesMes = unsafeConditions.filter(c => {
                try {
                    const fechaReporte = new Date(c.Fecha);
                    return fechaReporte.getFullYear() === hoy.getFullYear() && 
                           fechaReporte.getMonth() === hoy.getMonth();
                } catch {
                    return false;
                }
            }).length;
            document.getElementById('kpi-reportes-mes').textContent = reportesMes;
        }

        function actualizarAnalisis() {
            actualizarGraficoPrincipal();
            actualizarGraficoSector();
            actualizarGraficoTiempo();
            actualizarKPIs();
        }

        function generarReportePDF() {
            alert('🚀 Función de generación de PDF en desarrollo\n\nPor ahora, usa la función de Exportar en Historial para obtener los datos en CSV.');
            // En una implementación completa, aquí se generaría un PDF con jsPDF
        }

        // ==============================================
        // FUNCIONES PARA CONFIGURACIÓN
        // ==============================================
        function cargarConfiguracion() {
            // Mostrar estado actual
            document.getElementById('current-url').value = CONFIG.supabaseUrl || 'No configurada';
            document.getElementById('current-key').value = CONFIG.supabaseKey ? 
                CONFIG.supabaseKey.substring(0, 20) + '...' : 'No configurada';
            
            // Actualizar estado de conexión
            const statusDiv = document.getElementById('connection-status');
            if (supabaseClient) {
                statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #27ae60;"></i> Conectado a Supabase';
                statusDiv.style.color = '#27ae60';
            } else {
                statusDiv.innerHTML = '<i class="fas fa-unlink" style="color: #e74c3c;"></i> Sin conexión a Supabase';
                statusDiv.style.color = '#e74c3c';
            }
            
            // Mostrar información del sistema
            document.getElementById('total-db-count').textContent = unsafeConditions.length;
            document.getElementById('reports-with-photos').textContent = unsafeConditions.filter(c => c.Foto).length;
            document.getElementById('avg-repair-time').textContent = calcularTiempoPromedioReparacion();
            document.getElementById('cumplimiento-fechas').textContent = `${calcularCumplimientoFechas()}%`;
            document.getElementById('last-sync').textContent = CONFIG.lastSync;
            document.getElementById('current-mode').textContent = CONFIG.offlineMode ? 'Modo Offline' : 'Modo Online';
        }

        function mostrarConfigPanel() {
            const panel = document.getElementById('supabase-config-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                
                // Pre-llenar con valores actuales si existen
                document.getElementById('supabase-url').value = CONFIG.supabaseUrl || '';
                document.getElementById('supabase-key').value = CONFIG.supabaseKey || '';
            } else {
                panel.style.display = 'none';
            }
        }

        async function guardarConfigSupabase() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                alert('❌ Por favor completa ambos campos');
                return;
            }
            
            showLoading(true, 'Probando conexión con Supabase...');
            
            try {
                // Crear cliente temporal para probar
                const tempClient = supabase.createClient(url, key);
                
                // Intentar una consulta simple
                const { data, error } = await tempClient
                    .from('condiciones_inseguras')
                    .select('OT')
                    .limit(1);
                
                if (error) throw error;
                
                // Guardar credenciales
                CONFIG.supabaseUrl = url;
                CONFIG.supabaseKey = key;
                localStorage.setItem('supabase_url', url);
                localStorage.setItem('supabase_key', key);
                
                // Recrear el cliente principal
                supabaseClient = supabase.createClient(url, key);
                
                // Ocultar panel de configuración
                document.getElementById('supabase-config-panel').style.display = 'none';
                
                // Actualizar UI
                updateStatusIndicator('connected', 'Conectado a Supabase');
                cargarConfiguracion();
                
                // Sincronizar datos
                await sincronizarDatos();
                
                alert('✅ Conexión establecida exitosamente!');
                
            } catch (error) {
                console.error('Error conectando a Supabase:', error);
                alert(`❌ Error conectando a Supabase:\n${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        async function probarConexion() {
            if (!supabaseClient) {
                alert('❌ No hay cliente Supabase configurado');
                return;
            }
            
            showLoading(true, 'Probando conexión...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('count', { count: 'exact', head: true });
                
                if (error) throw error;
                
                alert(`✅ Conexión exitosa!\n\nPuedes acceder a la base de datos correctamente.`);
                
            } catch (error) {
                console.error('Error probando conexión:', error);
                alert(`❌ Error de conexión:\n${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function abrirManualSupabase() {
            alert('📚 MANUAL DE CONFIGURACIÓN SUPABASE\n\n1. Ve a https://supabase.com y crea una cuenta\n2. Crea un nuevo proyecto\n3. En el dashboard, ve a Settings > API\n4. Copia la URL y la API Key (anon public)\n5. Pega esos valores en este sistema\n6. Crea la tabla "condiciones_inseguras" con las columnas necesarias\n\nEl sistema creará automáticamente el bucket para fotos.');
        }

        function limpiarDatos() {
            if (!confirm('⚠️ ¿Estás seguro de eliminar todos los datos locales?\n\nEsto no afectará los datos en Supabase, solo los almacenados en este navegador.')) {
                return;
            }
            
            localStorage.removeItem('unsafe_conditions');
            localStorage.removeItem('supabase_config');
            unsafeConditions = [];
            
            alert('✅ Datos locales eliminados. Recarga la página.');
            location.reload();
        }

        function resetConfig() {
            if (!confirm('⚠️ ¿Restablecer toda la configuración?\n\nSe eliminarán las credenciales de Supabase y volverás al modo offline.')) {
                return;
            }
            
            localStorage.clear();
            alert('✅ Configuración reiniciada. Recarga la página.');
            location.reload();
        }

        function backupLocal() {
            const datos = {
                condiciones: unsafeConditions,
                config: CONFIG,
                timestamp: new Date().toISOString(),
                version: 'Danec v5.0'
            };
            
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_condiciones_${new Date().toISOString().slice(0,10)}.json`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ Backup creado: ${unsafeConditions.length} registros guardados`);
        }

        // ==============================================
        // FUNCIONES DE SINCRONIZACIÓN
        // ==============================================
        async function sincronizarDatos() {
    if (!supabaseClient || CONFIG.offlineMode) {
        console.log('⏸️  Sincronización omitida - Modo offline');
        return;
    }
    
    showLoading(true, 'Sincronizando con Supabase...');
    
    try {
        // 1. Descargar datos de Supabase
        console.log('⬇️  Descargando datos de Supabase...');
        const { data: remoteData, error: fetchError } = await supabaseClient
            .from('condiciones_inseguras')
            .select('*')
            .order('Fecha', { ascending: false });
        
        if (fetchError) {
            console.error('❌ Error descargando datos:', fetchError);
            
            // Si la tabla no existe, crear estructura básica
            if (fetchError.message.includes('does not exist')) {
                alert('⚠️ La tabla no existe. Creando estructura básica...');
                
                // Crear tabla vía API (esto requiere permisos adicionales)
                // Por ahora, solo mostrar instrucciones
                mostrarInstruccionesTabla();
                throw fetchError;
            } else {
                throw fetchError;
            }
        }
        
        console.log(`✅ Datos descargados: ${remoteData?.length || 0} registros`);
        
        // 2. Procesar datos locales
        const localData = JSON.parse(localStorage.getItem('unsafe_conditions') || '[]');
        
        // 3. Combinar datos (los remotos tienen prioridad)
        let combinedData = [...(remoteData || [])];
        
        // 4. Subir datos locales que no están en remoto
        if (localData.length > 0) {
            console.log('🔼 Verificando datos locales para subir...');
            
            const localToUpload = localData.filter(localItem => {
                // Buscar si ya existe en remoto
                const existsInRemote = remoteData?.some(remoteItem => 
                    remoteItem.OT === localItem.OT
                );
                return !existsInRemote;
            });
            
            if (localToUpload.length > 0) {
                console.log(`🔼 Subiendo ${localToUpload.length} registros locales...`);
                
                for (const item of localToUpload) {
                    try {
                        const { error: uploadError } = await supabaseClient
                            .from('condiciones_inseguras')
                            .upsert([item], { 
                                onConflict: 'OT',
                                ignoreDuplicates: false 
                            });
                        
                        if (uploadError) {
                            console.error(`❌ Error subiendo OT ${item.OT}:`, uploadError);
                        } else {
                            console.log(`✅ Subido OT ${item.OT}`);
                        }
                    } catch (uploadError) {
                        console.error(`❌ Error en upload de OT ${item.OT}:`, uploadError);
                    }
                }
                
                // Volver a descargar después de subir
                const { data: updatedData, error: updatedError } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('*')
                    .order('Fecha', { ascending: false });
                
                if (!updatedError) {
                    combinedData = updatedData;
                }
            }
        }
        
        // 5. Actualizar datos en memoria y localStorage
        unsafeConditions = combinedData;
        guardarDatosLocales();
        
        // 6. Actualizar timestamp
        CONFIG.lastSync = new Date().toLocaleString('es-ES');
        localStorage.setItem('last_sync', CONFIG.lastSync);
        
        console.log(`✅ Sincronización completada: ${combinedData.length} registros`);
        
        // 7. Actualizar UI
        actualizarEstadisticas();
        
        if (document.getElementById('dashboard-page').classList.contains('active')) {
            cargarDashboard();
        }
        
        // Mostrar notificación
        mostrarNotificacion('✅ Sincronización completada', 'success');
        
    } catch (error) {
        console.error('❌ Error en sincronización:', error);
        
        // Mantener datos locales
        cargarDatosLocales();
        CONFIG.offlineMode = true;
        updateStatusIndicator('error', 'Error de sincronización');
        
        mostrarNotificacion('❌ Error sincronizando con Supabase', 'error');
        
    } finally {
        showLoading(false);
    }
}

        function guardarDatosLocales() {
            try {
                localStorage.setItem('unsafe_conditions', JSON.stringify(unsafeConditions));
                localStorage.setItem('last_updated', new Date().toISOString());
            } catch (error) {
                console.error('Error guardando datos locales:', error);
            }
        }

        function cargarDatosLocales() {
            try {
                const datosGuardados = localStorage.getItem('unsafe_conditions');
                if (datosGuardados) {
                    unsafeConditions = JSON.parse(datosGuardados);
                    console.log(`Datos locales cargados: ${unsafeConditions.length} registros`);
                } else {
                    unsafeConditions = [];
                    console.log('No hay datos locales guardados');
                }
            } catch (error) {
                console.error('Error cargando datos locales:', error);
                unsafeConditions = [];
            }
        }

        function guardarLocalmente(condicion) {
            unsafeConditions.push(condicion);
            guardarDatosLocales();
            console.log('Reporte guardado localmente:', condicion.OT);
        }

        function forzarActualizacion() {
            showLoading(true, 'Actualizando datos...');
            
            setTimeout(() => {
                if (supabaseClient) {
                    sincronizarDatos();
                } else {
                    // Recargar datos locales
                    actualizarEstadisticas();
                    
                    if (document.getElementById('dashboard-page').classList.contains('active')) {
                        cargarActividadesRecientes();
                        actualizarGraficoEvolucion();
                    } else if (document.getElementById('historial-page').classList.contains('active')) {
                        cargarHistorial();
                    } else if (document.getElementById('analisis-page').classList.contains('active')) {
                        cargarAnalisis();
                    }
                    
                    showLoading(false);
                    alert('✅ Datos actualizados desde almacenamiento local');
                }
            }, 500);
        }

        // ==============================================
        // INICIALIZACIÓN
        // ==============================================
        async function inicializarApp() {
    console.log('🚀 Inicializando Sistema de Condiciones Inseguras...');
    showLoading(true, 'Iniciando sistema...');
    
    try {
        // 1. Verificar si hay credenciales guardadas
        const savedUrl = localStorage.getItem('supabase_url');
        const savedKey = localStorage.getItem('supabase_key');
        
        if (savedUrl && savedKey) {
            CONFIG.supabaseUrl = savedUrl;
            CONFIG.supabaseKey = savedKey;
            console.log('📦 Credenciales encontradas en localStorage');
        } else {
            // Usar credenciales por defecto
            CONFIG.supabaseUrl = MIS_CREDENCIALES.URL;
            CONFIG.supabaseKey = MIS_CREDENCIALES.API_KEY;
            console.log('⚙️ Usando credenciales por defecto');
        }
        
        // 2. Intentar conectar con Supabase
        if (CONFIG.supabaseUrl && CONFIG.supabaseKey) {
            console.log('🔗 Intentando conectar con Supabase...');
            console.log('URL:', CONFIG.supabaseUrl);
            console.log('API Key:', CONFIG.supabaseKey.substring(0, 20) + '...');
            
            try {
                // Crear cliente Supabase
                supabaseClient = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey, {
                    auth: {
                        persistSession: false
                    }
                });
                
                // Probar conexión con un ping simple
                const { data, error } = await supabaseClient
                    .from('condiciones_inseguras')
                    .select('count', { count: 'exact', head: true })
                    .limit(1);
                
                if (error) {
                    console.error('❌ Error probando conexión:', error);
                    
                    // Verificar si es error de tabla no existente
                    if (error.message.includes('relation "condiciones_inseguras" does not exist')) {
                        alert('⚠️ La tabla "condiciones_inseguras" no existe en Supabase.\n\nPor favor créala ejecutando el SQL proporcionado en la documentación.');
                        updateStatusIndicator('error', 'Falta tabla en Supabase');
                    } else {
                        throw error;
                    }
                } else {
                    console.log('✅ Conexión exitosa con Supabase');
                    updateStatusIndicator('connected', 'Conectado a Supabase');
                    CONFIG.offlineMode = false;
                    
                    // Guardar credenciales en localStorage
                    localStorage.setItem('supabase_url', CONFIG.supabaseUrl);
                    localStorage.setItem('supabase_key', CONFIG.supabaseKey);
                    
                    // Sincronizar datos
                    await sincronizarDatos();
                }
                
            } catch (connectionError) {
                console.error('❌ Error de conexión:', connectionError);
                updateStatusIndicator('error', 'Error de conexión');
                CONFIG.offlineMode = true;
                
                // Mostrar mensaje específico
                let errorMsg = 'Error conectando a Supabase. ';
                
                if (connectionError.message.includes('Failed to fetch')) {
                    errorMsg += 'Posible problema de CORS o URL incorrecta.';
                } else if (connectionError.message.includes('Invalid API key')) {
                    errorMsg += 'API Key inválida. Verifica en Settings > API de Supabase.';
                } else {
                    errorMsg += connectionError.message;
                }
                
                console.error('Detalles:', errorMsg);
            }
        } else {
            console.log('📴 Modo offline - Sin credenciales');
            updateStatusIndicator('disconnected', 'Modo Offline');
            CONFIG.offlineMode = true;
        }
        
        // 3. Cargar datos locales siempre
        cargarDatosLocales();
        console.log(`📊 Datos locales cargados: ${unsafeConditions.length} registros`);
        
        // 4. Configurar interfaz
        configurarInterfaz();
        
        // 5. Mostrar dashboard
        cambiarPagina('dashboard');
        
        CONFIG.initialized = true;
        console.log('✅ Sistema inicializado correctamente');
        
    } catch (error) {
        console.error('❌ Error crítico en inicialización:', error);
        updateStatusIndicator('error', 'Error de inicialización');
        alert('Error inicializando la aplicación. Revisa la consola (F12) para más detalles.');
    } finally {
        showLoading(false);
    }
}
        function configurarInterfaz() {
    // Configurar navegación
    document.querySelectorAll('.nav-menu a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pagina = link.getAttribute('data-page');
            cambiarPagina(pagina);
        });
    });
    
    // Configurar formulario
    const reportForm = document.getElementById('report-form');
    if (reportForm) {
        reportForm.addEventListener('submit', manejarRegistro);
    }
    
    // Configurar filtros de historial
    document.getElementById('filter-all')?.addEventListener('click', () => {
        currentFilter = 'all';
        cargarHistorial();
    });
    document.getElementById('filter-pending')?.addEventListener('click', () => {
        currentFilter = 'pending';
        cargarHistorial();
    });
    document.getElementById('filter-process')?.addEventListener('click', () => {
        currentFilter = 'process';
        cargarHistorial();
    });
    document.getElementById('filter-repaired')?.addEventListener('click', () => {
        currentFilter = 'repaired';
        cargarHistorial();
    });
    
    document.getElementById('filter-sector')?.addEventListener('change', cargarHistorial);
    document.getElementById('search-input')?.addEventListener('input', cargarHistorial);
    
    // Configurar fecha estimada (mínimo hoy)
    const fechaInput = document.getElementById('fecha-estimada');
    if (fechaInput) {
        const hoy = new Date().toISOString().split('T')[0];
        fechaInput.min = hoy;
        if (!fechaInput.value) {
            fechaInput.value = hoy; // Por defecto hoy
        }
    }
}

// ==============================================
// FUNCIONES AUXILIARES NUEVAS
// ==============================================
function mostrarInstruccionesTabla() {
    alert(`📋 INSTRUCCIONES PARA CREAR TABLA EN SUPABASE:

1. Ve al dashboard de Supabase: ${CONFIG.supabaseUrl}
2. En el menú izquierdo, haz clic en "SQL Editor"
3. Crea un nuevo query
4. Copia y pega este SQL:

--------------------------------------------------
CREATE TABLE condiciones_inseguras (
    OT VARCHAR(5) PRIMARY KEY,
    ReportadoPor TEXT NOT NULL,
    Descripcion TEXT NOT NULL,
    Sector TEXT NOT NULL,
    Ubicacion TEXT NOT NULL,
    Tipo TEXT NOT NULL,
    NivelRiesgo TEXT NOT NULL,
    FechaEstimadaReparacion DATE,
    Observaciones TEXT,
    Foto TEXT,
    Fecha TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    Estado TEXT DEFAULT 'pendiente',
    FechaReparacion TIMESTAMP WITH TIME ZONE,
    TipoReparacion TEXT,
    CostoEstimado DECIMAL(10,2)
);
--------------------------------------------------

5. Ejecuta el query
6. Luego ve a "Storage" y crea un bucket llamado "condiciones_imagenes"
7. Configura el bucket para acceso público

Una vez hecho esto, recarga esta página.`);
}

function mostrarNotificacion(mensaje, tipo = 'info') {
    // Crear elemento de notificación
    const notificacion = document.createElement('div');
    notificacion.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    `;
    
    if (tipo === 'success') {
        notificacion.style.backgroundColor = '#27ae60';
    } else if (tipo === 'error') {
        notificacion.style.backgroundColor = '#e74c3c';
    } else {
        notificacion.style.backgroundColor = '#3498db';
    }
    
    notificacion.innerHTML = `
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span>${mensaje}</span>
    `;
    
    document.body.appendChild(notificacion);
    
    // Auto-eliminar después de 5 segundos
    setTimeout(() => {
        notificacion.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
            }
        }, 300);
    }, 5000);
    
    // Agregar estilos de animación si no existen
    if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
}

// ==============================================
// FUNCIÓN DE DIAGNÓSTICO DE CONEXIÓN
// ==============================================
async function diagnosticarConexion() {
    console.log('🔍 Iniciando diagnóstico de conexión...');
    
    const diagnosticos = [];
    
    // 1. Verificar credenciales
    if (!CONFIG.supabaseUrl || !CONFIG.supabaseKey) {
        diagnosticos.push('❌ No hay credenciales configuradas');
    } else {
        diagnosticos.push(`✅ Credenciales configuradas:
           URL: ${CONFIG.supabaseUrl}
           API Key: ${CONFIG.supabaseKey.substring(0, 20)}...`);
    }
    
    // 2. Verificar conexión a Internet
    diagnosticos.push(navigator.onLine ? '✅ Conectado a Internet' : '❌ Sin conexión a Internet');
    
    // 3. Verificar cliente Supabase
    if (!supabaseClient) {
        diagnosticos.push('❌ Cliente Supabase no creado');
    } else {
        diagnosticos.push('✅ Cliente Supabase creado');
    }
    
    // 4. Intentar conexión directa
    try {
        const testUrl = `${CONFIG.supabaseUrl}/rest/v1/`;
        const response = await fetch(testUrl, {
            headers: {
                'apikey': CONFIG.supabaseKey,
                'Authorization': `Bearer ${CONFIG.supabaseKey}`
            }
        });
        
        if (response.ok) {
            diagnosticos.push('✅ Supabase responde correctamente');
        } else {
            diagnosticos.push(`❌ Supabase responde con error: ${response.status}`);
        }
    } catch (error) {
        diagnosticos.push(`❌ Error conectando a Supabase: ${error.message}`);
    }
    
    // Mostrar diagnóstico
    const mensaje = diagnosticos.join('\n\n');
    alert(`🔍 DIAGNÓSTICO DE CONEXIÓN:\n\n${mensaje}`);
    
    console.log('Diagnóstico completo:', diagnosticos);
}

// ==============================================
// ACTUALIZAR BOTÓN DE CONFIGURACIÓN
// ==============================================
function agregarBotonDiagnostico() {
    const configPage = document.getElementById('config-page');
    if (!configPage) return;
    
    // Buscar la sección de herramientas
    const toolsSection = configPage.querySelector('.card:last-child');
    if (toolsSection) {
        // Verificar si ya existe el botón
        if (!document.querySelector('#btn-diagnostico')) {
            const nuevoBoton = document.createElement('button');
            nuevoBoton.id = 'btn-diagnostico';
            nuevoBoton.className = 'btn btn-warning';
            nuevoBoton.innerHTML = '<i class="fas fa-stethoscope"></i> Diagnosticar Conexión';
            nuevoBoton.onclick = diagnosticarConexion;
            
            toolsSection.querySelector('div').appendChild(nuevoBoton);
        }
    }
}
        

        // ==============================================
        // EVENTOS GLOBALES
        // ==============================================
       // ==============================================
// INICIALIZAR AL CARGAR LA PÁGINA
// ==============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 Página cargada, iniciando aplicación...');
    
    // Inicializar aplicación
    inicializarApp();
    
    // Agregar botón de diagnóstico después de cargar
    setTimeout(agregarBotonDiagnostico, 1000);
    
    // Verificar CORS - Si hay problemas, mostrar opción alternativa
    setTimeout(() => {
        if (!supabaseClient && CONFIG.supabaseUrl) {
            console.log('⚠️ Verificando problemas de CORS...');
            
            // Si después de 3 segundos no hay conexión, mostrar ayuda
            if (!CONFIG.initialized) {
                mostrarNotificacion('⚠️ Problemas de conexión detectados. Usa "Diagnosticar Conexión" en Configuración.', 'error');
            }
        }
    }, 3000);
});

// Detectar cambios de conexión
window.addEventListener('online', () => {
    console.log('🌐 Conexión a Internet restablecida');
    if (supabaseClient) {
        updateStatusIndicator('connected', 'Reconectando...');
        sincronizarDatos();
    }
});

window.addEventListener('offline', () => {
    console.log('📴 Sin conexión a Internet');
    updateStatusIndicator('disconnected', 'Sin conexión - Modo Offline');
    CONFIG.offlineMode = true;
});

        // Prevenir salida sin guardar
        window.addEventListener('beforeunload', (e) => {
            if (unsafeConditions.some(c => c.Estado === 'pendiente')) {
                e.preventDefault();
                e.returnValue = 'Tienes reportes pendientes. ¿Seguro que quieres salir?';
            }
        });

        // ==============================================
        // HACK PARA MÓVILES: MEJORAR EXPERIENCIA TÁCTIL
        // ==============================================
        document.addEventListener('touchstart', function() {}, {passive: true});

        // Prevenir zoom en inputs en iOS
        document.addEventListener('touchmove', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                e.preventDefault();
            }
        }, { passive: false });

        // Mejorar rendimiento en scroll
        document.addEventListener('touchmove', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            e.stopPropagation();
        }, { passive: true });

        console.log('📱 Sistema optimizado para móviles');
    </script>
</body>
</html>
